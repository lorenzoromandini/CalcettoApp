---
phase: 06-rating-trends-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - lib/db/player-ratings.ts
  - hooks/use-rating-history.ts
autonomous: true
must_haves:
  truths:
    - "Player ratings can be fetched ordered by match date"
    - "Rating history includes match date and rating display value"
    - "React hook provides loading, error, and data states for rating history"
  artifacts:
    - path: "lib/db/player-ratings.ts"
      provides: "getPlayerRatingHistory function"
      contains: "getPlayerRatingHistory"
    - path: "hooks/use-rating-history.ts"
      provides: "Rating history data fetching hook"
      min_lines: 40
    - path: "package.json"
      provides: "Recharts dependency"
      contains: "recharts"
  key_links:
    - from: "hooks/use-rating-history.ts"
      to: "lib/db/player-ratings.ts"
      via: "import getPlayerRatingHistory"
      pattern: "getPlayerRatingHistory"
---

<objective>
Add rating history data fetching capability with Recharts installation.

Purpose: Enable frontend to fetch player rating history ordered chronologically by match date.
Output: Recharts installed, getPlayerRatingHistory function, useRatingHistory hook.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rating-trends-history/06-RESEARCH.md

@lib/db/player-ratings.ts
@lib/rating-utils.ts
@hooks/use-statistics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts charting library</name>
  <files>package.json</files>
  <action>
Install Recharts for chart visualization:
```bash
npm install recharts
```

Recharts is the standard React charting library (3.6M+ weekly downloads) with declarative API and built-in responsive support.
  </action>
  <verify>`npm list recharts` shows installed version</verify>
  <done>Recharts installed and available in node_modules</done>
</task>

<task type="auto">
  <name>Task 2: Add getPlayerRatingHistory function to player-ratings.ts</name>
  <files>lib/db/player-ratings.ts</files>
  <action>
Add the following function to lib/db/player-ratings.ts after the existing functions:

```typescript
export interface RatingHistoryEntry {
  match_id: string
  match_date: Date
  rating: number
  rating_display: string
  comment?: string
}

export async function getPlayerRatingHistory(
  playerId: string,
  teamId?: string
): Promise<RatingHistoryEntry[]> {
  const ratings = await prisma.playerRating.findMany({
    where: {
      playerId,
      match: {
        status: MatchStatus.COMPLETED,
        ...(teamId ? { teamId } : {}),
      },
    },
    include: {
      match: {
        select: {
          id: true,
          scheduledAt: true,
        },
      },
    },
    orderBy: {
      match: {
        scheduledAt: 'asc',
      },
    },
  })

  return ratings.map(r => ({
    match_id: r.matchId,
    match_date: r.match.scheduledAt,
    rating: r.rating.toNumber(),
    rating_display: decimalToRating(r.rating.toNumber()),
    comment: r.comment ?? undefined,
  }))
}
```

This function:
- Fetches all ratings for a player from COMPLETED matches
- Orders by match scheduledAt (chronological)
- Returns match_id, match_date, rating (decimal), rating_display (string like "6.5"), and optional comment
- Optional teamId filter for team-specific history
  </action>
  <verify>Function compiles without TypeScript errors, imports decimalToRating from rating-utils</verify>
  <done>getPlayerRatingHistory function exported from lib/db/player-ratings.ts</done>
</task>

<task type="auto">
  <name>Task 3: Create useRatingHistory hook</name>
  <files>hooks/use-rating-history.ts</files>
  <action>
Create hooks/use-rating-history.ts with a React hook for fetching rating history:

```typescript
'use client'

import { useState, useEffect } from 'react'
import { getPlayerRatingHistory, type RatingHistoryEntry } from '@/lib/db/player-ratings'

interface UseRatingHistoryResult {
  history: RatingHistoryEntry[]
  isLoading: boolean
  error: string | null
  refetch: () => void
}

export function useRatingHistory(
  playerId: string,
  teamId?: string
): UseRatingHistoryResult {
  const [history, setHistory] = useState<RatingHistoryEntry[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const fetchHistory = async () => {
    setIsLoading(true)
    setError(null)
    
    try {
      const data = await getPlayerRatingHistory(playerId, teamId)
      setHistory(data)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Errore nel caricamento della cronologia voti')
    } finally {
      setIsLoading(false)
    }
  }

  useEffect(() => {
    fetchHistory()
  }, [playerId, teamId])

  return {
    history,
    isLoading,
    error,
    refetch: fetchHistory,
  }
}
```

Follow the same pattern as hooks/use-statistics.ts for consistency.
  </action>
  <verify>Hook compiles and exports useRatingHistory, RatingHistoryEntry type</verify>
  <done>useRatingHistory hook provides history, isLoading, error, refetch</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. Recharts appears in package.json dependencies
3. getPlayerRatingHistory function is exported from lib/db/player-ratings.ts
4. useRatingHistory hook is exported from hooks/use-rating-history.ts
</verification>

<success_criteria>
- Recharts installed and ready for chart components
- Rating history data can be fetched ordered by match date
- React hook provides loading/error states for rating history fetching
</success_criteria>

<output>
After completion, create `.planning/phases/06-rating-trends-history/06-01-SUMMARY.md`
</output>
