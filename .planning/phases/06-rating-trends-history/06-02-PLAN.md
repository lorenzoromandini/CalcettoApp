---
phase: 06-rating-trends-history
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - components/ratings/rating-trend-chart.tsx
  - components/ratings/rating-history-list.tsx
  - app/[locale]/teams/[teamId]/players/[playerId]/player-profile-client.tsx
  - messages/it.json
  - messages/en.json
autonomous: true
must_haves:
  truths:
    - "User can see rating trend chart for players with 3+ ratings"
    - "User can tap chart points to see rating details"
    - "User can see list of all past ratings with dates"
    - "Empty state shown for players with fewer than 3 ratings"
    - "Chart and list appear on player profile page"
  artifacts:
    - path: "components/ratings/rating-trend-chart.tsx"
      provides: "Recharts LineChart for rating trends"
      min_lines: 60
    - path: "components/ratings/rating-history-list.tsx"
      provides: "List view of past ratings"
      min_lines: 40
    - path: "app/[locale]/teams/[teamId]/players/[playerId]/player-profile-client.tsx"
      provides: "Integration of chart and list"
      contains: "RatingTrendChart"
  key_links:
    - from: "RatingTrendChart"
      to: "useRatingHistory"
      via: "hook call"
      pattern: "useRatingHistory"
    - from: "player-profile-client.tsx"
      to: "RatingTrendChart"
      via: "import component"
      pattern: "RatingTrendChart"
---

<objective>
Create rating trend visualization and integrate into player profile.

Purpose: Display rating evolution over time as interactive chart and history list.
Output: RatingTrendChart component, RatingHistoryList component, integrated player profile.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rating-trends-history/06-RESEARCH.md
@.planning/phases/06-rating-trends-history/06-01-PLAN.md

@lib/rating-utils.ts
@hooks/use-rating-history.ts
@app/[locale]/teams/[teamId]/players/[playerId]/player-profile-client.tsx
@components/statistics/player-stats-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RatingTrendChart component with Recharts</name>
  <files>components/ratings/rating-trend-chart.tsx</files>
  <action>
Create components/ratings/rating-trend-chart.tsx with Recharts LineChart:

```typescript
'use client'

import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  ReferenceLine,
} from 'recharts'
import { TrendingUp } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import type { RatingHistoryEntry } from '@/lib/db/player-ratings'

interface RatingTrendChartProps {
  data: RatingHistoryEntry[]
  title?: string
}

function formatMatchLabel(date: Date, index: number): string {
  return new Intl.DateTimeFormat('it-IT', {
    day: 'numeric',
    month: 'short'
  }).format(date)
}

function CustomTooltip({ active, payload }: {
  active?: boolean
  payload?: Array<{ payload: RatingHistoryEntry & { match_label: string } }>
}) {
  if (!active || !payload?.length) return null

  const data = payload[0].payload
  return (
    <div className="bg-card border border-border rounded-lg p-3 shadow-lg">
      <p className="text-sm text-muted-foreground">{data.match_label}</p>
      <p className="text-2xl font-bold text-primary">{data.rating_display}</p>
      {data.comment && (
        <p className="text-sm text-muted-foreground mt-1 max-w-48 truncate">
          {data.comment}
        </p>
      )}
    </div>
  )
}

export function RatingTrendChart({ data, title }: RatingTrendChartProps) {
  if (data.length < 3) {
    return null
  }

  const chartData = data.map((entry, index) => ({
    ...entry,
    match_label: formatMatchLabel(entry.match_date, index),
  }))

  return (
    <Card>
      {title && (
        <CardHeader className="pb-2">
          <CardTitle className="text-base flex items-center gap-2">
            <TrendingUp className="h-4 w-4" />
            {title}
          </CardTitle>
        </CardHeader>
      )}
      <CardContent className="pt-2">
        <ResponsiveContainer
          width="100%"
          height={200}
          initialDimension={{ width: 300, height: 200 }}
        >
          <LineChart
            data={chartData}
            margin={{ top: 10, right: 10, left: -10, bottom: 0 }}
          >
            <CartesianGrid strokeDasharray="3 3" opacity={0.3} />
            <XAxis
              dataKey="match_label"
              tick={{ fontSize: 10 }}
              tickLine={false}
              axisLine={false}
            />
            <YAxis
              domain={[1, 10]}
              ticks={[1, 3, 5, 6, 7, 8, 10]}
              tick={{ fontSize: 10 }}
              tickLine={false}
              axisLine={false}
            />
            <Tooltip content={<CustomTooltip />} />
            <ReferenceLine y={6} stroke="#888" strokeDasharray="5 5" opacity={0.5} />
            <Line
              type="monotone"
              dataKey="rating"
              stroke="hsl(var(--primary))"
              strokeWidth={2}
              dot={{ fill: 'hsl(var(--primary))', strokeWidth: 2, r: 4 }}
              activeDot={{ r: 8, strokeWidth: 0, fill: 'hsl(var(--primary))' }}
            />
          </LineChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  )
}
```

Key features:
- Only renders for 3+ ratings (returns null otherwise)
- ResponsiveContainer with initialDimension to avoid width warning
- Custom tooltip showing date, rating_display, and optional comment
- Y-axis domain [1, 10] with reference line at 6 (passing grade in Italian school system)
- Mobile-optimized touch targets (activeDot r: 8)
  </action>
  <verify>Component compiles, Recharts imports resolve</verify>
  <done>RatingTrendChart component renders LineChart for 3+ ratings</done>
</task>

<task type="auto">
  <name>Task 2: Create RatingHistoryList component</name>
  <files>components/ratings/rating-history-list.tsx</files>
  <action>
Create components/ratings/rating-history-list.tsx for displaying rating history as a list:

```typescript
'use client'

import { Calendar, MessageSquare } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import type { RatingHistoryEntry } from '@/lib/db/player-ratings'

interface RatingHistoryListProps {
  data: RatingHistoryEntry[]
  title?: string
  showChart?: boolean
}

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('it-IT', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  }).format(date)
}

export function RatingHistoryList({ data, title, showChart = false }: RatingHistoryListProps) {
  if (data.length === 0) {
    return null
  }

  const displayData = showChart && data.length >= 3 ? data : data

  return (
    <Card>
      {title && (
        <CardHeader className="pb-2">
          <CardTitle className="text-base">{title}</CardTitle>
        </CardHeader>
      )}
      <CardContent className="pt-2">
        <div className="space-y-3">
          {displayData.slice().reverse().map((entry) => (
            <div
              key={entry.match_id}
              className="flex items-center justify-between py-2 border-b last:border-0"
            >
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                  <Calendar className="h-3 w-3" />
                  {formatDate(entry.match_date)}
                </div>
                {entry.comment && (
                  <div className="flex items-center gap-1 mt-1 text-xs text-muted-foreground truncate">
                    <MessageSquare className="h-3 w-3 flex-shrink-0" />
                    <span className="truncate">{entry.comment}</span>
                  </div>
                )}
              </div>
              <div className="text-xl font-bold text-primary ml-4">
                {entry.rating_display}
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  )
}
```

Key features:
- Shows all ratings in reverse chronological (newest first)
- Displays date, rating_display, and optional comment
- Used as fallback when chart not shown (< 3 ratings)
  </action>
  <verify>Component compiles without TypeScript errors</verify>
  <done>RatingHistoryList component displays ratings with dates and comments</done>
</task>

<task type="auto">
  <name>Task 3: Integrate rating history into player profile</name>
  <files>app/[locale]/teams/[teamId]/players/[playerId]/player-profile-client.tsx</files>
  <action>
Update player-profile-client.tsx to include rating history:

1. Add imports at top:
```typescript
import { TrendingUp, History } from 'lucide-react'
import { useRatingHistory } from '@/hooks/use-rating-history'
import { RatingTrendChart } from '@/components/ratings/rating-trend-chart'
import { RatingHistoryList } from '@/components/ratings/rating-history-list'
```

2. Add hook call after usePlayerStats:
```typescript
const { history, isLoading: historyLoading } = useRatingHistory(playerId, teamId)
```

3. Add translation key for rating history section:
```typescript
const tStats = useTranslations('statistics')
```

4. Add rating history section after PlayerStatsCard (around line 170):
```typescript
      {/* Rating History Section */}
      <h2 className="text-lg font-semibold mt-6 mb-3 flex items-center gap-2">
        <TrendingUp className="h-5 w-5" />
        {t('rating_history')}
      </h2>

      {historyLoading && (
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-center">
              <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
            </div>
          </CardContent>
        </Card>
      )}

      {!historyLoading && history.length >= 3 && (
        <RatingTrendChart data={history} />
      )}

      {!historyLoading && history.length > 0 && history.length < 3 && (
        <RatingHistoryList data={history} title={t('rating_list')} />
      )}

      {!historyLoading && history.length === 0 && (
        <Card className="border-dashed">
          <CardContent className="p-6 text-center">
            <p className="text-muted-foreground">{t('no_ratings_yet')}</p>
          </CardContent>
        </Card>
      )}
```

Logic:
- Show loading skeleton while fetching
- For 3+ ratings: show chart (RatingTrendChart)
- For 1-2 ratings: show list only (RatingHistoryList)
- For 0 ratings: show empty state
  </action>
  <verify>Profile page compiles and shows rating history section</verify>
  <done>Player profile displays rating chart for 3+ ratings, list for 1-2 ratings</done>
</task>

<task type="auto">
  <name>Task 4: Add translation keys for rating history</name>
  <files>messages/it.json, messages/en.json</files>
  <action>
Add translation keys to both messages/it.json and messages/en.json under the statistics namespace:

In messages/it.json, add to statistics section:
```json
"rating_history": "Cronologia voti",
"rating_list": "Voti",
"no_ratings_yet": "Nessun voto ancora registrato"
```

In messages/en.json, add to statistics section:
```json
"rating_history": "Rating history",
"rating_list": "Ratings",
"no_ratings_yet": "No ratings recorded yet"
```

Place these keys alongside existing statistics translations.
  </action>
  <verify>Translations accessible via useTranslations('statistics')</verify>
  <done>Italian and English translations available for rating history UI</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. RatingTrendChart component exists and uses Recharts
3. RatingHistoryList component exists
4. Player profile page imports and uses both components
5. Translation keys present in both locale files
</verification>

<success_criteria>
- User sees rating trend chart for players with 3+ ratings
- User sees rating list for players with 1-2 ratings
- User sees empty state for players with no ratings
- Chart tooltips show rating details on tap/hover
</success_criteria>

<output>
After completion, create `.planning/phases/06-rating-trends-history/06-02-SUMMARY.md`
</output>
