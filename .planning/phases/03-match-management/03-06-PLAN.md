---
phase: 03-match-management
plan: 06
type: execute
wave: 6
depends_on: ["03-01", "03-02", "03-03", "03-04", "03-05"]
files_modified:
  - app/[locale]/teams/[teamId]/matches/page.tsx
  - app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx
  - app/[locale]/dashboard/page.tsx
  - components/navigation/team-nav.tsx
  - messages/it.json
  - messages/en.json
autonomous: false

must_haves:
  truths:
    - "User can complete full match creation flow from team page"
    - "RSVP updates appear in real-time across all connected clients"
    - "Formation builder saves and displays correctly"
    - "All success criteria from Phase 3 are demonstrable"
    - "Mobile experience is smooth with no jank"
  artifacts:
    - path: "app/[locale]/teams/[teamId]/matches/page.tsx"
      provides: "Complete match list with RSVP counts"
    - path: "app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx"
      provides: "Complete match detail with RSVPs and formation link"
    - path: "app/[locale]/dashboard/page.tsx"
      provides: "Dashboard shows upcoming matches with RSVP status"
  key_links:
    - from: "dashboard"
      to: "matches"
      via: "upcoming matches list"
      pattern: "matches with RSVP counts"
---

<objective>
Integrate all Phase 3 features and verify end-to-end match management functionality.

Purpose: Ensure all match management features work together seamlessly before marking Phase 3 complete.

Output: Fully integrated match management with team navigation, dashboard updates, and comprehensive verification.
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-match-management/03-05-SUMMARY.md
@.planning/phases/02-team-management/02-06-SUMMARY.md

## Phase 3 Success Criteria (from ROADMAP.md)
1. User can create match with date, time, location and mode (5vs5 or 8vs8)
2. Players can RSVP to matches (IN/OUT/Maybe) with real-time counts
3. User can build formations with drag-and-drop
4. Alternative tap-to-place interaction works for formations
5. User receives push notification reminders before match

## Integration Points
- Team navigation needs Matches link
- Dashboard shows upcoming matches
- Match cards show RSVP counts
- Formation builder linked from match detail
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate matches into team navigation and dashboard</name>
  <files>
    - components/navigation/team-nav.tsx
    - app/[locale]/teams/[teamId]/layout.tsx
    - app/[locale]/dashboard/page.tsx
  </files>
  <action>
Update navigation and dashboard to integrate matches:

**components/navigation/team-nav.tsx:**
Add Matches tab to team navigation:

```typescript
const teamNavItems = [
  { label: t('overview'), href: `/teams/${teamId}` },
  { label: t('matches'), href: `/teams/${teamId}/matches` }, // NEW
  { label: t('players'), href: `/teams/${teamId}/players` },
  { label: t('roster'), href: `/teams/${teamId}/roster` },
  { label: t('settings'), href: `/teams/${teamId}/settings`, adminOnly: true },
];
```

Add translations:
- "navigation.matches": "Partite"

**app/[locale]/dashboard/page.tsx:**
Add upcoming matches section:

```typescript
// Add to dashboard
import { useMatches } from '@/hooks/use-matches';
import { MatchCard } from '@/components/matches/match-card';

// In the dashboard component
function UpcomingMatchesSection() {
  // Get teams first
  const { teams } = useTeams();
  
  // For each team, get upcoming matches
  // Show next 3-5 upcoming matches across all teams
  // Sort by date (soonest first)
  
  return (
    <section>
      <h2>{t('dashboard.upcomingMatches')}</h2>
      {upcomingMatches.length === 0 ? (
        <EmptyState message={t('dashboard.noUpcomingMatches')} />
      ) : (
        <div className="grid gap-4">
          {upcomingMatches.map(match => (
            <MatchCard 
              key={match.id} 
              match={match} 
              teamId={match.team_id}
              showRSVPCount={true} // NEW: Show IN count
            />
          ))}
        </div>
      )}
    </section>
  );
}
```

Update MatchCard to optionally show RSVP count:
```typescript
interface MatchCardProps {
  match: Match;
  teamId: string;
  showRSVPCount?: boolean; // NEW
}
```

Add translations:
- "dashboard.upcomingMatches": "Prossime partite"
- "dashboard.noUpcomingMatches": "Nessuna partita programmata"

**app/[locale]/teams/[teamId]/layout.tsx:**
Ensure team layout persists across match pages.
  </action>
  <verify>
Navigation shows Matches tab. Dashboard shows upcoming matches. TypeScript compiles.
  </verify>
  <done>
Team navigation includes Matches tab. Dashboard shows upcoming matches with RSVP counts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add formation link to match detail and RSVP counts to match cards</name>
  <files>
    - app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx
    - components/matches/match-card.tsx
  </files>
  <action>
Enhance match detail and cards:

**app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx:**
Add formation section:

```typescript
// Add to match detail page
<section className="mt-6">
  <h3 className="text-lg font-semibold mb-3">{t('matches.formation')}</h3>
  
  {hasFormation ? (
    <div className="relative">
      {/* Mini preview of formation */}
      <FormationPreview formation={formation} />
      
      <Button asChild variant="outline" className="mt-3">
        <Link href={`/teams/${teamId}/matches/${matchId}/formation`}>
          {isAdmin ? t('matches.editFormation') : t('matches.viewFormation')}
        </Link>
      </Button>
    </div>
  ) : (
    <div className="text-center py-8 bg-muted rounded-lg">
      <p className="text-muted-foreground mb-3">
        {t('matches.noFormation')}
      </p>
      {isAdmin && (
        <Button asChild>
          <Link href={`/teams/${teamId}/matches/${matchId}/formation`}>
            {t('matches.createFormation')}
          </Link>
        </Button>
      )}
    </div>
  )}
</section>
```

Add FormationPreview component for mini visualization:
- Show simplified pitch with player positions
- Just dots/avatars showing formation shape
- Click to open full formation builder

**components/matches/match-card.tsx:**
Add RSVP count badge:

```typescript
// In MatchCard component
<div className="flex items-center gap-4">
  {/* Existing match info */}
  
  {/* NEW: RSVP count badge */}
  <div className="flex items-center gap-1 text-sm text-muted-foreground">
    <Users className="h-4 w-4" />
    <span>{rsvpCount.in}/{playersNeeded}</span>
  </div>
  
  <ChevronRight className="h-5 w-5" />
</div>
```

- Show "8/10" (confirmed/needed)
- Color: green if full, yellow if partial, red if low
- Icon: Users icon from lucide-react
- playersNeeded based on mode (5vs5=10, 8vs8=16)

Add optional RSVP count fetching:
```typescript
// Option 1: Pass count as prop
interface MatchCardProps {
  match: Match;
  teamId: string;
  rsvpCount?: RSVPCounts; // Optional, shows if provided
}

// Option 2: Fetch internally (simpler)
const { counts } = useRSVPCounts(match.id);
```

Add translations:
- "matches.formation": "Formazione"
- "matches.editFormation": "Modifica formazione"
- "matches.viewFormation": "Vedi formazione"
- "matches.createFormation": "Crea formazione"
- "matches.noFormation": "Nessuna formazione impostata"
  </action>
  <verify>
Match detail shows formation section. Match cards show RSVP counts. TypeScript compiles.
  </verify>
  <done>
Formation preview and edit link on match detail. RSVP count badges on match cards.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add notification permission request and final translations</name>
  <files>
    - app/[locale]/teams/[teamId]/matches/create/page.tsx
    - messages/it.json
    - messages/en.json
  </files>
  <action>
Add notification request flow and complete translations:

**app/[locale]/teams/[teamId]/matches/create/page.tsx:**
Show notification request after creating first match:

```typescript
// After successful match creation
const [showNotificationRequest, setShowNotificationRequest] = useState(false);

const handleSuccess = () => {
  // Check if this is user's first match
  if (isFirstMatch && permission === 'default') {
    setShowNotificationRequest(true);
  } else {
    router.push(`/teams/${teamId}/matches`);
  }
};

// In JSX
{showNotificationRequest && (
  <NotificationPermissionModal
    onAllow={async () => {
      await requestPermission();
      router.push(`/teams/${teamId}/matches`);
    }}
    onSkip={() => {
      router.push(`/teams/${teamId}/matches`);
    }}
  />
)}
```

**Complete translations in messages/it.json:**

Add comprehensive "matches" section:
```json
{
  "matches": {
    "title": "Partite",
    "create": "Crea partita",
    "edit": "Modifica partita",
    "cancel": "Annulla partita",
    "uncancel": "Ripristina partita",
    "upcoming": "Prossime",
    "past": "Passate",
    "noUpcoming": "Nessuna partita programmata",
    "noPast": "Nessuna partita passata",
    "form": {
      "scheduledAt": "Data e ora",
      "location": "Location",
      "locationPlaceholder": "Campo sportivo, indirizzo...",
      "mode": "Modalità",
      "mode5vs5": "5 vs 5",
      "mode8vs8": "8 vs 8",
      "notes": "Note (opzionale)",
      "notesPlaceholder": "Informazioni aggiuntive..."
    },
    "validation": {
      "scheduledAtRequired": "Seleziona data e ora",
      "locationMin": "Location troppo corta",
      "locationMax": "Location troppo lunga",
      "notesMax": "Note troppo lunghe"
    },
    "rsvp": {
      "title": "Partecipazione",
      "in": "Ci sono!",
      "out": "Non posso",
      "maybe": "Forse",
      "yourResponse": "La tua risposta",
      "whoIsComing": "Chi viene?"
    },
    "availability": {
      "title": "Disponibilità",
      "confirmed": "confermati",
      "maybe": "forse",
      "out": "non possono",
      "needed": "necessari"
    },
    "rsvpList": {
      "title": "Risposte",
      "in": "Ci sono",
      "out": "Non possono",
      "maybe": "Forse",
      "noResponse": "Non hanno risposto"
    },
    "formation": {
      "title": "Formazione",
      "selectFormation": "Seleziona modulo",
      "dragOrTap": "Trascina o tocca per posizionare",
      "tapPlayerThenPosition": "Tocca giocatore, poi posizione",
      "playerPool": "Giocatori disponibili",
      "save": "Salva formazione",
      "clear": "Cancella",
      "editFormation": "Modifica formazione",
      "viewFormation": "Vedi formazione",
      "createFormation": "Crea formazione",
      "noFormation": "Nessuna formazione impostata"
    },
    "status": {
      "scheduled": "Programmata",
      "in_progress": "In corso",
      "completed": "Completata",
      "cancelled": "Annullata"
    }
  }
}
```

Also add "notifications" section if not already added in Plan 03-05.

Copy Italian translations to messages/en.json with English equivalents.
  </action>
  <verify>
All translations present in both IT and EN files. JSON is valid.
  </verify>
  <done>
Notification permission request after first match. Complete translations for matches, RSVPs, formations.
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 4: End-to-end verification of Phase 3 features</name>
  <what-built>
Complete Phase 3 Match Management implementation:
- Database schema for matches, RSVPs, formations
- Match CRUD (create, list, edit, cancel)
- RSVP system (IN/OUT/Maybe) with real-time counts
- Formation builder (drag-and-drop + tap-to-place)
- Push notification reminders
- Integration with team navigation and dashboard
- Mobile-optimized UI throughout
  </what-built>
  <how-to-verify>
Please verify the following scenarios:

**Scenario 1: Create Match**
1. Navigate to a team → Matches tab
2. Click "Crea partita"
3. Fill in date/time, location, select mode (5vs5 or 8vs8)
4. Submit - match appears in list

**Scenario 2: RSVP System**
1. Open a match detail
2. Click RSVP buttons (Ci sono!/Non posso/Forse)
3. Verify: Count updates immediately (optimistic UI)
4. Open same match in another browser/device
5. Verify: RSVP changes sync in real-time
6. Check RSVP list shows correct groupings

**Scenario 3: Formation Builder**
1. From match detail, click "Crea formazione"
2. Select a formation preset
3. Drag players to positions (or use tap-to-place)
4. Verify magnetic snapping works
5. Save formation
6. Return to match detail - formation preview visible

**Scenario 4: Push Notifications**
1. Create a match scheduled for ~25 hours from now
2. Grant notification permission when prompted
3. Verify: Notification permission stored
4. (Optional) Test with local notification

**Scenario 5: Mobile Experience**
1. Test on mobile device or mobile viewport
2. Verify date/time picker uses native controls
3. Verify touch targets are large (44px+)
4. Verify drag-and-drop works smoothly on touch

**Expected Results:**
- All actions complete without errors
- UI is responsive and mobile-friendly
- Real-time updates work across devices
- Data persists correctly
  </how-to-verify>
  <resume-signal>Type "approved" if all scenarios pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Final verification checklist:
- [ ] User can create match with all fields
- [ ] Match appears in team list and dashboard
- [ ] RSVP IN/OUT/Maybe works with optimistic updates
- [ ] Availability count updates in real-time
- [ ] Formation builder supports drag-and-drop
- [ ] Formation builder supports tap-to-place
- [ ] Formation saves and displays correctly
- [ ] Push notification permission flow works
- [ ] All translations present (IT/EN)
- [ ] Mobile experience is smooth
</verification>

<success_criteria>
- All 5 Phase 3 success criteria are demonstrable
- User can complete full match management workflow
- Real-time features work across multiple devices
- Mobile-optimized with large touch targets
- Push notification infrastructure ready
</success_criteria>

<output>
After completion, create `.planning/phases/03-match-management/03-06-SUMMARY.md` and update STATE.md
</output>
