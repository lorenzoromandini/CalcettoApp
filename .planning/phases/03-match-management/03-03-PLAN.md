---
phase: 03-match-management
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - lib/db/rsvps.ts
  - hooks/use-rsvps.ts
  - components/matches/rsvp-button.tsx
  - components/matches/rsvp-list.tsx
  - components/matches/availability-counter.tsx
  - app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx
  - messages/it.json
  - messages/en.json
autonomous: true

must_haves:
  truths:
    - "Player can RSVP IN/OUT/Maybe to a match"
    - "RSVP status updates immediately with optimistic UI"
    - "Availability counter shows confirmed (IN) count in real-time"
    - "RSVP list displays who's coming with their status"
    - "RSVP updates sync via Supabase Realtime for all connected users"
  artifacts:
    - path: "lib/db/rsvps.ts"
      provides: "RSVP CRUD operations with real-time subscription"
      exports: ["updateRSVP", "getMatchRSVPs", "subscribeToRSVPs", "getRSVPCounts"]
    - path: "hooks/use-rsvps.ts"
      provides: "RSVP hooks with optimistic updates and real-time sync"
      exports: ["useRSVPs", "useUpdateRSVP", "useRSVPCounts"]
    - path: "components/matches/rsvp-button.tsx"
      provides: "Three-state RSVP button component (IN/OUT/Maybe)"
    - path: "components/matches/rsvp-list.tsx"
      provides: "List of players with their RSVP status"
    - path: "components/matches/availability-counter.tsx"
      provides: "Counter showing IN count vs needed players"
  key_links:
    - from: "hooks/use-rsvps.ts"
      to: "lib/db/rsvps.ts"
      via: "import and subscribe"
      pattern: "subscribeToRSVPs"
    - from: "app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx"
      to: "hooks/use-rsvps.ts"
      via: "useRSVPs and useRSVPCounts"
      pattern: "const { rsvps } = useRSVPs"
    - from: "components/matches/rsvp-button.tsx"
      to: "hooks/use-rsvps.ts"
      via: "useUpdateRSVP"
      pattern: "const { updateRSVP } = useUpdateRSVP"
---

<objective>
Implement RSVP system for matches: IN/OUT/Maybe responses with real-time availability counts.

Purpose: Answer the #1 question "Who's coming?" with real-time updates showing player availability.

Output: Complete RSVP system with optimistic UI, real-time sync, availability counter, and player list showing responses.
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-match-management/03-02-SUMMARY.md
@lib/db/matches.ts
@hooks/use-matches.ts
@lib/supabase/client.ts

## Real-time Infrastructure (from Phase 1/2)
- Supabase Realtime (SSE) already configured
- createClient() from lib/supabase/client.ts
- Realtime subscriptions work via supabase.channel()

## Requirements Covered
- MATCH-04: Player RSVP assignment (IN/OUT/Maybe)
- MATCH-05: Availability count display

## Research Notes
"User research shows 'Who's coming?' is the #1 question every week." — Real-time updates are critical.

## Mobile Requirements
- Large touch targets for RSVP buttons (min 48px)
- Immediate visual feedback (optimistic updates)
- Clear availability status at a glance
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RSVP database operations with real-time support</name>
  <files>
    - lib/db/rsvps.ts
  </files>
  <action>
Create lib/db/rsvps.ts for RSVP management:

**Types:**
```typescript
export type RSVPStatus = 'in' | 'out' | 'maybe';

export interface RSVPCounts {
  in: number;
  out: number;
  maybe: number;
  total: number;
}

export interface MatchRSVP {
  id: string;
  match_id: string;
  player_id: string;
  player_name: string;
  player_avatar?: string;
  rsvp_status: RSVPStatus;
  rsvp_at: string;
}
```

**Functions:**

1. **updateRSVP(matchId: string, playerId: string, status: RSVPStatus): Promise<void>**
   - Upsert into match_players table
   - Set rsvp_status, rsvp_at = NOW()
   - Handle offline: queue action if no connection
   - Return immediately for optimistic UI

2. **getMatchRSVPs(matchId: string): Promise<MatchRSVP[]>**
   - Query match_players joined with players
   - Return array with player details and RSVP status
   - Sort by: IN first, then Maybe, then OUT, then by rsvp_at
   - Fall back to IndexedDB if offline

3. **getRSVPCounts(matchId: string): Promise<RSVPCounts>**
   - Aggregate counts by status
   - Return { in, out, maybe, total }
   - Efficient query using COUNT with FILTER

4. **subscribeToRSVPs(matchId: string, onUpdate: (rsvps: MatchRSVP[]) => void): () => void**
   - Create Supabase Realtime channel
   - Subscribe to match_players table changes for this match_id
   - Call onUpdate when data changes
   - Return unsubscribe function
   - Handle connection errors gracefully

5. **getMyRSVP(matchId: string, playerId: string): Promise<RSVPStatus | null>**
   - Get current user's RSVP for this match
   - Return status or null if not responded

**Offline Support:**
- RSVP changes are critical - queue for background sync
- Use queueOfflineAction from lib/db/actions.ts
- Update IndexedDB match_players store immediately

Example subscription usage:
```typescript
const unsubscribe = subscribeToRSVPs(matchId, (rsvps) => {
  setRSVPs(rsvps);
});
// Cleanup: unsubscribe()
```
  </action>
  <verify>
TypeScript compiles:
npx tsc --noEmit lib/db/rsvps.ts

Realtime subscription follows Supabase Realtime patterns.
  </verify>
  <done>
lib/db/rsvps.ts exports RSVP operations with real-time subscription support and offline queue integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RSVP React hooks with optimistic updates</name>
  <files>
    - hooks/use-rsvps.ts
  </files>
  <action>
Create hooks/use-rsvps.ts:

**useRSVPs(matchId: string):**
Returns: { rsvps, isLoading, error, refetch }
- Fetch RSVPs on mount
- Subscribe to real-time updates
- Cleanup subscription on unmount
- Combine initial fetch with real-time updates

```typescript
useEffect(() => {
  fetchRSVPs(); // Initial load
  
  const unsubscribe = subscribeToRSVPs(matchId, (newRSVPs) => {
    setRSVPs(newRSVPs);
    setIsLoading(false);
  });
  
  return () => unsubscribe();
}, [matchId]);
```

**useRSVPCounts(matchId: string):**
Returns: { counts, isLoading, error }
- Calculate from useRSVPs data (don't double-fetch)
- Derive counts: { in, out, maybe, total }

**useUpdateRSVP():**
Returns: { updateRSVP, isPending, error }
- Optimistic update: update UI immediately before server
- Rollback on error
- Toast notification on success/error

```typescript
const updateRSVP = useCallback(async (playerId: string, status: RSVPStatus) => {
  // Optimistic update
  const previousRSVPs = rsvps;
  setRSVPs(prev => prev.map(r => 
    r.player_id === playerId ? { ...r, rsvp_status: status } : r
  ));
  
  try {
    await updateRSVPDB(matchId, playerId, status);
    toast.success('Risposta aggiornata');
  } catch (err) {
    // Rollback
    setRSVPs(previousRSVPs);
    toast.error('Errore durante l\'aggiornamento');
    throw err;
  }
}, [matchId, rsvps]);
```

**useMyRSVP(matchId: string, playerId: string | null):**
Returns: { status, isLoading }
- Get current user's RSVP status
- Useful for highlighting their response in UI

Follow patterns from use-teams.ts for error handling and loading states.
  </action>
  <verify>
TypeScript check:
npx tsc --noEmit hooks/use-rsvps.ts

Optimistic update pattern implemented correctly.
  </verify>
  <done>
hooks/use-rsvps.ts exports useRSVPs, useRSVPCounts, useUpdateRSVP with real-time sync and optimistic updates.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create RSVP UI components</name>
  <files>
    - components/matches/rsvp-button.tsx
    - components/matches/rsvp-list.tsx
    - components/matches/availability-counter.tsx
  </files>
  <action>
Create RSVP UI components:

**components/matches/rsvp-button.tsx:**
Three-state segmented button for RSVP:

```typescript
interface RSVPButtonProps {
  currentStatus: RSVPStatus | null;
  onChange: (status: RSVPStatus) => void;
  disabled?: boolean;
}
```

Design:
- Three buttons in a row: "Ci sono!" (IN), "Non posso" (OUT), "Forse" (Maybe)
- Selected state highlighted with color:
  - IN: Green (bg-green-600)
  - OUT: Red (bg-red-600)
  - Maybe: Yellow (bg-yellow-500)
- Large touch targets: min-h-[48px] each
- Icons: Check, X, Question mark
- Full width on mobile

Behavior:
- Clicking same status again keeps it selected
- Immediate visual feedback (no loading spinner during optimistic update)
- Disabled state during submission (shows spinner on selected button)

**components/matches/availability-counter.tsx:**
Show "Who's coming" at a glance:

```typescript
interface AvailabilityCounterProps {
  counts: RSVPCounts;
  mode: MatchMode; // '5vs5' or '8vs8'
}
```

Display:
- Large number: "8 / 10" (confirmed / needed)
- Progress bar showing fill percentage
- Color coding:
  - Green if >= needed
  - Yellow if >= needed/2
  - Red if < needed/2
- Breakdown below: "8 ci sono, 2 forse, 3 non possono"
- Based on match mode: 5vs5 needs 10 players, 8vs8 needs 16

**components/matches/rsvp-list.tsx:**
List all players and their RSVP status:

```typescript
interface RSVPListProps {
  rsvps: MatchRSVP[];
  currentPlayerId?: string;
  isAdmin?: boolean;
}
```

Display:
- Grouped by status: IN section, Maybe section, OUT section, No response section
- Each item shows:
  - Player avatar (32x32)
  - Player name
  - Status badge (color-coded)
  - RSVP time ("2 ore fa")
- Current player highlighted
- Sort: Most recent RSVPs first within each group
- Empty states: "Nessuna risposta" for each group

Mobile optimizations:
- Large touch targets for changing RSVP
- Swipe gestures (optional enhancement)
- Clear visual hierarchy

Add translations to messages files:
- "matches.rsvp.in": "Ci sono!"
- "matches.rsvp.out": "Non posso"
- "matches.rsvp.maybe": "Forse"
- "matches.availability.title": "Chi viene?"
- "matches.rsvpList.title": "Risposte"
- etc.
  </action>
  <verify>
Components compile:
npx tsc --noEmit components/matches/rsvp-button.tsx components/matches/rsvp-list.tsx components/matches/availability-counter.tsx

All have proper TypeScript types and follow component patterns.
  </verify>
  <done>
RSVP button with three states, availability counter with progress bar, RSVP list grouped by status. Translations added.
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate RSVP system into match detail page</name>
  <files>
    - app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx
  </files>
  <action>
Update the match detail page to include RSVP functionality:

**Update app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx:**

Import new hooks and components:
```typescript
import { useRSVPs, useRSVPCounts, useUpdateRSVP } from '@/hooks/use-rsvps';
import { RSVPButton } from '@/components/matches/rsvp-button';
import { RSVPList } from '@/components/matches/rsvp-list';
import { AvailabilityCounter } from '@/components/matches/availability-counter';
import { usePlayers } from '@/hooks/use-players';
```

New sections in the page:

1. **Availability Section** (top, prominent)
   - Show AvailabilityCounter with counts
   - Always visible

2. **My RSVP Section** (if user is a team player)
   - Get current player's player_id from player_teams
   - Show RSVPButton with current status
   - Call updateRSVP on change
   - Show confirmation toast

3. **RSVP List Section**
   - Show RSVPList with all responses
   - Highlight current user's entry
   - Show loading skeleton while fetching

Page structure:
```
Match Detail Header
├── Date/Time, Location, Mode
├── Status badge
├── Availability Counter (prominent)
└── Admin actions (edit/cancel)

My RSVP (if player)
└── RSVP Button

RSVP List
├── IN (8 players)
├── Maybe (2 players)
├── OUT (3 players)
└── No response (5 players)

Formation Builder (placeholder for Plan 03-04)
```

Data flow:
- Fetch match details (existing)
- Fetch team players (to find current user's player_id)
- Fetch RSVPs with real-time subscription
- Derive counts from RSVPs
- Allow RSVP updates

Loading states:
- Show skeleton for RSVPs while loading
- Disable RSVP button during update
- Show offline banner if disconnected

Error handling:
- Toast on RSVP update failure
- Retry button on fetch error

Update imports and ensure all new components are properly integrated.
  </action>
  <verify>
Page compiles and integrates:
npx tsc --noEmit app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx

RSVP data flows: match → rsvps → counts → UI.
  </verify>
  <done>
Match detail page shows availability counter, RSVP button for current player, and RSVP list with real-time updates.
  </done>
</task>

</tasks>

<verification>
Before proceeding to Wave 4, verify:
1. Player can click IN/OUT/Maybe and see immediate update
2. Availability counter updates in real-time
3. All connected users see RSVP changes instantly
4. RSVP list shows correct groupings
5. Optimistic updates work (UI updates before server response)
6. Offline: RSVP queues and syncs when reconnected
7. Mobile: Large touch targets work well
</verification>

<success_criteria>
- Players can RSVP with IN/OUT/Maybe responses
- Availability shows confirmed count vs needed
- Real-time updates visible to all connected users
- Optimistic UI provides instant feedback
- RSVP list organized by status groups
- Mobile-optimized touch targets (48px+)
</success_criteria>

<output>
After completion, create `.planning/phases/03-match-management/03-03-SUMMARY.md`
</output>
