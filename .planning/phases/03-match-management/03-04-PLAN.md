---
phase: 03-match-management
plan: 04
type: execute
wave: 4
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - components/formations/formation-builder.tsx
  - components/formations/pitch-grid.tsx
  - components/formations/player-pool.tsx
  - components/formations/formation-selector.tsx
  - hooks/use-formation.ts
  - lib/db/formations.ts
  - lib/formations/index.ts
  - app/[locale]/teams/[teamId]/matches/[matchId]/formation/page.tsx
  - messages/it.json
  - messages/en.json
autonomous: true

user_setup:
  - service: "dnd-kit"
    why: "Modern React drag-and-drop library with touch support and accessibility"
    install: "npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities"

must_haves:
  truths:
    - "Formation builder displays virtual pitch with correct grid for match mode"
    - "Player can drag-and-drop from pool to pitch position"
    - "Player can tap player then tap position as alternative interaction"
    - "Formation is persisted and reloads correctly"
    - "Touch targets are 44px+ with large drag handles"
    - "Magnetic snapping positions players precisely"
  artifacts:
    - path: "components/formations/formation-builder.tsx"
      provides: "Main formation builder container with drag-and-drop context"
      exports: ["FormationBuilder"]
    - path: "components/formations/pitch-grid.tsx"
      provides: "Visual pitch with drop zones for player positions"
      exports: ["PitchGrid"]
    - path: "components/formations/player-pool.tsx"
      provides: "Draggable player list with RSVP filtering"
      exports: ["PlayerPool"]
    - path: "components/formations/formation-selector.tsx"
      provides: "Formation preset selector (4-3-3, 4-4-2, etc.)"
      exports: ["FormationSelector"]
    - path: "hooks/use-formation.ts"
      provides: "Formation state management and persistence"
      exports: ["useFormation"]
    - path: "lib/db/formations.ts"
      provides: "Formation database operations"
      exports: ["saveFormation", "getFormation"]
    - path: "lib/formations/index.ts"
      provides: "Formation presets and position calculations"
      exports: ["FORMATION_PRESETS", "calculatePositions"]
  key_links:
    - from: "formation-builder.tsx"
      to: "@dnd-kit/core"
      via: "DndContext, DragOverlay"
      pattern: "import.*from '@dnd-kit/core'"
    - from: "pitch-grid.tsx"
      to: "lib/formations"
      via: "formation preset positions"
      pattern: "FORMATION_PRESETS"
    - from: "hooks/use-formation.ts"
      to: "lib/db/formations.ts"
      via: "saveFormation call"
      pattern: "await saveFormation"
---

<objective>
Implement formation builder with drag-and-drop + tap-to-place alternatives.

Purpose: Allow teams to build tactical formations visually, answering "How should we line up?"

Output: Complete formation builder with virtual pitch, player positioning, preset formations, and dual input methods (drag-and-drop + tap-to-place).
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-match-management/03-03-SUMMARY.md
@hooks/use-rsvps.ts
@lib/db/rsvps.ts

## Research Critical Notes
"Drag-and-drop preferred but tap-to-place alternatives essential for mobile."
"Critical: Touch targets 44px+, large drag handles, magnetic snapping"
"Avoid: Drag-and-drop as only input method (Pitfall #2)"

## Requirements Covered
- MATCH-03: Formation module based on match mode
- MATCH-06: Drag-and-drop formation builder
- MATCH-06-alt: Tap-to-place interaction

## Formation Basics
- 5vs5 = 10 players total (5 per side), typically 1-2-1 or 1-1-2 formations
- 8vs8 = 16 players total (8 per side), typically 3-3-1, 2-3-2, 3-2-2 formations
- Positions labeled: GK (goalkeeper), DEF (defender), MID (midfielder), FWD (forward)

## Tech Requirements
- Use @dnd-kit for drag-and-drop (modern, touch-support, accessible)
- Must support both interaction methods
- Mobile-first design
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit and create formation utilities</name>
  <files>
    - lib/formations/index.ts
  </files>
  <action>
Install drag-and-drop library and create formation presets:

**Install dnd-kit:**
```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

**Create lib/formations/index.ts:**

Define formation presets for 5vs5 and 8vs8 modes:

```typescript
export type FormationMode = '5vs5' | '8vs8';
export type Position = { x: number; y: number; label: string; role: 'GK' | 'DEF' | 'MID' | 'FWD' };

export interface FormationPreset {
  id: string;
  name: string;
  mode: FormationMode;
  positions: Position[];
}

// 5vs5 formations (5 players = 1 GK + 4 outfield)
export const FORMATION_PRESETS_5VS5: FormationPreset[] = [
  {
    id: '5-1-2-1',
    name: '1-2-1 (Diamante)',
    mode: '5vs5',
    positions: [
      { x: 4, y: 6, label: 'GK', role: 'GK' },
      { x: 4, y: 4, label: 'DEF', role: 'DEF' },
      { x: 2, y: 3, label: 'MID', role: 'MID' },
      { x: 6, y: 3, label: 'MID', role: 'MID' },
      { x: 4, y: 1, label: 'FWD', role: 'FWD' },
    ],
  },
  {
    id: '5-2-1-1',
    name: '2-1-1 (Piramide)',
    mode: '5vs5',
    positions: [
      { x: 4, y: 6, label: 'GK', role: 'GK' },
      { x: 2, y: 5, label: 'DEF', role: 'DEF' },
      { x: 6, y: 5, label: 'DEF', role: 'DEF' },
      { x: 4, y: 3, label: 'MID', role: 'MID' },
      { x: 4, y: 1, label: 'FWD', role: 'FWD' },
    ],
  },
  {
    id: '5-1-1-2',
    name: '1-1-2 (Attacco)',
    mode: '5vs5',
    positions: [
      { x: 4, y: 6, label: 'GK', role: 'GK' },
      { x: 4, y: 5, label: 'DEF', role: 'DEF' },
      { x: 4, y: 3, label: 'MID', role: 'MID' },
      { x: 2, y: 1, label: 'FWD', role: 'FWD' },
      { x: 6, y: 1, label: 'FWD', role: 'FWD' },
    ],
  },
];

// 8vs8 formations (8 players = 1 GK + 7 outfield)
export const FORMATION_PRESETS_8VS8: FormationPreset[] = [
  {
    id: '8-3-3-1',
    name: '3-3-1 (Bilanciato)',
    mode: '8vs8',
    positions: [
      { x: 4, y: 6, label: 'GK', role: 'GK' },
      { x: 2, y: 5, label: 'DEF', role: 'DEF' },
      { x: 4, y: 5, label: 'DEF', role: 'DEF' },
      { x: 6, y: 5, label: 'DEF', role: 'DEF' },
      { x: 2, y: 3, label: 'MID', role: 'MID' },
      { x: 4, y: 3, label: 'MID', role: 'MID' },
      { x: 6, y: 3, label: 'MID', role: 'MID' },
      { x: 4, y: 1, label: 'FWD', role: 'FWD' },
    ],
  },
  {
    id: '8-2-3-2',
    name: '2-3-2 (Offensivo)',
    mode: '8vs8',
    positions: [
      { x: 4, y: 6, label: 'GK', role: 'GK' },
      { x: 3, y: 5, label: 'DEF', role: 'DEF' },
      { x: 5, y: 5, label: 'DEF', role: 'DEF' },
      { x: 2, y: 3, label: 'MID', role: 'MID' },
      { x: 4, y: 3, label: 'MID', role: 'MID' },
      { x: 6, y: 3, label: 'MID', role: 'MID' },
      { x: 3, y: 1, label: 'FWD', role: 'FWD' },
      { x: 5, y: 1, label: 'FWD', role: 'FWD' },
    ],
  },
  {
    id: '8-3-2-2',
    name: '3-2-2 (Difensivo)',
    mode: '8vs8',
    positions: [
      { x: 4, y: 6, label: 'GK', role: 'GK' },
      { x: 2, y: 5, label: 'DEF', role: 'DEF' },
      { x: 4, y: 5, label: 'DEF', role: 'DEF' },
      { x: 6, y: 5, label: 'DEF', role: 'DEF' },
      { x: 3, y: 3, label: 'MID', role: 'MID' },
      { x: 5, y: 3, label: 'MID', role: 'MID' },
      { x: 3, y: 1, label: 'FWD', role: 'FWD' },
      { x: 5, y: 1, label: 'FWD', role: 'FWD' },
    ],
  },
];

export function getFormationPresets(mode: FormationMode): FormationPreset[] {
  return mode === '5vs5' ? FORMATION_PRESETS_5VS5 : FORMATION_PRESETS_8VS8;
}

export function getFormationPreset(mode: FormationMode, presetId: string): FormationPreset | undefined {
  return getFormationPresets(mode).find(p => p.id === presetId);
}

// Grid system: 9 columns (x: 0-8), 7 rows (y: 0-6)
// Pitch is 100% width, aspect ratio ~3:4 (portrait for mobile)
export const GRID_COLS = 9;
export const GRID_ROWS = 7;

export function positionToStyle(x: number, y: number): React.CSSProperties {
  return {
    left: `${(x / (GRID_COLS - 1)) * 100}%`,
    top: `${(y / (GRID_ROWS - 1)) * 100}%`,
    transform: 'translate(-50%, -50%)',
  };
}
```

The grid is 9x7 to allow precise positioning while keeping it simple. Portrait orientation works better for mobile (taller than wide pitch).
  </action>
  <verify>
dnd-kit installed and TypeScript compiles:
npx tsc --noEmit lib/formations/index.ts

All formation presets defined for both 5vs5 and 8vs8 modes.
  </verify>
  <done>
@dnd-kit/core installed. lib/formations/index.ts exports formation presets, position utilities, and grid constants.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create formation database operations and hook</name>
  <files>
    - lib/db/formations.ts
    - hooks/use-formation.ts
  </files>
  <action>
Create formation persistence layer:

**lib/db/formations.ts:**

```typescript
import { createClient } from '@/lib/supabase/client';
import { getDB } from '@/lib/db/index';
import type { Formation, FormationPosition } from '@/lib/db/schema';
import type { FormationMode } from '@/lib/formations';

export interface FormationData {
  formation: string; // preset ID like "5-1-2-1"
  positions: Array<{
    x: number;
    y: number;
    label: string;
    playerId?: string;
  }>;
}

export async function getFormation(matchId: string): Promise<FormationData | null> {
  const supabase = createClient();
  
  // Get formation
  const { data: formation } = await supabase
    .from('formations')
    .select('*')
    .eq('match_id', matchId)
    .single();
  
  if (!formation) return null;
  
  // Get positions
  const { data: positions } = await supabase
    .from('formation_positions')
    .select('*')
    .eq('formation_id', formation.id);
  
  return {
    formation: formation.team_formation.formation,
    positions: positions?.map(p => ({
      x: p.position_x,
      y: p.position_y,
      label: p.position_label,
      playerId: p.player_id,
    })) || [],
  };
}

export async function saveFormation(
  matchId: string, 
  data: FormationData
): Promise<void> {
  const supabase = createClient();
  
  // Upsert formation
  const { data: formation } = await supabase
    .from('formations')
    .upsert({
      match_id: matchId,
      team_formation: { formation: data.formation },
    }, { onConflict: 'match_id' })
    .select()
    .single();
  
  if (!formation) throw new Error('Failed to save formation');
  
  // Delete old positions
  await supabase
    .from('formation_positions')
    .delete()
    .eq('formation_id', formation.id);
  
  // Insert new positions
  if (data.positions.length > 0) {
    await supabase
      .from('formation_positions')
      .insert(
        data.positions.map(p => ({
          formation_id: formation.id,
          player_id: p.playerId,
          position_x: p.x,
          position_y: p.y,
          position_label: p.label,
        }))
      );
  }
}
```

**hooks/use-formation.ts:**

```typescript
import { useState, useEffect, useCallback } from 'react';
import { getFormation, saveFormation, type FormationData } from '@/lib/db/formations';
import type { FormationMode } from '@/lib/formations';

export function useFormation(matchId: string, mode: FormationMode) {
  const [formation, setFormation] = useState<FormationData | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);
  const [isSaving, setIsSaving] = useState(false);

  // Load formation on mount
  useEffect(() => {
    loadFormation();
  }, [matchId]);

  const loadFormation = async () => {
    setIsLoading(true);
    try {
      const data = await getFormation(matchId);
      setFormation(data);
    } catch (err) {
      setError(err instanceof Error ? err : new Error('Failed to load formation'));
    } finally {
      setIsLoading(false);
    }
  };

  const updateFormation = useCallback(async (data: FormationData) => {
    setIsSaving(true);
    try {
      await saveFormation(matchId, data);
      setFormation(data);
    } catch (err) {
      setError(err instanceof Error ? err : new Error('Failed to save formation'));
      throw err;
    } finally {
      setIsSaving(false);
    }
  }, [matchId]);

  return {
    formation,
    isLoading,
    isSaving,
    error,
    updateFormation,
    reload: loadFormation,
  };
}
```
  </action>
  <verify>
TypeScript compiles:
npx tsc --noEmit lib/db/formations.ts hooks/use-formation.ts

Formation data structures match database schema.
  </verify>
  <done>
Formation database operations and React hook created with save/load functionality.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create formation builder components with drag-and-drop</name>
  <files>
    - components/formations/pitch-grid.tsx
    - components/formations/player-pool.tsx
    - components/formations/formation-selector.tsx
  </files>
  <action>
Create formation builder UI components:

**components/formations/formation-selector.tsx:**
Dropdown to select formation preset:

```typescript
interface FormationSelectorProps {
  mode: FormationMode;
  currentFormation: string;
  onChange: (presetId: string) => void;
}
```

- Show presets for the current mode (5vs5 or 8vs8)
- Dropdown or button group with preset names
- On change: load preset positions (players unassigned)

**components/formations/pitch-grid.tsx:**
The visual pitch with drop zones:

```typescript
interface PitchGridProps {
  mode: FormationMode;
  positions: Array<{ x: number; y: number; label: string; playerId?: string }>;
  players: Array<{ id: string; name: string; avatar?: string }>;
  selectedPlayerId: string | null;
  onDrop: (positionIndex: number, playerId: string) => void;
  onTapPosition: (positionIndex: number) => void;
}
```

Design:
- Green pitch background with field lines (center line, penalty areas)
- Aspect ratio 3:4 (portrait) for mobile
- Position markers as circles with labels (GK, DEF, MID, FWD)
- Occupied positions show player avatar + name
- Empty positions show ghosted label
- Touch targets: 56px minimum
- Magnetic snap: positions snap to grid points

Drag-and-drop:
- Use @dnd-kit's useDroppable for each position
- Visual feedback when dragging over (highlight)
- Smooth animations

Tap-to-place:
- Click position when player selected → assign
- Highlight selected position
- Clear visual indication of active mode

**components/formations/player-pool.tsx:**
List of available players (RSVP'd IN):

```typescript
interface PlayerPoolProps {
  players: Array<{ id: string; name: string; avatar?: string; rsvp: 'in' | 'out' | 'maybe' }>;
  selectedPlayerId: string | null;
  assignedPlayerIds: string[];
  onSelectPlayer: (playerId: string) => void;
}
```

Design:
- Horizontal scrollable list or vertical stack
- Show only RSVP='in' players + admin override
- Assigned players shown as "used" (grayed or checked)
- Selected player highlighted with border
- Large touch targets (72px height min)
- Drag handle icon on each player

Drag-and-drop:
- Use @dnd-kit's useDraggable for each player
- Drag preview shows player avatar
- Ghost image follows finger

Mobile optimizations:
- Large touch areas
- Visual feedback on touch
- Prevent accidental drops

Add translations:
- "formations.title": "Formazione"
- "formations.selectFormation": "Seleziona modulo"
- "formations.dragOrTap": "Trascina o tocca per posizionare"
- "formations.tapPlayerThenPosition": "Tocca giocatore, poi posizione"
  </action>
  <verify>
Components compile:
npx tsc --noEmit components/formations/*.tsx

@dnd-kit imports are correct.
  </verify>
  <done>
Formation selector, pitch grid with drop zones, and player pool with draggables created.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create formation builder container and page</name>
  <files>
    - components/formations/formation-builder.tsx
    - app/[locale]/teams/[teamId]/matches/[matchId]/formation/page.tsx
  </files>
  <action>
Create the main formation builder:

**components/formations/formation-builder.tsx:**

```typescript
interface FormationBuilderProps {
  matchId: string;
  teamId: string;
  mode: FormationMode;
  players: Array<{ id: string; name: string; avatar?: string; rsvp: 'in' | 'out' | 'maybe' }>;
  isAdmin: boolean;
}

export function FormationBuilder({ matchId, teamId, mode, players, isAdmin }: FormationBuilderProps)
```

State management:
- selectedFormation: current preset ID
- positions: array of position assignments
- selectedPlayerId: for tap-to-place mode
- dragActive: boolean for drag state

DndContext setup:
- Wrap in DndContext from @dnd-kit
- Handle onDragEnd event
- Calculate which position was dropped on
- Update positions state

Interaction modes:
1. Drag-and-drop: Standard dnd-kit behavior
2. Tap-to-place:
   - Tap player → selectedPlayerId set
   - Tap position → if player selected, assign
   - Visual indicator: "Seleziona posizione per [Nome]"

Formation selector:
- Dropdown at top
- Changing preset resets positions (keeps assigned players where possible)

Save/Clear buttons:
- Save: Persist to database
- Clear: Reset all assignments
- Auto-save debounced (optional)

Responsive layout:
- Mobile: Stack vertically (pitch on top, player pool below)
- Desktop: Side by side

**app/[locale]/teams/[teamId]/matches/[matchId]/formation/page.tsx:**

```typescript
export default function FormationPage({ params }: { params: { locale: string; teamId: string; matchId: string } })
```

- Fetch match details (for mode)
- Fetch team players with RSVPs
- Check admin status
- Render FormationBuilder
- Link back to match detail

Mobile-first layout:
- Full screen experience on mobile
- Back button to match
- Save button prominently placed

Error states:
- Not enough players RSVPed
- Formation save error
- Loading states
  </action>
  <verify>
Page and builder compile:
npx tsc --noEmit components/formations/formation-builder.tsx
npx tsc --noEmit app/[locale]/teams/[teamId]/matches/[matchId]/formation/page.tsx

DndContext wraps components correctly.
  </verify>
  <done>
Formation builder container with dual interaction modes and formation page route created.
  </done>
</task>

</tasks>

<verification>
Before proceeding to Wave 5, verify:
1. Drag-and-drop works smoothly on mobile
2. Tap-to-place is clear and functional
3. Formation presets load correctly for match mode
4. Positions snap to grid precisely
5. Touch targets are 44px+
6. Formation saves and reloads correctly
7. Only RSVP='in' players appear in pool (with admin override)
8. Visual feedback during drag is clear
</verification>

<success_criteria>
- Formation builder displays virtual pitch with correct dimensions
- Drag-and-drop positions players smoothly
- Tap-to-place works as accessible alternative
- Formation presets available per match mode (5vs5/8vs8)
- Touch targets meet 44px minimum
- Magnetic snapping works precisely
- Formation persists to database
- Mobile experience is smooth and responsive
</success_criteria>

<output>
After completion, create `.planning/phases/03-match-management/03-04-SUMMARY.md`
</output>
