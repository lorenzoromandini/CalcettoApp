---
phase: 05-post-match-statistics
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - hooks/use-statistics.ts
  - components/statistics/player-stats-card.tsx
  - components/statistics/player-leaderboard.tsx
  - app/[locale]/teams/[teamId]/stats/page.tsx
  - app/[locale]/teams/[teamId]/players/[playerId]/page.tsx
  - messages/it.json
  - messages/en.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can view player profile with full statistics by clicking on player from Roster"
    - "User can view team statistics page with 7 leaderboards (top 3 each)"
    - "Goalkeeper profile shows goals conceded"
    - "Statistics display uses Italian labels"
  artifacts:
    - path: "hooks/use-statistics.ts"
      provides: "React hooks for statistics data"
      exports: ["usePlayerStats", "useTeamLeaderboards"]
    - path: "app/[locale]/teams/[teamId]/players/[playerId]/page.tsx"
      provides: "Player profile page with statistics"
      contains: "PlayerStatsCard"
    - path: "app/[locale]/teams/[teamId]/stats/page.tsx"
      provides: "Team statistics page with 7 leaderboards"
      contains: "PlayerLeaderboard"
  key_links:
    - from: "hooks/use-statistics.ts"
      to: "lib/db/statistics.ts"
      via: "server action calls"
    - from: "player profile page"
      to: "usePlayerStats"
      via: "hook import"
---

<objective>
Create React hooks, player profile page with goalkeeper goals conceded, and team statistics page with 7 leaderboards (top 3 each).

Purpose: Provide visual presentation layer for statistics, including goalkeeper-specific stats and complete team leaderboards.
Output: Statistics hooks, player profile page, team stats page with 7 leaderboards.
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Dependencies from Plan 01
@lib/db/statistics.ts

# Existing patterns
@hooks/use-player-ratings.ts
@app/[locale]/teams/[teamId]/players/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create statistics React hooks</name>
  <files>hooks/use-statistics.ts</files>
  <action>
    Create hooks/use-statistics.ts with React hooks:
    
    **Hooks to implement:**
    
    1. `usePlayerStats(playerId: string, teamId?: string)`
       - Fetches PlayerStats including goals_conceded for goalkeepers
       - Returns { stats, isLoading, error, refresh }
    
    2. `useTeamLeaderboards(teamId: string)`
       - Fetches all 7 leaderboards at once
       - Returns { 
           scorers, 
           assisters, 
           appearances, 
           wins, 
           losses, 
           rated, 
           goalsConceded,
           isLoading, 
           error 
         }
    
    **Implementation pattern:**
    ```typescript
    export function usePlayerStats(playerId: string, teamId?: string) {
      const [stats, setStats] = useState<PlayerStats | null>(null)
      const [isLoading, setIsLoading] = useState(true)
      const [error, setError] = useState<string | null>(null)
      
      useEffect(() => {
        async function fetchStats() {
          setIsLoading(true)
          setError(null)
          try {
            const result = await getPlayerStats(playerId, teamId)
            setStats(result)
          } catch (err) {
            setError(err instanceof Error ? err.message : 'Errore nel caricamento')
          } finally {
            setIsLoading(false)
          }
        }
        if (playerId) fetchStats()
      }, [playerId, teamId])
      
      return { stats, isLoading, error, refresh }
    }
    ```
  </action>
  <verify>
    npx tsc --noEmit succeeds
    grep -n "usePlayerStats\|useTeamLeaderboards" hooks/use-statistics.ts shows all hooks
  </verify>
  <done>
    hooks/use-statistics.ts created with 2 exported hooks
    useTeamLeaderboards returns 7 leaderboards
    Loading and error states handled
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PlayerStatsCard component</name>
  <files>components/statistics/player-stats-card.tsx</files>
  <action>
    Create components/statistics/player-stats-card.tsx:
    
    **Props:**
    ```typescript
    interface PlayerStatsCardProps {
      stats: PlayerStats
      showTitle?: boolean
      className?: string
    }
    ```
    
    **Visual design:**
    - Player avatar and name at top
    - Statistics grid (2x3 on mobile, 3x2 on desktop):
      - Gol: {goals} (Target icon)
      - Assist: {assists} (Crosshair icon)
      - Presenze: {appearances} (Users icon)
      - Vittorie: {wins} (Trophy icon, green text)
      - Sconfitte: {losses} (X icon, red text)
      - Pareggi: {draws} (Minus icon, gray text)
    - Media Voto: {avg_rating?.toFixed(2)} with Star icon
    
    **Goalkeeper section (only if stats.goals_conceded !== null):**
    - Show after main stats
    - Gol Subiti: {goals_conceded} (Shield icon)
    - Label: "Gol subiti come portiere"
    
    Create the components/statistics directory if needed.
  </action>
  <verify>
    npx tsc --noEmit succeeds
    ls components/statistics/player-stats-card.tsx exists
    grep "goals_conceded" components/statistics/player-stats-card.tsx shows GK section
  </verify>
  <done>
    PlayerStatsCard displays all stats
    Goals conceded shown only for goalkeepers
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PlayerLeaderboard component (Top 3)</name>
  <files>components/statistics/player-leaderboard.tsx</files>
  <action>
    Create components/statistics/player-leaderboard.tsx for top 3 display:
    
    **Props:**
    ```typescript
    interface PlayerLeaderboardProps {
      title: string
      entries: PlayerLeaderboardEntry[]
      valueLabel: string
      lowerIsBetter?: boolean  // For goals conceded
      isLoading?: boolean
      emptyMessage?: string
      className?: string
    }
    ```
    
    **Visual design:**
    - Card with title header
    - List of top 3 players:
      - Position badge (1st gold, 2nd silver, 3rd bronze)
      - Player avatar (36px)
      - Player name + nickname
      - Value on right (bold)
    - Empty state when no data
    
    **Position styling:**
    - 1st: Gold badge (#FFD700), Trophy icon
    - 2nd: Silver badge (#C0C0C0), Medal icon
    - 3rd: Bronze badge (#CD7F32), Medal icon
    
    **For goals conceded leaderboard:**
    - lowerIsBetter = true
    - Value styling: green for low numbers (good)
    - Label: "Meno gol subiti"
  </action>
  <verify>
    npx tsc --noEmit succeeds
    ls components/statistics/player-leaderboard.tsx exists
  </verify>
  <done>
    PlayerLeaderboard shows top 3 with medal badges
    Supports lowerIsBetter for goals conceded
  </done>
</task>

<task type="auto">
  <name>Task 4: Create player profile page</name>
  <files>app/[locale]/teams/[teamId]/players/[playerId]/page.tsx</files>
  <action>
    Create player profile page accessible from Roster:
    
    **Server component (page.tsx):**
    ```typescript
    // Get playerId from params
    // Get player info (name, nickname, avatar, roles, jersey number)
    // Pass to client component
    ```
    
    **Client component (player-profile-client.tsx):**
    ```typescript
    // Use usePlayerStats(playerId, teamId)
    // Show loading skeleton while fetching
    // Display:
    //   - Player header (avatar, name, nickname)
    //   - Player info (jersey number, primary role, other roles)
    //   - PlayerStatsCard with full stats (including goals_conceded for GK)
    //   - Back button to roster
    ```
    
    **Player info section:**
    - Numero maglia: {jerseyNumber}
    - Ruolo principale: {roles[0]}
    - Altri ruoli: {roles.slice(1).join(', ')} or "Nessuno"
    
    **Handle:**
    - Player not found
    - Loading state
    - Error state
  </action>
  <verify>
    npx tsc --noEmit succeeds
    ls app/[locale]/teams/[teamId]/players/[playerId]/page.tsx exists
  </verify>
  <done>
    Player profile page created
    Shows player info and full stats including goals_conceded for GK
    Accessible from Roster
  </done>
</task>

<task type="auto">
  <name>Task 5: Create team statistics page with 7 leaderboards</name>
  <files>app/[locale]/teams/[teamId]/stats/page.tsx, messages/it.json, messages/en.json</files>
  <action>
    Create team statistics page:
    
    **Page structure:**
    - Header: "Statistiche" + team name
    - 7 leaderboards in responsive grid (2-3 columns):
      1. Top Marcatori (scorers)
      2. Top Assist (assisters)
      3. Top Presenze (appearances)
      4. Top Vittorie (wins)
      5. Top Sconfitte (losses)
      6. Top MVP (avg rating)
      7. Miglior Portiere / Meno Gol Subiti (goalsConceded - lower is better)
    
    **Client component (stats-page-client.tsx):**
    ```typescript
    const { scorers, assisters, appearances, wins, losses, rated, goalsConceded, isLoading } = useTeamLeaderboards(teamId)
    
    // Show loading skeletons while fetching
    // Show 7 PlayerLeaderboard components
    // Handle empty states for each
    ```
    
    **Add translations to messages/it.json:**
    ```json
    "statistics": {
      "title": "Statistiche",
      "top_scorers": "Top Marcatori",
      "top_assists": "Top Assist",
      "top_appearances": "Top Presenze",
      "top_wins": "Top Vittorie",
      "top_losses": "Top Sconfitte",
      "top_rated": "Top MVP",
      "best_goalkeeper": "Miglior Portiere",
      "goals_conceded": "Gol Subiti",
      "goals": "Gol",
      "assists": "Assist",
      "appearances": "Presenze",
      "wins": "Vittorie",
      "losses": "Sconfitte",
      "draws": "Pareggi",
      "avg_rating": "Media Voto",
      "no_data": "Nessun dato disponibile",
      "player_profile": "Profilo Giocatore",
      "back_to_roster": "Torna alla Rosa",
      "primary_role": "Ruolo principale",
      "other_roles": "Altri ruoli",
      "none": "Nessuno",
      "jersey_number": "Numero maglia"
    }
    ```
    
    **Add English translations to messages/en.json**
  </action>
  <verify>
    npx tsc --noEmit succeeds
    ls app/[locale]/teams/[teamId]/stats/page.tsx exists
    grep "statistics" messages/it.json shows complete translations
  </verify>
  <done>
    Team statistics page shows 7 leaderboards (top 3 each)
    Goals conceded leaderboard shows best GK first
    Italian and English translations complete
  </done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` to verify TypeScript compilation
2. Verify player profile page shows all stats including goals_conceded for GK
3. Verify team stats page shows 7 leaderboards
4. Verify all leaderboards show top 3
5. Verify goals conceded leaderboard shows lowest first
6. Verify Italian translations are correct
</verification>

<success_criteria>
- usePlayerStats hook fetches player statistics including goals_conceded
- PlayerStatsCard shows goals conceded only for goalkeepers
- Player profile page accessible from Roster with full stats
- Team statistics page shows 7 leaderboards (top 3 each)
- Goals conceded leaderboard: fewer = better position
- Italian and English translations complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-post-match-statistics/05-02-SUMMARY.md`
</output>
