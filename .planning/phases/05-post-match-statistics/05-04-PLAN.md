---
phase: 05-post-match-statistics
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - components/navigation/team-nav.tsx
  - components/dashboard/team-stats-section.tsx
  - app/[locale]/teams/[teamId]/page.tsx
  - app/[locale]/teams/[teamId]/history/match-history-page-client.tsx
  - lib/db/statistics.ts
  - messages/it.json
  - messages/en.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Statistics accessible from team navigation"
    - "Team overview shows quick stats summary"
    - "Match history displays match-level statistics"
    - "Dashboard shows statistics highlights"
  artifacts:
    - path: "components/navigation/team-nav.tsx"
      provides: "Stats navigation link"
      contains: "Statistiche"
    - path: "components/dashboard/team-stats-section.tsx"
      provides: "Dashboard statistics widget"
      contains: "TeamRecordBadge"
  key_links:
    - from: "team-nav.tsx"
      to: "teams/[teamId]/stats"
      via: "navigation link"
      pattern: "/stats"
    - from: "team-stats-section.tsx"
      to: "useTeamStatsSummary"
      via: "hook import"
      pattern: "useTeamStatsSummary"
---

<objective>
Integrate statistics into team navigation, dashboard, and match history. Add player statistics to match history display.

Purpose: Make statistics visible and accessible throughout the app, connecting all Phase 5 features.
Output: Stats navigation link, dashboard stats section, match history statistics, updated team overview.
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Dependencies from Plans 01-03
@lib/db/statistics.ts
@hooks/use-statistics.ts
@components/statistics/team-record-badge.tsx
@components/statistics/player-leaderboard.tsx
@components/matches/match-photo-gallery.tsx

# Existing files to modify
@components/navigation/team-nav.tsx
@components/matches/match-history-card.tsx
@components/matches/completed-match-detail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Statistics tab to team navigation</name>
  <files>components/navigation/team-nav.tsx, messages/it.json, messages/en.json</files>
  <action>
    Add a "Statistiche" (Statistics) tab to the team navigation component:
    
    **Update components/navigation/team-nav.tsx:**
    - Add a new navigation item for Statistics
    - Place it after "Cronologia" (History) and before "Rosa" (Roster)
    - Link to `/teams/[teamId]/stats`
    - Use BarChart3 or TrendingUp icon from lucide-react
    
    **Current navigation order (update):**
    1. Panoramica (Overview) - House icon
    2. Partite (Matches) - Calendar icon
    3. Cronologia (History) - Clock icon
    4. **Statistiche (Statistics) - BarChart3 icon**  ← NEW
    5. Rosa (Roster) - Users icon
    6. Impostazioni (Settings) - Settings icon (admin only)
    
    **Add translations:**
    ```json
    // it.json - navigation section
    "statistics": "Statistiche"
    
    // en.json
    "statistics": "Statistics"
    ```
  </action>
  <verify>
    npx tsc --noEmit succeeds
    grep "stats" components/navigation/team-nav.tsx shows stats link
    grep "BarChart3" components/navigation/team-nav.tsx shows icon import
  </verify>
  <done>
    Statistics tab added to team navigation
    Navigation order: Overview, Matches, History, Statistics, Roster, Settings
    Italian and English translations added
  </done>
</task>

<task type="auto">
  <name>Task 2: Add statistics summary to team overview</name>
  <files>app/[locale]/teams/[teamId]/page.tsx, components/dashboard/team-stats-section.tsx</files>
  <action>
    Add a statistics summary section to the team overview/dashboard:
    
    **Create components/dashboard/team-stats-section.tsx:**
    - Quick stats widget showing team record and key metrics
    - Compact design for dashboard embedding
    
    **Props:**
    ```typescript
    interface TeamStatsSectionProps {
      teamId: string
      className?: string
    }
    ```
    
    **Content:**
    - TeamRecordBadge at the top
    - Quick stats in a 2x2 grid:
      - Goals Scored (total)
      - Goals Conceded (total)
      - Avg Goals/Match
      - Total Matches
    - Link to full stats page
    
    **Implementation:**
    ```tsx
    export function TeamStatsSection({ teamId, className }: TeamStatsSectionProps) {
      const { summary, isLoading } = useTeamStatsSummary(teamId)
      
      if (isLoading) {
        return <Skeleton className="h-32" />
      }
      
      if (!summary) return null
      
      return (
        <Card className={className}>
          <CardHeader className="pb-2">
            <div className="flex items-center justify-between">
              <CardTitle className="text-lg">Statistiche</CardTitle>
              <Link href={`/teams/${teamId}/stats`} className="text-sm text-primary">
                Vedi tutto →
              </Link>
            </div>
          </CardHeader>
          <CardContent>
            <TeamRecordBadge 
              wins={summary.record.wins} 
              losses={summary.record.losses} 
              draws={summary.record.draws}
              showLabel 
            />
            <div className="grid grid-cols-2 gap-2 mt-3 text-sm">
              <div className="flex justify-between">
                <span className="text-muted-foreground">Gol Fatti:</span>
                <span className="font-medium">{summary.total_goals_scored}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Gol Subiti:</span>
                <span className="font-medium">{summary.total_goals_conceded}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Media Gol:</span>
                <span className="font-medium">{summary.goals_per_match.toFixed(2)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Partite:</span>
                <span className="font-medium">{summary.record.total_matches}</span>
              </div>
            </div>
          </CardContent>
        </Card>
      )
    }
    ```
    
    **Update app/[locale]/teams/[teamId]/page.tsx:**
    - Import and add TeamStatsSection to the team overview
    - Place it after upcoming matches section
    - Only show if team has completed matches (check summary.record.total_matches > 0)
  </action>
  <verify>
    npx tsc --noEmit succeeds
    ls components/dashboard/team-stats-section.tsx exists
    grep "TeamStatsSection" app/[locale]/teams/[teamId]/page.tsx shows integration
  </verify>
  <done>
    TeamStatsSection component created
    Shows team record and quick stats
    Integrated into team overview page
  </done>
</task>

<task type="auto">
  <name>Task 3: Add match statistics to history cards</name>
  <files>components/matches/match-history-card.tsx, lib/db/statistics.ts</files>
  <action>
    Enhance match history cards to show per-match statistics:
    
    **Update components/matches/match-history-card.tsx:**
    - Add goal scorers display (show top 2-3 scorers)
    - Add match photo indicator (camera icon if photos exist)
    - Show result with color coding (already implemented, verify)
    
    **Add to the card:**
    - After score display, show scorers:
      - "Rossi 23', 67' | Verdi 45'" (compact format)
      - Limit to 2-3 players, add "+N altri" if more
    - Camera icon badge if photos exist:
      - `<Camera className="h-4 w-4" />` with count overlay
    
    **Implementation additions:**
    ```tsx
    // In MatchHistoryCardProps
    interface MatchHistoryCardProps {
      match: Match
      result: 'win' | 'loss' | 'draw'
      scorers?: { name: string; count: number }[]  // NEW
      hasPhotos?: boolean  // NEW
      photoCount?: number  // NEW
    }
    
    // In the card JSX
    {scorers && scorers.length > 0 && (
      <div className="text-xs text-muted-foreground mt-1">
        {scorers.slice(0, 2).map(s => s.name).join(', ')}
        {scorers.length > 2 && ` +${scorers.length - 2} altri`}
      </div>
    )}
    
    {hasPhotos && (
      <div className="absolute top-2 right-2 flex items-center gap-1 bg-black/50 rounded-full px-2 py-0.5">
        <Camera className="h-3 w-3 text-white" />
        <span className="text-xs text-white">{photoCount}</span>
      </div>
    )}
    ```
    
    **Update lib/db/statistics.ts:**
    - Add `getMatchScorers(matchId: string)` function
    - Returns array of { name, count } for top scorers in a match
  </action>
  <verify>
    npx tsc --noEmit succeeds
    grep "scorers" components/matches/match-history-card.tsx shows scorers display
    grep "getMatchScorers" lib/db/statistics.ts shows new function
  </verify>
  <done>
    Match history cards show top scorers
    Photo indicator badge added
    getMatchScorers function added to statistics.ts
  </done>
</task>

<task type="auto">
  <name>Task 4: Add player stats to match history page</name>
  <files>app/[locale]/teams/[teamId]/history/match-history-page-client.tsx</files>
  <action>
    Update the match history page client component to fetch and pass statistics data:
    
    **Update app/[locale]/teams/[teamId]/history/match-history-page-client.tsx:**
    
    1. Import getMatchScorers and getMatchPhotos
    2. For each completed match, fetch:
       - Top 3 scorers for the match
       - Photo count
    3. Pass this data to MatchHistoryCard
    
    **Implementation:**
    ```tsx
    // Fetch enhanced data for completed matches
    const enhancedMatches = await Promise.all(
      completedMatches.map(async (match) => {
        const scorers = await getMatchScorers(match.id)
        const photos = await getMatchPhotos(match.id)
        return {
          ...match,
          scorers: scorers.slice(0, 3),
          hasPhotos: photos.length > 0,
          photoCount: photos.length,
        }
      })
    )
    ```
    
    **Alternative (client-side):**
    If server-side fetching is too slow, add a useMatchEnhancements hook that fetches scorer data for visible matches (using IntersectionObserver for lazy loading).
  </action>
  <verify>
    npx tsc --noEmit succeeds
    grep "scorers\|hasPhotos" app/[locale]/teams/[teamId]/history/match-history-page-client.tsx shows data fetching
  </verify>
  <done>
    Match history page fetches scorer data
    Photo indicators displayed on cards
    Enhanced match cards show statistics
  </done>
</task>

<task type="auto">
  <name>Task 5: Add translations and final integration</name>
  <files>messages/it.json, messages/en.json</files>
  <action>
    Add remaining translations for statistics integration:
    
    **Add to messages/it.json:**
    ```json
    "statistics": {
      "title": "Statistiche",
      "record": "Record",
      "wins": "Vittorie",
      "losses": "Perse",
      "draws": "Pareggiate",
      "wins_short": "V",
      "losses_short": "P",
      "draws_short": "S",
      "goals_scored": "Gol Fatti",
      "goals_conceded": "Gol Subiti",
      "goals_per_match": "Media Gol/Partita",
      "avg_rating": "Media Voto",
      "total_matches": "Partite Totali",
      "top_scorers": "Marcatori",
      "top_assisters": "Assist",
      "top_rated": "Miglior Media",
      "top_goalkeepers": "Portieri",
      "saves": "Paratie",
      "goals": "Gol",
      "assists": "Assist",
      "appearances": "Presenze",
      "no_data": "Nessun dato disponibile",
      "see_all": "Vedi tutto",
      "others": "altri"
    }
    ```
    
    **Add to messages/en.json:**
    ```json
    "statistics": {
      "title": "Statistics",
      "record": "Record",
      "wins": "Wins",
      "losses": "Losses",
      "draws": "Draws",
      "wins_short": "W",
      "losses_short": "L",
      "draws_short": "D",
      "goals_scored": "Goals Scored",
      "goals_conceded": "Goals Conceded",
      "goals_per_match": "Goals per Match",
      "avg_rating": "Average Rating",
      "total_matches": "Total Matches",
      "top_scorers": "Top Scorers",
      "top_assisters": "Top Assists",
      "top_rated": "Best Average",
      "top_goalkeepers": "Goalkeepers",
      "saves": "Saves",
      "goals": "Goals",
      "assists": "Assists",
      "appearances": "Appearances",
      "no_data": "No data available",
      "see_all": "See all",
      "others": "others"
    }
    ```
    
    **Verify all components use translations:**
    - TeamStatsSection uses useTranslations('statistics')
    - PlayerStatsCard uses translations
    - PlayerLeaderboard uses translations
    - MatchHistoryCard uses translations for photo count
  </action>
  <verify>
    npx tsc --noEmit succeeds
    grep "statistics" messages/it.json shows complete translations
    grep "statistics" messages/en.json shows complete translations
  </verify>
  <done>
    All statistics translations added to it.json and en.json
    Components properly use translations
</action>
  </done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` to verify TypeScript compilation
2. Verify Statistics tab appears in team navigation
3. Verify TeamStatsSection shows on team overview
4. Verify match history cards show scorers and photo indicators
5. Verify statistics page is accessible from navigation
6. Verify all Italian translations are correct
</verification>

<success_criteria>
- Statistics tab added to team navigation (after History)
- TeamStatsSection displays record and quick stats on overview
- Match history cards show top scorers and photo indicators
- All statistics features accessible and functional
- Italian and English translations complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-post-match-statistics/05-04-SUMMARY.md`
</output>
