---
phase: 05-post-match-statistics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - lib/db/statistics.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Goalkeeper saves are tracked per match"
    - "Player career statistics can be queried (goals, assists, appearances)"
    - "Team win/loss/draw record can be calculated"
    - "Statistics queries work for completed matches"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Database schema with saves and photos fields"
      contains: "saves Int"
    - path: "lib/db/statistics.ts"
      provides: "Statistics aggregation functions"
      exports: ["getPlayerStats", "getTeamRecord", "getTopScorers", "getTopAssisters", "getTeamStatsSummary"]
  key_links:
    - from: "lib/db/statistics.ts"
      to: "prisma.goal"
      via: "aggregation queries"
      pattern: "prisma\\.goal\\.count"
    - from: "lib/db/statistics.ts"
      to: "prisma.matchPlayer"
      via: "saves and appearances"
      pattern: "prisma\\.matchPlayer"
---

<objective>
Add goalkeeper saves tracking to the database and implement statistics aggregation functions for player and team statistics.

Purpose: Enable the app to track goalkeeper performance and calculate career statistics, team records, and leaderboards.
Output: Updated Prisma schema with saves field, new statistics.ts with aggregation queries.
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-post-match-statistics/05-RESEARCH.md

# Existing patterns from Phase 4
@lib/db/goals.ts
@lib/db/player-ratings.ts
@lib/db/player-participation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add goalkeeper saves field to MatchPlayer schema</name>
  <files>prisma/schema.prisma</files>
  <action>
    Add a `saves` field to the MatchPlayer model in prisma/schema.prisma:
    
    ```prisma
    model MatchPlayer {
      // ... existing fields ...
      saves     Int      @default(0) @map("saves")  // Goalkeeper saves
      // ... rest of model ...
    }
    ```
    
    The field should:
    - Be an Int with default value 0
    - Map to database column "saves"
    - Track goalkeeper saves per match per player
    - Only be relevant for players with goalkeeper role (handled in UI, not enforced at DB level)
    
    After modifying the schema, run `npx prisma db push` to apply the migration.
    
    Do NOT add photos field to Match yet - that will be done in Plan 03.
  </action>
  <verify>
    npx prisma generate succeeds
    npx prisma db push succeeds
    grep -n "saves.*Int.*default" prisma/schema.prisma shows the new field
  </verify>
  <done>
    MatchPlayer model has saves: Int @default(0) field
    Database schema updated via prisma db push
    Prisma client regenerated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create statistics aggregation module</name>
  <files>lib/db/statistics.ts</files>
  <action>
    Create lib/db/statistics.ts with the following aggregation functions. Follow the patterns from lib/db/goals.ts and lib/db/player-ratings.ts:
    
    **Type definitions:**
    ```typescript
    export interface PlayerStats {
      player_id: string
      player_name: string
      player_surname?: string
      player_nickname?: string
      player_avatar?: string
      goals: number
      assists: number
      appearances: number
      saves: number
      avg_rating: number | null
      total_ratings: number
    }
    
    export interface TeamRecord {
      wins: number
      losses: number
      draws: number
      total_matches: number
    }
    
    export interface TeamStatsSummary {
      record: TeamRecord
      total_goals_scored: number
      total_goals_conceded: number
      goals_per_match: number
      avg_team_rating: number | null
    }
    
    export interface PlayerLeaderboardEntry {
      player_id: string
      player_name: string
      player_nickname?: string
      player_avatar?: string
      value: number
      secondary_value?: number
    }
    ```
    
    **Functions to implement:**
    
    1. `getPlayerStats(playerId: string, teamId?: string): Promise<PlayerStats | null>`
       - Count goals from Goal where scorerId = playerId (exclude own goals)
       - Count assists from Goal where assisterId = playerId
       - Count appearances from MatchPlayer where played = true in COMPLETED matches
       - Sum saves from MatchPlayer
       - Calculate average rating from PlayerRating in COMPLETED matches
       - Join with Player for name/avatar details
       - If teamId provided, filter stats to that team only
    
    2. `getTeamRecord(teamId: string): Promise<TeamRecord>`
       - Query COMPLETED matches for the team
       - Count wins (homeScore > awayScore), losses (homeScore < awayScore), draws (equal)
       - Return { wins, losses, draws, total_matches }
    
    3. `getTeamStatsSummary(teamId: string): Promise<TeamStatsSummary>`
       - Get team record using getTeamRecord
       - Sum all homeScore for total_goals_scored
       - Sum all awayScore for total_goals_conceded
       - Calculate goals_per_match = total_goals_scored / total_matches
       - Calculate avg_team_rating from all PlayerRatings for team's matches
    
    4. `getTopScorers(teamId: string, limit?: number): Promise<PlayerLeaderboardEntry[]>`
       - Query goals scored (exclude own goals) for players in team
       - Group by player, count goals
       - Order by goals desc, return top N (default 5)
       - Include player name, nickname, avatar
    
    5. `getTopAssisters(teamId: string, limit?: number): Promise<PlayerLeaderboardEntry[]>`
       - Query assists from Goal where assisterId IS NOT NULL
       - Group by player, count assists
       - Order by assists desc, return top N (default 5)
    
    6. `getTopRatedPlayers(teamId: string, limit?: number): Promise<PlayerLeaderboardEntry[]>`
       - Query PlayerRatings for players in team's matches
       - Calculate average rating per player
       - Order by avg rating desc, return top N (default 5)
       - Only include players with at least 3 ratings (minimum sample size)
    
    7. `getTopGoalkeepers(teamId: string, limit?: number): Promise<PlayerLeaderboardEntry[]>`
       - Query saves from MatchPlayer where saves > 0
       - Filter to players with goalkeeper role (check player.roles array)
       - Sum saves per player
       - Order by saves desc, return top N (default 3)
    
    **Implementation notes:**
    - Use Prisma's aggregation features where possible ($queryRaw for complex queries)
    - Use MatchStatus.COMPLETED for all statistics (only completed matches count)
    - Handle null cases gracefully (no matches, no ratings, etc.)
    - Follow the error message pattern with Italian messages
    - Use 'use server' at the top since these are server actions
  </action>
  <verify>
    npx tsc --noEmit succeeds
    grep -n "getPlayerStats\|getTeamRecord\|getTopScorers" lib/db/statistics.ts shows all functions
  </verify>
  <done>
    lib/db/statistics.ts created with 7 exported functions
    All functions properly typed with TypeScript
    Statistics queries use only COMPLETED matches
  </done>
</task>

<task type="auto">
  <name>Task 3: Add goalkeeper saves to rating flow</name>
  <files>lib/db/player-ratings.ts, hooks/use-player-ratings.ts, components/matches/rating-selector.tsx</files>
  <action>
    Extend the rating system to include goalkeeper saves input. Modify existing files:
    
    **1. lib/db/player-ratings.ts:**
    - Update `RatingInput` interface to include optional `saves?: number`
    - Update `upsertPlayerRating` to also update MatchPlayer.saves if saves provided
    - Only allow saves input for players with 'goalkeeper' in their roles
    
    **2. hooks/use-player-ratings.ts:**
    - Update `useUpsertRating` to accept saves parameter
    - Pass saves through to the server action
    
    **3. components/matches/rating-selector.tsx:**
    - Check if player has 'goalkeeper' role (from player.roles array)
    - If goalkeeper, show an additional saves input (number input, min 0)
    - Place saves input below the rating selector
    - Label: "Paratie" (Saves in Italian)
    - Include saves in the onSubmit callback
    
    **Error handling:**
    - Invalid saves (negative numbers): "Il numero di paratie non pu√≤ essere negativo"
  </action>
  <verify>
    npx tsc --noEmit succeeds
    grep -n "saves" lib/db/player-ratings.ts shows saves handling
    grep -n "goalkeeper" components/matches/rating-selector.tsx shows conditional saves input
  </verify>
  <done>
    RatingInput accepts optional saves parameter
    upsertPlayerRating updates MatchPlayer.saves when provided
    RatingSelector shows saves input only for goalkeepers
  </done>
</task>

</tasks>

<verification>
1. Run `npx prisma generate` to regenerate Prisma client
2. Run `npx tsc --noEmit` to verify TypeScript compilation
3. Verify statistics.ts exports all required functions
4. Verify saves field exists in MatchPlayer model
5. Verify rating flow accepts saves for goalkeepers
</verification>

<success_criteria>
- MatchPlayer.saves field exists in database schema
- lib/db/statistics.ts provides aggregation queries for player and team stats
- getTeamRecord calculates W/L/D from completed matches
- getTopScorers/Assisters/RatedPlayers return leaderboards
- Goalkeeper saves can be entered during rating flow
</success_criteria>

<output>
After completion, create `.planning/phases/05-post-match-statistics/05-01-SUMMARY.md`
</output>
