---
phase: 05-post-match-statistics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/statistics.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Player career statistics can be queried (goals, assists, appearances, avg rating)"
    - "Statistics queries work for completed matches"
    - "Leaderboards show top performers"
  artifacts:
    - path: "lib/db/statistics.ts"
      provides: "Statistics aggregation functions for individual players"
      exports: ["getPlayerStats", "getTopScorers", "getTopAssisters", "getTopRatedPlayers"]
  key_links:
    - from: "lib/db/statistics.ts"
      to: "prisma.goal"
      via: "aggregation queries"
      pattern: "prisma\\.goal"
    - from: "lib/db/statistics.ts"
      to: "prisma.playerRating"
      via: "rating aggregation"
      pattern: "prisma\\.playerRating"
---

<objective>
Implement statistics aggregation functions for individual player statistics.

Purpose: Enable the app to calculate and display career statistics per player (goals, assists, appearances, average rating).
Output: lib/db/statistics.ts with aggregation queries.
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns from Phase 4
@lib/db/goals.ts
@lib/db/player-ratings.ts
@lib/db/player-participation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create statistics aggregation module</name>
  <files>lib/db/statistics.ts</files>
  <action>
    Create lib/db/statistics.ts with aggregation functions for player statistics. Follow the patterns from lib/db/goals.ts and lib/db/player-ratings.ts:
    
    **Type definitions:**
    ```typescript
    export interface PlayerStats {
      player_id: string
      player_name: string
      player_surname?: string
      player_nickname?: string
      player_avatar?: string
      goals: number
      assists: number
      appearances: number
      avg_rating: number | null
      total_ratings: number
    }
    
    export interface PlayerLeaderboardEntry {
      player_id: string
      player_name: string
      player_nickname?: string
      player_avatar?: string
      value: number
      secondary_value?: number
    }
    ```
    
    **Functions to implement:**
    
    1. `getPlayerStats(playerId: string, teamId?: string): Promise<PlayerStats | null>`
       - Count goals from Goal where scorerId = playerId (exclude own goals)
       - Count assists from Goal where assisterId = playerId
       - Count appearances from MatchPlayer where played = true in COMPLETED matches
       - Calculate average rating from PlayerRating in COMPLETED matches
       - Join with Player for name/avatar details
       - If teamId provided, filter stats to that team only
    
    2. `getTopScorers(teamId: string, limit?: number): Promise<PlayerLeaderboardEntry[]>`
       - Query goals scored (exclude own goals) for players in team
       - Group by player, count goals
       - Order by goals desc, return top N (default 5)
       - Include player name, nickname, avatar
    
    3. `getTopAssisters(teamId: string, limit?: number): Promise<PlayerLeaderboardEntry[]>`
       - Query assists from Goal where assisterId IS NOT NULL
       - Group by player, count assists
       - Order by assists desc, return top N (default 5)
    
    4. `getTopRatedPlayers(teamId: string, limit?: number): Promise<PlayerLeaderboardEntry[]>`
       - Query PlayerRatings for players in team's matches
       - Calculate average rating per player
       - Order by avg rating desc, return top N (default 5)
       - Only include players with at least 3 ratings (minimum sample size)
    
    **Implementation notes:**
    - Use Prisma's aggregation features where possible
    - Use MatchStatus.COMPLETED for all statistics (only completed matches count)
    - Handle null cases gracefully (no matches, no ratings, etc.)
    - Follow the error message pattern with Italian messages
    - Use 'use server' at the top since these are server actions
  </action>
  <verify>
    npx tsc --noEmit succeeds
    grep -n "getPlayerStats\|getTopScorers\|getTopAssisters\|getTopRatedPlayers" lib/db/statistics.ts shows all functions
  </verify>
  <done>
    lib/db/statistics.ts created with 4 exported functions
    All functions properly typed with TypeScript
    Statistics queries use only COMPLETED matches
  </done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` to verify TypeScript compilation
2. Verify statistics.ts exports all required functions
3. Verify getPlayerStats returns goals, assists, appearances, avg_rating
</verification>

<success_criteria>
- lib/db/statistics.ts provides aggregation queries for player statistics
- getPlayerStats returns individual player stats (goals, assists, appearances, avg rating)
- getTopScorers/Assisters/RatedPlayers return leaderboards for team
- All queries filter to COMPLETED matches only
</success_criteria>

<output>
After completion, create `.planning/phases/05-post-match-statistics/05-01-SUMMARY.md`
</output>
