---
phase: 04-live-match-experience
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified: [
  "supabase/migrations/20260217000004_live_match.sql",
  "lib/db/schema.ts",
  "lib/db/index.ts",
  "types/database.ts"
]
autonomous: true

must_haves:
  truths:
    - "Match timer state can be stored (started_at, paused_at, elapsed_seconds)"
    - "Match events can be stored (goals, assists, cards with timestamps)"
    - "Events are linked to players and include client-generated UUIDs"
    - "RLS policies allow match participants to record events"
  artifacts:
    - path: "supabase/migrations/20260217000004_live_match.sql"
      provides: "match_timers and match_events tables with RLS"
      min_tables: 2
    - path: "lib/db/schema.ts"
      provides: "MatchEvent and MatchTimer IndexedDB interfaces"
      contains: ["interface MatchEvent", "interface MatchTimer"]
    - path: "lib/db/index.ts"
      provides: "DB_VERSION 4 with match_events store"
      pattern: "DB_VERSION = 4"
  key_links:
    - from: "match_timers.match_id"
      to: "matches.id"
      via: "FOREIGN KEY"
    - from: "match_events.match_id"
      to: "matches.id"
      via: "FOREIGN KEY"
    - from: "match_events.player_id"
      to: "players.id"
      via: "FOREIGN KEY"
---

<objective>
Create database schema for live match tracking including match timers and event recording (goals, assists, cards).

Purpose: Enable storage of live match state and events with proper relationships to existing match/player entities.
Output: Supabase migration with match_timers and match_events tables, IndexedDB schema v4, updated TypeScript types.
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md (Phase 4 requirements)
@.planning/phases/04-live-match-experience/04-RESEARCH.md (Architecture patterns)
@.planning/phases/03-match-management/03-01-SUMMARY.md (Match database patterns)
@supabase/migrations/20260215000002_matches_rsvps_formations.sql (Existing match tables)
@lib/db/schema.ts (Existing IndexedDB schema v3)
@lib/db/index.ts (DB_VERSION 3 initialization)
@types/database.ts (Supabase types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase migration for live match tables</name>
  <files>supabase/migrations/20260217000004_live_match.sql</files>
  <action>
    Create database migration with two tables:

    1. match_timers table:
       - match_id (UUID, PK, FK to matches)
       - started_at (TIMESTAMPTZ, nullable) - when timer first started
       - paused_at (TIMESTAMPTZ, nullable) - when timer was paused
       - total_elapsed_seconds (INTEGER, default 0) - accumulated time before current run
       - is_running (BOOLEAN, default false)
       - updated_by (UUID, FK to users) - last user to modify timer
       - updated_at (TIMESTAMPTZ, default now())

    2. match_events table:
       - id (UUID, PK) - client-generated for offline support
       - match_id (UUID, FK to matches)
       - event_type (TEXT with CHECK: 'goal', 'assist', 'yellow_card', 'red_card', 'own_goal', 'penalty')
       - player_id (UUID, FK to players) - primary player
       - player_id_secondary (UUID, FK to players, nullable) - for assists (who assisted) or substituted player
       - team_id (UUID, FK to teams) - which team scored/received card
       - match_time_seconds (INTEGER) - elapsed match time when event occurred
       - match_time_display (TEXT) - formatted MM:SS for display
       - recorded_by (UUID, FK to users) - who recorded the event
       - timestamp (TIMESTAMPTZ, default now()) - server timestamp
       - client_timestamp (TIMESTAMPTZ) - client timestamp for ordering
       - metadata (JSONB, nullable) - event-specific data (body_part, goal_type, card_reason)
       - sync_status (TEXT, default 'synced') - for optimistic updates tracking

    3. RLS policies:
       - Enable RLS on both tables
       - Allow SELECT for match participants (team members of match's team)
       - Allow INSERT/UPDATE for match participants (record events, control timer)
       - Use is_match_participant() helper similar to existing is_match_admin()

    4. Realtime publication:
       - Enable realtime for both tables
       - This enables Supabase Realtime to broadcast changes

    5. Indexes:
       - match_events: by match_id, by player_id, by event_type, by timestamp
       - match_timers: by match_id (already PK)
  </action>
  <verify>File exists with both tables, RLS policies, realtime enabled, and proper foreign keys</verify>
  <done>Migration file created with complete schema for match timers and events</done>
</task>

<task type="auto">
  <name>Task 2: Add MatchEvent and MatchTimer types to IndexedDB schema</name>
  <files>lib/db/schema.ts, lib/db/index.ts</files>
  <action>
    Update lib/db/schema.ts:

    1. Add MatchEventType enum:
       ```typescript
       export type MatchEventType = 'goal' | 'assist' | 'yellow_card' | 'red_card' | 'own_goal' | 'penalty';
       ```

    2. Add MatchEvent interface:
       ```typescript
       export interface MatchEvent {
         id: string;                    // UUID, client-generated
         match_id: string;
         event_type: MatchEventType;
         player_id: string;
         player_id_secondary?: string;  // For assists, substitutions
         team_id: string;
         match_time_seconds: number;
         match_time_display: string;    // MM:SS format
         timestamp: string;             // ISO 8601
         client_timestamp: string;      // Client timestamp for ordering
         metadata?: {
           body_part?: 'left_foot' | 'right_foot' | 'head' | 'other';
           goal_type?: 'open_play' | 'penalty' | 'free_kick' | 'corner';
           card_reason?: string;
         };
         recorded_by: string;
         sync_status: SyncStatus;
       }
       ```

    3. Add MatchTimer interface:
       ```typescript
       export interface MatchTimer {
         match_id: string;
         started_at: string | null;
         paused_at: string | null;
         total_elapsed_seconds: number;
         is_running: boolean;
         updated_by: string;
         updated_at: string;
         sync_status: SyncStatus;
       }
       ```

    4. Update CalcettoDB schema to include new stores:
       ```typescript
       match_events: {
         key: string;
         value: MatchEvent;
         indexes: {
           'by-match-id': string;
           'by-player-id': string;
           'by-event-type': string;
           'by-sync-status': string;
         };
       };
       match_timers: {
         key: string;
         value: MatchTimer;
         indexes: {};
       };
       ```

    5. Update lib/db/index.ts:
       - Change DB_VERSION from 3 to 4
       - Add upgrade logic from v3 to v4 creating match_events and match_timers stores
       - Add indexes for match_events store

    6. Update OfflineTable type to include 'match_events' and 'match_timers'
  </action>
  <verify>schema.ts exports MatchEvent and MatchTimer; index.ts has DB_VERSION = 4 with upgrade logic</verify>
  <done>IndexedDB schema v4 with match_events and match_timers stores</done>
</task>

<task type="auto">
  <name>Task 3: Update Supabase TypeScript types</name>
  <files>types/database.ts</files>
  <action>
    Add TypeScript types for the new tables in types/database.ts:

    1. Add match_timers table type with Row/Insert/Update interfaces
    2. Add match_events table type with Row/Insert/Update interfaces
    3. Include all columns from the SQL migration
    4. Add proper Relationships entries for foreign keys
    5. Follow existing pattern from matches and match_players tables

    Key fields to include:
    - match_timers: match_id, started_at, paused_at, total_elapsed_seconds, is_running, updated_by, updated_at
    - match_events: id, match_id, event_type, player_id, player_id_secondary, team_id, match_time_seconds, match_time_display, recorded_by, timestamp, client_timestamp, metadata, sync_status
  </action>
  <verify>types/database.ts contains match_timers and match_events table definitions with proper types</verify>
  <done>TypeScript types updated for new database tables</done>
</task>

</tasks>

<verification>
- Migration file can be applied: `supabase db push` (dry run check)
- IndexedDB schema creates stores without errors
- TypeScript types compile without errors
- Foreign key relationships properly defined
</verification>

<success_criteria>
1. supabase/migrations/20260217000004_live_match.sql exists with match_timers and match_events tables
2. lib/db/schema.ts exports MatchEvent and MatchTimer interfaces
3. lib/db/index.ts has DB_VERSION = 4 with upgrade logic
4. types/database.ts includes types for new tables
5. All files follow existing code patterns from Phase 3
</success_criteria>

<output>
After completion, create `.planning/phases/04-live-match-experience/04-01-SUMMARY.md`
</output>
