---
phase: 04-match-results-ratings
plan: "04"
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [
  "lib/db/player-participation.ts",
  "hooks/use-player-participation.ts",
  "components/matches/player-participation-list.tsx"
]
autonomous: true

must_haves:
  truths:
    - "Admin can mark which players actually played in the match"
    - "Only players with played=true can be rated"
    - "Default played=true for players with RSVP status 'in'"
    - "Admin can toggle played status per player"
  artifacts:
    - path: "lib/db/player-participation.ts"
      provides: "updatePlayerParticipation, getMatchParticipants"
      exports: ["updatePlayerParticipation", "getMatchParticipants", "bulkUpdateParticipation"]
    - path: "components/matches/player-participation-list.tsx"
      provides: "UI to mark who played"
  key_links:
    - from: "player-participation.ts"
      to: "MatchPlayer.played"
      via: "Prisma update"
    - from: "played=true"
      to: "PlayerRating"
      via: "prerequisite for rating"
---

<objective>
Implement player participation tracking - mark which players actually played.

Purpose: Enable admin to distinguish between RSVP'd and actually played, as only played players can be rated.
Output: Participation update functions, UI to toggle played status per player.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-live-match-experience/04-CONTEXT.md
@.planning/phases/04-live-match-experience/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create player participation functions</name>
  <files>lib/db/player-participation.ts</files>
  <action>
    Create lib/db/player-participation.ts:
    
    ```typescript
    'use server'
    
    import { auth } from '@/lib/auth'
    import { prisma } from '@/lib/db'
    
    // Update single player's played status
    export async function updatePlayerParticipation(
      matchId: string,
      playerId: string,
      played: boolean
    ): Promise<MatchPlayer>
    
    // Get all match participants with their played status
    export async function getMatchParticipants(matchId: string): Promise<MatchPlayerWithPlayer[]>
    
    // Bulk update played status (for initial setup or batch edits)
    export async function bulkUpdateParticipation(
      matchId: string,
      updates: Array<{ playerId: string; played: boolean }>
    ): Promise<void>
    
    // Initialize played=true for all RSVP 'in' players (call when match ends)
    export async function initializeParticipation(matchId: string): Promise<void>
    ```
    
    getMatchParticipants should return player details (name, avatar, jersey number) alongside match player data.
    
    initializeParticipation sets played=true for all players with rsvp_status='in' when match transitions to finished.
  </action>
  <verify>npm run build passes</verify>
  <done>Participation functions update and fetch played status</done>
</task>

<task type="auto">
  <name>Task 2: Create usePlayerParticipation hook</name>
  <files>hooks/use-player-participation.ts</files>
  <action>
    Create hooks/use-player-participation.ts:
    
    ```typescript
    'use client'
    
    import { useState, useEffect } from 'react'
    import { getMatchParticipants, updatePlayerParticipation, bulkUpdateParticipation } from '@/lib/db/player-participation'
    import { useToast } from '@/hooks/use-toast'
    
    export function usePlayerParticipation(matchId: string) {
      const [participants, setParticipants] = useState<MatchPlayerWithPlayer[]>([])
      const [isLoading, setIsLoading] = useState(false)
      
      const fetchParticipants = async () => { ... }
      
      const togglePlayed = async (playerId: string, currentPlayed: boolean) => {
        // Optimistic update
        // Call updatePlayerParticipation
        // Rollback on error
      }
      
      useEffect(() => { fetchParticipants() }, [matchId])
      
      return {
        participants,
        isLoading,
        togglePlayed,
        playedPlayers: participants.filter(p => p.played),
        refresh: fetchParticipants,
      }
    }
    ```
  </action>
  <verify>npm run build passes</verify>
  <done>Hook manages participation state with optimistic updates</done>
</task>

<task type="auto">
  <name>Task 3: Create PlayerParticipationList component</name>
  <files>components/matches/player-participation-list.tsx</files>
  <action>
    Create components/matches/player-participation-list.tsx:
    
    A list showing all RSVP'd players with toggle for played status:
    - Player avatar, name, jersey number
    - RSVP status badge (IN/OUT/MAYBE)
    - Toggle switch or checkbox for "played"
    - Grouped by RSVP status (IN first, then MAYBE, then OUT)
    
    ```typescript
    interface PlayerParticipationListProps {
      participants: MatchPlayerWithPlayer[]
      onTogglePlayed: (playerId: string, currentPlayed: boolean) => void
      canEdit: boolean  // isAdmin && match not completed
    }
    
    export function PlayerParticipationList({ participants, onTogglePlayed, canEdit }: PlayerParticipationListProps)
    ```
    
    Use shadcn/ui Switch or Checkbox for toggle.
    Visual distinction for played vs not-played (dimmed or different background).
    Show count: "X of Y players played"
  </action>
  <verify>npm run build passes</verify>
  <done>List shows players with toggleable played status</done>
</task>

<task type="auto">
  <name>Task 4: Integrate participation initialization with match lifecycle</name>
  <files>lib/db/match-lifecycle.ts</files>
  <action>
    Update lib/db/match-lifecycle.ts:
    
    In the endMatch function, after setting status to FINISHED:
    - Call initializeParticipation to set played=true for all RSVP 'in' players
    
    ```typescript
    // In endMatch function, after updating status:
    await initializeParticipation(matchId)
    ```
    
    This ensures players who RSVP'd 'in' are marked as played by default, admin can then adjust.
  </action>
  <verify>npm run build passes</verify>
  <done>endMatch initializes participation for RSVP 'in' players</done>
</task>

</tasks>

<verification>
- [ ] updatePlayerParticipation updates MatchPlayer.played
- [ ] getMatchParticipants returns players with played status
- [ ] PlayerParticipationList displays and toggles played status
- [ ] initializeParticipation sets played=true for RSVP 'in'
- [ ] endMatch calls initializeParticipation
- [ ] Toggle has optimistic update and error rollback
</verification>

<success_criteria>
Admin can manage who played:
- View all RSVP'd players
- Toggle played status per player
- Default played=true for RSVP 'in' when match ends
- Count shows how many played
</success_criteria>

<output>
After completion, create `.planning/phases/04-match-results-ratings/04-04-SUMMARY.md`
</output>
