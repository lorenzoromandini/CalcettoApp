---
phase: 04-match-results-ratings
plan: "06"
type: execute
wave: 3
depends_on: ["04-02", "04-03", "04-05"]
files_modified: [
  "app/[locale]/teams/[teamId]/history/page.tsx",
  "components/matches/match-history-card.tsx",
  "components/matches/completed-match-detail.tsx",
  "app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx",
  "components/navigation/team-nav.tsx",
  "components/dashboard/upcoming-matches-section.tsx",
  "messages/it.json",
  "messages/en.json"
]
autonomous: false
user_setup:
  - service: none
    why: "No external services required"

must_haves:
  truths:
    - "Users can view match history (completed matches)"
    - "Match history shows score, scorers, ratings, formation"
    - "Match detail page shows all info based on status"
    - "Navigation includes History tab"
    - "Dashboard shows link to history or recent completed matches"
  artifacts:
    - path: "app/[locale]/teams/[teamId]/history/page.tsx"
      provides: "Match history list page"
    - path: "components/matches/completed-match-detail.tsx"
      provides: "Read-only view of completed match"
    - path: "components/matches/match-history-card.tsx"
      provides: "Card for history list"
  key_links:
    - from: "history page"
      to: "Match where status=COMPLETED"
      via: "Prisma query"
    - from: "team-nav"
      to: "/history"
      via: "navigation link"
---

<objective>
Implement match history view and integrate all Phase 4 features into existing UI.

Purpose: Enable users to view completed matches with full details, integrate lifecycle/goals/ratings into match detail.
Output: Match history page, completed match detail view, navigation updates, integration.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-live-match-experience/04-CONTEXT.md
@.planning/phases/04-live-match-experience/04-RESEARCH.md
@components/navigation/team-nav.tsx
@app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MatchHistoryCard component</name>
  <files>components/matches/match-history-card.tsx</files>
  <action>
    Create components/matches/match-history-card.tsx:
    
    A card for displaying a completed match in history:
    
    ```typescript
    interface MatchHistoryCardProps {
      match: Match & {
        goals: Goal[]
        ratings: PlayerRating[]
        formation: Formation | null
      }
      teamId: string
    }
    
    export function MatchHistoryCard({ match, teamId }: MatchHistoryCardProps)
    ```
    
    Shows:
    - Date and opponent/location
    - Final score (homeScore - awayScore)
    - Top scorer(s) with goal count
    - Best rated player
    - Link to full details
    
    Use shadcn/ui Card with green accent for wins, red for losses, gray for draws.
  </action>
  <verify>npm run build passes</verify>
  <done>History card shows match summary</done>
</task>

<task type="auto">
  <name>Task 2: Create CompletedMatchDetail component</name>
  <files>components/matches/completed-match-detail.tsx</files>
  <action>
    Create components/matches/completed-match-detail.tsx:
    
    Read-only view of a completed match with all details:
    
    ```typescript
    interface CompletedMatchDetailProps {
      match: Match & {
        goals: (Goal & { scorer: Player; assister?: Player })[]
        ratings: (PlayerRating & { player: Player })[]
        formation: (Formation & { positions: FormationPosition[] }) | null
        players: (MatchPlayer & { player: Player })[]
      }
    }
    
    export function CompletedMatchDetail({ match }: CompletedMatchDetailProps)
    ```
    
    Sections:
    1. Header: Date, location, final score, result (W/L/D)
    2. Scorers: List of goals with scorer, assist, own-goal badge
    3. Formation: Visual pitch display (if exists)
    4. Player Ratings: All ratings sorted by score, with average
    5. Player Comments: Comments from ratings
    
    All read-only, no edit buttons.
  </action>
  <verify>npm run build passes</verify>
  <done>Detail component shows all completed match info</done>
</task>

<task type="auto">
  <name>Task 3: Create match history page</name>
  <files>app/[locale]/teams/[teamId]/history/page.tsx</files>
  <action>
    Create app/[locale]/teams/[teamId]/history/page.tsx:
    
    Page showing all completed matches for a team:
    
    ```typescript
    export default async function MatchHistoryPage({
      params
    }: {
      params: { locale: string; teamId: string }
    })
    ```
    
    Features:
    - List of completed matches, sorted by date (most recent first)
    - Filter by result (wins, losses, draws) - optional enhancement
    - Click card to view full details
    - Empty state if no completed matches
    - Pagination or infinite scroll for many matches
    
    Server component that queries:
    ```typescript
    const matches = await prisma.match.findMany({
      where: { teamId, status: 'COMPLETED' },
      include: { goals: true, ratings: true, ... },
      orderBy: { scheduledAt: 'desc' }
    })
    ```
  </action>
  <verify>npm run build passes</verify>
  <done>History page lists completed matches</done>
</task>

<task type="auto">
  <name>Task 4: Update team navigation</name>
  <files>components/navigation/team-nav.tsx</files>
  <action>
    Update components/navigation/team-nav.tsx to add History tab:
    
    Add new navigation item:
    - Label: "Cronologia" (IT) / "History" (EN)
    - Path: `/teams/[teamId]/history`
    - Icon: Calendar or Clock icon from lucide-react
    - Position: After Matches or at the end
    
    Make sure to use existing navigation patterns and translation system.
  </action>
  <verify>npm run build passes</verify>
  <done>History tab in team navigation</done>
</task>

<task type="auto">
  <name>Task 5: Update match detail page for all statuses</name>
  <files>app/[locale]/teams/[teamId]/matches/[matchId]/page.tsx</files>
  <action>
    Update the existing match detail page to show different UI based on status:
    
    - SCHEDULED: Show existing detail + RSVP + "Start Match" / "Final Results" buttons
    - IN_PROGRESS: Show score, goal list, "End Match" button
    - FINISHED: Show score, goals, "Mark who played", ratings entry, "Complete Match" button
    - COMPLETED: Show CompletedMatchDetail (read-only)
    
    Add conditional rendering based on match.status.
    Link to /results and /ratings sub-pages for FINISHED status.
    
    Keep existing RSVP and Formation sections for all applicable statuses.
  </action>
  <verify>npm run build passes</verify>
  <done>Match detail adapts to match status</done>
</task>

<task type="auto">
  <name>Task 6: Update dashboard to show recent history</name>
  <files>components/dashboard/upcoming-matches-section.tsx</files>
  <action>
    Update or create a section showing recent completed matches:
    
    Option A: Add "Recent Results" section to dashboard
    - Show last 3 completed matches
    - Score, date, link to details
    
    Option B: Modify existing upcoming matches section
    - Add a "View History" link
    
    Choose Option A for better UX.
    
    Create components/dashboard/recent-results-section.tsx if needed.
  </action>
  <verify>npm run build passes</verify>
  <done>Dashboard shows recent completed matches</done>
</task>

<task type="auto">
  <name>Task 7: Add translations for history UI</name>
  <files>messages/it.json, messages/en.json</files>
  <action>
    Add Italian and English translations:
    
    Italian:
    ```json
    "history": {
      "title": "Cronologia Partite",
      "noMatches": "Nessuna partita completata",
      "win": "Vittoria",
      "loss": "Sconfitta",
      "draw": "Pareggio",
      "recentResults": "Risultati Recenti",
      "viewAll": "Vedi tutte",
      "scorers": "Marcatori",
      "topRated": "MVP"
    }
    ```
    
    English equivalents.
  </action>
  <verify>npm run build passes</verify>
  <done>History translations added</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 4: Match Results & Player Ratings
    
    Built:
    - Match lifecycle (Start Match, End Match, Complete Match, Final Results)
    - Goal tracking (add/remove goals with scorer, assist, own-goal)
    - Player participation tracking (mark who played)
    - Player ratings (38-value scale with comments)
    - Match history (view completed matches)
    - Full integration with existing match detail and navigation
  </what-built>
  <how-to-verify>
    1. Navigate to a team's match page
    2. For a scheduled match:
       - Click "Start Match" → status becomes "in_progress"
       - Add goals using the goal form
       - Click "End Match" → status becomes "finished"
       - Mark which players played
       - Add player ratings (test 6, 6-, 6+, 6.5 values)
       - Click "Complete Match" → status becomes "completed"
    3. Verify match appears in History tab
    4. Verify completed match shows all details read-only
    5. Test "Final Results" flow: from scheduled, input everything at once
    6. Verify non-admin users cannot edit
    7. Check mobile responsiveness
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] Match history page lists completed matches
- [ ] MatchHistoryCard shows summary with score
- [ ] CompletedMatchDetail shows all info read-only
- [ ] Team navigation has History tab
- [ ] Match detail page adapts to status
- [ ] Dashboard shows recent results
- [ ] All translations added
- [ ] Manual verification passed
</verification>

<success_criteria>
Phase 4 complete:
- Match lifecycle works (4 states)
- Goals can be added/removed
- Players can be marked as played
- Ratings can be entered (38-value scale)
- Completed matches appear in history
- All users can view history
- Admin-only editing enforced
</success_criteria>

<output>
After completion, create `.planning/phases/04-match-results-ratings/04-06-SUMMARY.md`
</output>
