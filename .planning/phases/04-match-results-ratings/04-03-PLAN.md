---
phase: 04-match-results-ratings
plan: "03"
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [
  "lib/db/goals.ts",
  "lib/validations/goal.ts",
  "hooks/use-goals.ts",
  "components/matches/goal-list.tsx",
  "components/matches/goal-form.tsx",
  "app/[locale]/teams/[teamId]/matches/[matchId]/results/page.tsx"
]
autonomous: true

must_haves:
  truths:
    - "Admin can add goals with scorer, optional assist, own-goal flag"
    - "Admin can remove goals"
    - "Goals display in a list with player names and badges"
    - "Goal order is preserved"
  artifacts:
    - path: "lib/db/goals.ts"
      provides: "Goal CRUD operations"
      exports: ["addGoal", "removeGoal", "getMatchGoals", "updateScore"]
    - path: "components/matches/goal-form.tsx"
      provides: "Add goal modal/form"
    - path: "components/matches/goal-list.tsx"
      provides: "Display list of goals"
  key_links:
    - from: "goal-form.tsx"
      to: "lib/db/goals.ts"
      via: "addGoal server action"
    - from: "goals"
      to: "Match.homeScore/awayScore"
      via: "calculated from goal count"
---

<objective>
Implement goal tracking for matches - add/remove goals with scorer, assist, and own-goal support.

Purpose: Enable admin to record who scored each goal with optional assist attribution.
Output: Goal CRUD operations, goal list UI, goal entry form.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-live-match-experience/04-CONTEXT.md
@.planning/phases/04-live-match-experience/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create goal CRUD operations</name>
  <files>lib/db/goals.ts</files>
  <action>
    Create lib/db/goals.ts with server actions:
    
    ```typescript
    'use server'
    
    import { auth } from '@/lib/auth'
    import { prisma } from '@/lib/db'
    
    // Add a goal to a match
    export async function addGoal(data: {
      matchId: string
      teamId: string      // Which team scored (our team or opponent)
      scorerId: string
      assisterId?: string
      isOwnGoal?: boolean
    }): Promise<Goal>
    
    // Remove a goal
    export async function removeGoal(goalId: string): Promise<void>
    
    // Get all goals for a match, ordered by order field
    export async function getMatchGoals(matchId: string): Promise<Goal[]>
    
    // Update match score based on goals (helper)
    export async function updateMatchScore(matchId: string): Promise<Match>
    ```
    
    Logic for addGoal:
    - Get current max order for the match
    - Set order = max + 1
    - Create goal record
    
    Logic for updateMatchScore:
    - Count goals where teamId = our team → homeScore
    - Count goals where teamId != our team → awayScore (or use opponent placeholder)
    - Update match homeScore and awayScore
    
    Note: teamId represents which team scored. For simplicity:
    - Our team's ID = home team
    - Opponent goals can use a special "opponent" marker or separate handling
  </action>
  <verify>npm run build passes</verify>
  <done>addGoal, removeGoal, getMatchGoals functions work</done>
</task>

<task type="auto">
  <name>Task 2: Create goal validation schema</name>
  <files>lib/validations/goal.ts</files>
  <action>
    Create lib/validations/goal.ts:
    
    ```typescript
    import { z } from 'zdb'
    
    export const addGoalSchema = z.object({
      matchId: z.string().cuid(),
      teamId: z.string().cuid(),
      scorerId: z.string().cuid(),
      assisterId: z.string().cuid().optional(),
      isOwnGoal: z.boolean().optional().default(false),
    })
    ```
  </action>
  <verify>npm run build passes</verify>
  <done>Zod schema validates goal input</done>
</task>

<task type="auto">
  <name>Task 3: Create useGoals hook</name>
  <files>hooks/use-goals.ts</files>
  <action>
    Create hooks/use-goals.ts:
    
    ```typescript
    'use client'
    
    import { useState, useEffect } from 'react'
    import { getMatchGoals, addGoal, removeGoal } from '@/lib/db/goals'
    import { useToast } from '@/hooks/use-toast'
    
    export function useGoals(matchId: string) {
      const [goals, setGoals] = useState<Goal[]>([])
      const [isLoading, setIsLoading] = useState(false)
      
      // Fetch goals
      const fetchGoals = async () => { ... }
      
      // Add goal with optimistic update
      const handleAddGoal = async (data: AddGoalInput) => { ... }
      
      // Remove goal with optimistic update
      const handleRemoveGoal = async (goalId: string) => { ... }
      
      useEffect(() => { fetchGoals() }, [matchId])
      
      return {
        goals,
        isLoading,
        addGoal: handleAddGoal,
        removeGoal: handleRemoveGoal,
        refresh: fetchGoals,
      }
    }
    ```
  </action>
  <verify>npm run build passes</verify>
  <done>Hook manages goal state with optimistic updates</done>
</task>

<task type="auto">
  <name>Task 4: Create GoalList component</name>
  <files>components/matches/goal-list.tsx</files>
  <action>
    Create components/matches/goal-list.tsx:
    
    Display list of goals with:
    - Goal number (1st, 2nd, 3rd...)
    - Scorer name with avatar
    - Assist (if any) with avatar
    - Own goal badge (red badge saying "Autogol")
    - Team indicator (our team vs opponent)
    - Delete button (admin only, only if match not completed)
    
    ```typescript
    interface GoalListProps {
      goals: Goal[]
      canEdit: boolean  // isAdmin && match not completed
      onRemoveGoal: (goalId: string) => void
    }
    
    export function GoalList({ goals, canEdit, onRemoveGoal }: GoalListProps)
    ```
    
    Use shadcn/ui Card for each goal item.
    Mobile-friendly layout with swipe-to-delete or delete button.
  </action>
  <verify>npm run build passes</verify>
  <done>Goal list displays goals with all info, delete works</done>
</task>

<task type="auto">
  <name>Task 5: Create GoalForm component</name>
  <files>components/matches/goal-form.tsx</files>
  <action>
    Create components/matches/goal-form.tsx:
    
    A modal/dialog for adding a goal with:
    - Team selector (Our Team / Opponent)
    - Scorer selector (dropdown/search from team players)
    - Assist selector (optional, dropdown/search)
    - Own goal checkbox
    - Add/Cancel buttons
    
    ```typescript
    interface GoalFormProps {
      matchId: string
      teamId: string
      players: Player[]  // Team players to select from
      onAddGoal: (data: AddGoalInput) => Promise<void>
      isOpen: boolean
      onClose: () => void
    }
    
    export function GoalForm({ matchId, teamId, players, onAddGoal, isOpen, onClose }: GoalFormProps)
    ```
    
    Use shadcn/ui Dialog, Select, Checkbox components.
    Disable assist selector if own goal is checked.
  </action>
  <verify>npm run build passes</verify>
  <done>Goal form adds goals with all fields</done>
</task>

<task type="auto">
  <name>Task 6: Create Results page</name>
  <files>app/[locale]/teams/[teamId]/matches/[matchId]/results/page.tsx</files>
  <action>
    Create app/[locale]/teams/[teamId]/matches/[matchId]/results/page.tsx:
    
    Page for entering match results:
    - Shows current score (home/away)
    - Goal list with add/remove
    - "Add Goal" button opens GoalForm
    - Score calculated from goals OR manually settable
    
    ```typescript
    export default async function MatchResultsPage({
      params
    }: {
      params: { locale: string; teamId: string; matchId: string }
    })
    ```
    
    Server component that fetches match data, passes to client component.
    Only accessible if match status is IN_PROGRESS or FINISHED.
    Read-only if match is COMPLETED.
  </action>
  <verify>npm run build passes</verify>
  <done>Results page shows/edits goals and score</done>
</task>

</tasks>

<verification>
- [ ] addGoal creates goal with correct order
- [ ] removeGoal deletes goal
- [ ] getMatchGoals returns goals in order
- [ ] GoalList displays all goal info correctly
- [ ] GoalForm allows selecting scorer, assist, own-goal
- [ ] Results page integrates components
- [ ] Score updates when goals change
</verification>

<success_criteria>
Admin can manage goals:
- Add goal with scorer, optional assist, own-goal flag
- Remove goal
- View goal list with all details
- Score reflects goal count
</success_criteria>

<output>
After completion, create `.planning/phases/04-match-results-ratings/04-03-SUMMARY.md`
</output>
