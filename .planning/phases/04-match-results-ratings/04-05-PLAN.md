---
phase: 04-match-results-ratings
plan: "05"
type: execute
wave: 3
depends_on: ["04-01", "04-04"]
files_modified: [
  "lib/db/player-ratings.ts",
  "lib/validations/rating.ts",
  "hooks/use-player-ratings.ts",
  "components/matches/rating-selector.tsx",
  "components/matches/player-rating-card.tsx",
  "components/matches/ratings-list.tsx",
  "app/[locale]/teams/[teamId]/matches/[matchId]/ratings/page.tsx",
  "messages/it.json",
  "messages/en.json"
]
autonomous: true

must_haves:
  truths:
    - "Admin can rate only players who actually played (played=true)"
    - "Rating scale has 38 values: X, X-, X+, X.5 for 1-9; 10- and 10 only"
    - "Rating stored as decimal (6.0, 6.25, 6.5, 6.75)"
    - "Admin can add optional comment per player"
    - "Ratings UI only appears when match status is FINISHED"
  artifacts:
    - path: "lib/db/player-ratings.ts"
      provides: "upsertRating, getMatchRatings, getPlayerAverageRating"
      exports: ["upsertPlayerRating", "getMatchRatings", "getPlayerAverageRating"]
    - path: "components/matches/rating-selector.tsx"
      provides: "38-value rating selector UI"
    - path: "components/matches/player-rating-card.tsx"
      provides: "Rating input per player"
  key_links:
    - from: "rating-selector.tsx"
      to: "PlayerRating.rating"
      via: "decimal mapping (6+ → 6.75)"
    - from: "PlayerRating.playerId"
      to: "MatchPlayer.played"
      via: "played must be true to rate"
---

<objective>
Implement player ratings with nuanced 38-value scale and optional comments.

Purpose: Enable admin to rate players who played using Italian school-style grading (6, 6-, 6+, 6.5, etc.) with comments.
Output: Rating CRUD, rating selector UI, rating cards per player, ratings page.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-live-match-experience/04-CONTEXT.md
@.planning/phases/04-live-match-experience/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rating utility constants</name>
  <files>lib/rating-utils.ts</files>
  <action>
    Create lib/rating-utils.ts with rating constants and helpers:
    
    ```typescript
    // All 38 valid rating values as strings
    export const RATING_VALUES = [
      '1', '1-', '1+', '1.5',
      '2', '2-', '2+', '2.5',
      '3', '3-', '3+', '3.5',
      '4', '4-', '4+', '4.5',
      '5', '5-', '5+', '5.5',
      '6', '6-', '6+', '6.5',
      '7', '7-', '7+', '7.5',
      '8', '8-', '8+', '8.5',
      '9', '9-', '9+', '9.5',
      '10-', '10'
    ] as const
    
    // Map rating string to decimal
    export function ratingToDecimal(rating: string): number {
      // 6 → 6.0, 6- → 6.25, 6.5 → 6.5, 6+ → 6.75
      if (rating.endsWith('-')) return parseFloat(rating) + 0.25
      if (rating.endsWith('+')) return parseFloat(rating) + 0.75
      if (rating.includes('.5')) return parseFloat(rating)
      return parseFloat(rating)
    }
    
    // Map decimal back to rating string
    export function decimalToRating(decimal: number): string {
      const base = Math.floor(decimal)
      const fraction = decimal - base
      if (fraction < 0.125) return String(base)
      if (fraction < 0.375) return `${base}-`
      if (fraction < 0.625) return `${base}.5`
      return `${base}+`
    }
    
    // Get base and modifier from rating
    export function parseRating(rating: string): { base: number; modifier: '' | '-' | '+' | '.5' }
    ```
  </action>
  <verify>npm run build passes</verify>
  <done>Rating constants and conversion functions work</done>
</task>

<task type="auto">
  <name>Task 2: Create player rating CRUD</name>
  <files>lib/db/player-ratings.ts</files>
  <action>
    Create lib/db/player-ratings.ts:
    
    ```typescript
    'use server'
    
    import { auth } from '@/lib/auth'
    import { prisma } from '@/lib/db'
    import { ratingToDecimal } from '@/lib/rating-utils'
    
    // Upsert rating (create or update)
    export async function upsertPlayerRating(data: {
      matchId: string
      playerId: string
      rating: string  // e.g., "6.5", "6+", "6-"
      comment?: string
    }): Promise<PlayerRating>
    
    // Get all ratings for a match
    export async function getMatchRatings(matchId: string): Promise<PlayerRatingWithPlayer[]>
    
    // Get rating for specific player in match
    export async function getPlayerMatchRating(matchId: string, playerId: string): Promise<PlayerRating | null>
    
    // Calculate player's average rating across all matches
    export async function getPlayerAverageRating(playerId: string): Promise<number | null>
    
    // Delete rating
    export async function deletePlayerRating(matchId: string, playerId: string): Promise<void>
    ```
    
    upsertPlayerRating should:
    - Verify user is team admin
    - Verify match status is FINISHED (not COMPLETED)
    - Verify player has played=true in this match
    - Convert rating string to decimal
    - Create or update PlayerRating record
  </action>
  <verify>npm run build passes</verify>
  <done>Rating CRUD with decimal conversion and validation</done>
</task>

<task type="auto">
  <name>Task 3: Create rating validation schema</name>
  <files>lib/validations/rating.ts</files>
  <action>
    Create lib/validations/rating.ts:
    
    ```typescript
    import { z } from 'zod'
    import { RATING_VALUES } from '@/lib/rating-utils'
    
    export const playerRatingSchema = z.object({
      matchId: z.string().cuid(),
      playerId: z.string().cuid(),
      rating: z.enum(RATING_VALUES),
      comment: z.string().max(500).optional(),
    })
    ```
  </action>
  <verify>npm run build passes</verify>
  <done>Zod schema validates 38 rating values</done>
</task>

<task type="auto">
  <name>Task 4: Create usePlayerRatings hook</name>
  <files>hooks/use-player-ratings.ts</files>
  <action>
    Create hooks/use-player-ratings.ts:
    
    ```typescript
    'use client'
    
    import { useState, useEffect } from 'react'
    import { upsertPlayerRating, getMatchRatings, deletePlayerRating } from '@/lib/db/player-ratings'
    import { useToast } from '@/hooks/use-toast'
    
    export function usePlayerRatings(matchId: string) {
      const [ratings, setRatings] = useState<Map<string, PlayerRating>>(new Map())
      const [isLoading, setIsLoading] = useState(false)
      
      const fetchRatings = async () => { ... }
      
      const upsertRating = async (playerId: string, rating: string, comment?: string) => {
        // Optimistic update
        // Call upsertPlayerRating
        // Rollback on error
      }
      
      const removeRating = async (playerId: string) => { ... }
      
      useEffect(() => { fetchRatings() }, [matchId])
      
      return {
        ratings,
        isLoading,
        upsertRating,
        removeRating,
        getRating: (playerId: string) => ratings.get(playerId),
        refresh: fetchRatings,
      }
    }
    ```
  </action>
  <verify>npm run build passes</verify>
  <done>Hook manages ratings with optimistic updates</done>
</task>

<task type="auto">
  <name>Task 5: Create RatingSelector component</name>
  <files>components/matches/rating-selector.tsx</files>
  <action>
    Create components/matches/rating-selector.tsx:
    
    A selector for the 38 rating values. Two options:
    
    **Option A - Single dropdown:** Simple Select with all 38 values
    **Option B - Two selectors:** Base (1-10) + Modifier (blank, -, +, .5)
    
    Implement Option B for better mobile UX:
    
    ```typescript
    interface RatingSelectorProps {
      value: string | undefined  // e.g., "6.5"
      onChange: (value: string) => void
      disabled?: boolean
    }
    
    export function RatingSelector({ value, onChange, disabled }: RatingSelectorProps)
    ```
    
    Use two shadcn/ui Select components:
    - First: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
    - Second: (blank), -, +, .5
    - When base is 10, second only allows (blank) or -
    
    Display current value as formatted string (e.g., "6.5", "6+", "6-").
  </action>
  <verify>npm run build passes</verify>
  <done>Rating selector allows selecting all 38 values</done>
</task>

<task type="auto">
  <name>Task 6: Create PlayerRatingCard component</name>
  <files>components/matches/player-rating-card.tsx</files>
  <action>
    Create components/matches/player-rating-card.tsx:
    
    A card for rating a single player:
    
    ```typescript
    interface PlayerRatingCardProps {
      player: Player
      currentRating?: PlayerRating
      onRatingChange: (rating: string) => void
      onCommentChange: (comment: string) => void
      disabled?: boolean
    }
    
    export function PlayerRatingCard({ player, currentRating, onRatingChange, onCommentChange, disabled }: PlayerRatingCardProps)
    ```
    
    Layout:
    - Player avatar and name on left
    - Rating selector on right
    - Comment textarea below (collapsible/expandable)
    - Visual indicator if rating is set vs not set
    - Mobile-friendly stacked layout
  </action>
  <verify>npm run build passes</verify>
  <done>Card allows rating a player with comment</done>
</task>

<task type="auto">
  <name>Task 7: Create RatingsList component</name>
  <files>components/matches/ratings-list.tsx</files>
  <action>
    Create components/matches/ratings-list.tsx:
    
    Display all player ratings (read-only view for completed matches):
    
    ```typescript
    interface RatingsListProps {
      ratings: PlayerRatingWithPlayer[]
    }
    
    export function RatingsList({ ratings }: RatingsListProps)
    ```
    
    Shows:
    - Player name, avatar
    - Rating (formatted as string, e.g., "6.5")
    - Comment (if any)
    - Sorted by rating descending (best first)
    - Average rating at top
  </action>
  <verify>npm run build passes</verify>
  <done>List displays ratings read-only with average</done>
</task>

<task type="auto">
  <name>Task 8: Create Ratings page</name>
  <files>app/[locale]/teams/[teamId]/matches/[matchId]/ratings/page.tsx</files>
  <action>
    Create app/[locale]/teams/[teamId]/matches/[matchId]/ratings/page.tsx:
    
    Page for entering/viewing player ratings:
    - Only shows players with played=true
    - Editable if match status is FINISHED and user is admin
    - Read-only if match is COMPLETED or user is not admin
    - Shows count: "X of Y players rated"
    - Save button to save all ratings (or auto-save per rating)
    
    ```typescript
    export default async function MatchRatingsPage({
      params
    }: {
      params: { locale: string; teamId: string; matchId: string }
    })
    ```
  </action>
  <verify>npm run build passes</verify>
  <done>Ratings page allows editing/viewing ratings</done>
</task>

<task type="auto">
  <name>Task 9: Add translations</name>
  <files>messages/it.json, messages/en.json</files>
  <action>
    Add Italian and English translations for ratings:
    
    Italian:
    ```json
    "ratings": {
      "title": "Voti Partita",
      "selectRating": "Seleziona voto",
      "addComment": "Aggiungi commento (opzionale)",
      "playerRating": "Voto giocatore",
      "averageRating": "Media voti",
      "rated": "votati",
      "of": "di",
      "players": "giocatori",
      "noRatings": "Nessun voto inserito",
      "base": "Base",
      "modifier": "Modificatore"
    }
    ```
    
    English equivalents.
  </action>
  <verify>npm run build passes</verify>
  <done>Translations for ratings UI</done>
</task>

</tasks>

<verification>
- [ ] 38 rating values defined and valid
- [ ] ratingToDecimal and decimalToRating work correctly
- [ ] upsertPlayerRating creates/updates with decimal
- [ ] RatingSelector allows all 38 values
- [ ] PlayerRatingCard integrates selector and comment
- [ ] Ratings page shows only played players
- [ ] Editable only when match is FINISHED
- [ ] Translations added
</verification>

<success_criteria>
Admin can rate players:
- Rate only players who played (played=true)
- Select from 38 nuanced values (6, 6-, 6+, 6.5)
- Add optional comment per player
- Ratings stored as decimal for averaging
- UI only available when match is FINISHED
</success_criteria>

<output>
After completion, create `.planning/phases/04-match-results-ratings/04-05-SUMMARY.md`
</output>
