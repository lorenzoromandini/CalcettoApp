---
phase: 04-match-results-ratings
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified: [
  "prisma/schema.prisma",
  "prisma/migrations/...",
  "types/database.ts"
]
autonomous: true

must_haves:
  truths:
    - "Match status can be scheduled, in_progress, finished, or completed"
    - "Goals can be stored with scorer, optional assist, own-goal flag"
    - "Player ratings can be stored with decimal precision (6.25, 6.5, 6.75)"
    - "MatchPlayer has played flag to track actual participation"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Goal, PlayerRating models, MatchStatus enum"
      contains: ["model Goal", "model PlayerRating", "enum MatchStatus"]
    - path: "types/database.ts"
      provides: "TypeScript types for new models"
  key_links:
    - from: "Goal.matchId"
      to: "Match.id"
      via: "FOREIGN KEY"
    - from: "PlayerRating.matchId"
      to: "Match.id"
      via: "FOREIGN KEY"
    - from: "PlayerRating.playerId"
      to: "Player.id"
      via: "FOREIGN KEY"
---

<objective>
Create database schema for match results, goals, and player ratings.

Purpose: Enable storage of match lifecycle states, goal tracking, and nuanced player ratings.
Output: Prisma migration with Goal and PlayerRating models, MatchStatus enum, played flag on MatchPlayer.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-live-match-experience/04-CONTEXT.md
@.planning/phases/04-live-match-experience/04-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MatchStatus enum and update Match model</name>
  <files>prisma/schema.prisma</files>
  <action>
    Add MatchStatus enum to prisma/schema.prisma:
    ```prisma
    enum MatchStatus {
      SCHEDULED
      IN_PROGRESS
      FINISHED
      COMPLETED
      CANCELLED
    }
    ```
    
    Update Match model to use the enum:
    - Change `status String @default("scheduled")` to `status MatchStatus @default(SCHEDULED)`
    
    Note: homeScore and awayScore fields already exist in Match model.
  </action>
  <verify>npx prisma validate passes</verify>
  <done>MatchStatus enum exists, Match.status uses enum type</done>
</task>

<task type="auto">
  <name>Task 2: Add Goal model</name>
  <files>prisma/schema.prisma</files>
  <action>
    Add Goal model to prisma/schema.prisma after the FormationPosition model:
    ```prisma
    model Goal {
      id         String   @id @default(cuid())
      matchId    String   @map("match_id")
      teamId     String   @map("team_id")
      scorerId   String   @map("scorer_id")
      assisterId String?  @map("assister_id")
      isOwnGoal  Boolean  @default(false) @map("is_own_goal")
      order      Int
      createdAt  DateTime @default(now()) @map("created_at")

      match    Match   @relation(fields: [matchId], references: [id], onDelete: Cascade)
      team     Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
      scorer   Player  @relation("GoalScorer", fields: [scorerId], references: [id], onDelete: Cascade)
      assister Player? @relation("GoalAssister", fields: [assisterId], references: [id], onDelete: SetNull)

      @@unique([matchId, order])
      @@index([matchId])
      @@index([scorerId])
      @@map("goals")
    }
    ```
    
    Add relations to existing models:
    - Team: add `goals Goal[]`
    - Player: add `scoredGoals Goal[] @relation("GoalScorer")` and `assistedGoals Goal[] @relation("GoalAssister")`
    - Match: add `goals Goal[]`
  </action>
  <verify>npx prisma validate passes</verify>
  <done>Goal model exists with scorer, assister, isOwnGoal, order fields</done>
</task>

<task type="auto">
  <name>Task 3: Add PlayerRating model</name>
  <files>prisma/schema.prisma</files>
  <action>
    Add PlayerRating model to prisma/schema.prisma:
    ```prisma
    model PlayerRating {
      id        String    @id @default(cuid())
      matchId   String    @map("match_id")
      playerId  String    @map("player_id")
      rating    Decimal   @db.Decimal(3, 2)
      comment   String?
      createdAt DateTime  @default(now()) @map("created_at")
      updatedAt DateTime  @updatedAt @map("updated_at")

      match  Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
      player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

      @@unique([matchId, playerId])
      @@index([matchId])
      @@index([playerId])
      @@map("player_ratings")
    }
    ```
    
    Add relations to existing models:
    - Match: add `ratings PlayerRating[]`
    - Player: add `ratings PlayerRating[]`
  </action>
  <verify>npx prisma validate passes</verify>
  <done>PlayerRating model exists with rating (Decimal 3,2), comment fields</done>
</task>

<task type="auto">
  <name>Task 4: Add played flag to MatchPlayer</name>
  <files>prisma/schema.prisma</files>
  <action>
    Update MatchPlayer model to add played flag:
    - Add `played Boolean @default(false) @map("played")` after the existing fields
    
    This tracks whether a player actually participated in the match (vs just RSVP'd).
  </action>
  <verify>npx prisma validate passes</verify>
  <done>MatchPlayer has played boolean field</done>
</task>

<task type="auto">
  <name>Task 5: Remove unused MatchTimer model</name>
  <files>prisma/schema.prisma</files>
  <action>
    Remove the MatchTimer model from prisma/schema.prisma as it's not needed for the simplified Phase 4 design (no timer/clock tracking per user decision D1).
    
    Delete the entire MatchTimer model block.
  </action>
  <verify>npx prisma validate passes</verify>
  <done>MatchTimer model removed from schema</done>
</task>

<task type="auto">
  <name>Task 6: Generate and run migration</name>
  <files>prisma/migrations/...</files>
  <action>
    Run the following commands:
    1. `npx prisma migrate dev --name add_match_results_ratings`
    2. `npx prisma generate`
    
    This creates the migration file and updates the Prisma client.
  </action>
  <verify>npx prisma generate succeeds, migration applied</verify>
  <done>Migration created and applied, Prisma client regenerated</done>
</task>

</tasks>

<verification>
- [ ] MatchStatus enum exists with SCHEDULED, IN_PROGRESS, FINISHED, COMPLETED, CANCELLED
- [ ] Match model uses MatchStatus enum for status field
- [ ] Goal model exists with matchId, teamId, scorerId, assisterId, isOwnGoal, order
- [ ] PlayerRating model exists with matchId, playerId, rating (Decimal), comment
- [ ] MatchPlayer has played boolean field
- [ ] MatchTimer model removed
- [ ] Migration created and applied
- [ ] Prisma client regenerated
</verification>

<success_criteria>
Database schema supports:
- Match lifecycle with 4 states (scheduled → in_progress → finished → completed)
- Goal tracking with scorer, optional assist, own-goal flag
- Nuanced player ratings with decimal precision (6.25, 6.5, 6.75)
- Player participation tracking (played flag)
</success_criteria>

<output>
After completion, create `.planning/phases/04-match-results-ratings/04-01-SUMMARY.md`
</output>
