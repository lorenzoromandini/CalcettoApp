---
phase: 01-foundation-auth
plan: 06
type: execute
wave: 3
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - lib/i18n/routing.ts
  - lib/i18n/request.ts
  - messages/en.json
  - messages/it.json
  - middleware.ts (modified)
  - app/[locale]/layout.tsx
  - app/[locale]/page.tsx
  - components/providers/theme-provider.tsx
  - components/theme-toggle.tsx
  - components/providers/locale-provider.tsx
  - components/locale-switcher.tsx
  - components/onboarding/tutorial.tsx
  - app/globals.css (modified for themes)
autonomous: true

must_haves:
  truths:
    - "App supports Italian and English languages"
    - "Language is detected from browser or URL locale"
    - "User can manually switch language"
    - "App supports system-aware dark/light mode"
    - "User can toggle theme manually"
    - "Onboarding tutorial shows for first-time users"
  artifacts:
    - path: "lib/i18n/routing.ts"
      provides: "i18n routing config"
      exports: ["routing"]
    - path: "lib/i18n/request.ts"
      provides: "i18n request handler"
    - path: "messages/it.json"
      provides: "Italian translations"
    - path: "messages/en.json"
      provides: "English translations"
    - path: "components/providers/theme-provider.tsx"
      provides: "Theme context provider"
      exports: ["ThemeProvider"]
    - path: "components/theme-toggle.tsx"
      provides: "Theme toggle button"
      exports: ["ThemeToggle"]
    - path: "components/providers/locale-provider.tsx"
      provides: "Locale provider wrapper"
      exports: ["LocaleProvider"]
    - path: "components/onboarding/tutorial.tsx"
      provides: "Onboarding tutorial component"
      exports: ["OnboardingTutorial"]
  key_links:
    - from: "middleware.ts"
      to: "lib/i18n/routing.ts"
      via: "createMiddleware"
    - from: "app/[locale]/layout.tsx"
      to: "lib/i18n/request.ts"
      via: "getMessages"
    - from: "components/providers/theme-provider.tsx"
      to: "next-themes"
      via: "import"
---

<objective>
Implement theme switching (dark/light mode), internationalization (Italian/English), and onboarding tutorial for new users.

Purpose: These UI/UX features make the app accessible to a broader audience and provide a polished experience. Dark mode is essential for outdoor use, i18n serves the Italian primary market with English fallback, and onboarding helps first-time users understand the app.

Output: Complete theme system with next-themes, i18n routing with next-intl, and onboarding tutorial component.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md (reference middleware)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Internationalization with next-intl</name>
  <files>
    - lib/i18n/routing.ts
    - lib/i18n/request.ts
    - middleware.ts (modified)
    - messages/it.json
    - messages/en.json
  </files>
  <action>
    Set up next-intl for Italian/English i18n per RESEARCH.md Pattern 5.

    lib/i18n/routing.ts:
    - Import defineRouting from next-intl/routing
    - Export routing with locales: ['en', 'it']
    - Set defaultLocale: 'it' (primary market)
    - Configure localePrefix as needed

    lib/i18n/request.ts:
    - Import getRequestConfig from next-intl/server
    - Export config that loads messages based on locale
    - Import messages from ../messages/{locale}.json
    - Validate locale against routing.locales

    middleware.ts (modify existing):
    - Import createMiddleware from next-intl/middleware
    - Import routing from lib/i18n/routing
    - Combine with existing auth middleware (updateSession)
    - Chain i18n middleware -> auth middleware
    - Update matcher to exclude API routes and static files

    messages/it.json:
    - Navigation: home, login, signup, teams, matches
    - Auth: email, password, signIn, signUp, forgotPassword
    - Common: loading, error, save, cancel, delete
    - Start with auth-related translations

    messages/en.json:
    - Same keys as Italian with English values

    This enables URL-based locale routing (/it/, /en/) with Italian as default.
  </action>
  <verify>
    - lib/i18n/routing.ts exports routing config
    - lib/i18n/request.ts exports request config
    - middleware.ts combines i18n and auth middleware
    - messages/it.json has Italian translations
    - messages/en.json has English translations
    - `npm run build` compiles without errors
  </verify>
  <done>
    next-intl configured with Italian/English routing and translation files
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Locale-Aware Layout and Providers</name>
  <files>
    - app/[locale]/layout.tsx
    - app/[locale]/page.tsx
    - components/providers/locale-provider.tsx
    - components/locale-switcher.tsx
  </files>
  <action>
    Create the locale-aware layout structure for next-intl.

    app/[locale]/layout.tsx:
    - Async function accepting { children, params: { locale } }
    - Validate locale is in routing.locales
    - Import getMessages from @/lib/i18n/request (or next-intl/server)
    - Wrap children with NextIntlClientProvider
    - Include ThemeProvider (from Task 3)
    - Set html lang attribute to locale
    - Include suppressHydrationWarning for theme

    app/[locale]/page.tsx:
    - Simple home page with welcome message
    - Use useTranslations hook for i18n
    - Show links to login/signup
    - Include ThemeToggle and LocaleSwitcher

    components/providers/locale-provider.tsx:
    - Re-export or wrap NextIntlClientProvider if needed
    - May not be needed if using directly in layout

    components/locale-switcher.tsx:
    - 'use client' component
    - Get current locale and router
    - Dropdown or buttons to switch between it/en
    - Use router.replace to switch locale while keeping path
    - Show current locale (IT/EN flags or text)

    Move existing app/layout.tsx content to app/[locale]/layout.tsx or keep as root wrapper.
  </action>
  <verify>
    - app/[locale]/layout.tsx exists with locale handling
    - app/[locale]/page.tsx exists as home page
    - LocaleSwitcher component allows language switching
    - `npm run build` compiles without errors
    - /it/ and /en/ routes work (can test after build)
  </verify>
  <done>
    Locale-aware layout created with Italian/English support and language switcher
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Dark/Light Theme with next-themes</name>
  <files>
    - components/providers/theme-provider.tsx
    - components/theme-toggle.tsx
    - app/globals.css (modified for theme vars)
    - app/[locale]/layout.tsx (modified)
  </files>
  <action>
    Implement theme switching with next-themes per RESEARCH.md Pattern 4.

    components/providers/theme-provider.tsx:
    - 'use client'
    - Import ThemeProvider from next-themes
    - Re-export with proper typing
    - Props: attribute="data-theme", defaultTheme="system", enableSystem

    app/globals.css (verify/modify):
    - CSS variables for light theme in :root
    - CSS variables for dark theme in [data-theme='dark']
    - Tailwind v4 syntax: @custom-variant dark (&:where([data-theme=dark], ...))
    - Variables: background, foreground, primary, secondary, etc.

    components/theme-toggle.tsx:
    - 'use client'
    - Import useTheme from next-themes
    - Use Sun and Moon icons from lucide-react
    - Button that toggles between light/dark
    - Animated icon transition (rotate/scale)
    - Accessible label

    app/[locale]/layout.tsx (modify):
    - Wrap children with ThemeProvider
    - Add suppressHydrationWarning to html element (prevents hydration mismatch warning)
    - Ensure ThemeProvider is inside body

    This enables system-aware theming with manual override.
  </action>
  <verify>
    - components/providers/theme-provider.tsx exists
    - components/theme-toggle.tsx exists with toggle functionality
    - CSS variables defined for both themes
    - ThemeProvider wraps app in layout
    - suppressHydrationWarning added to html
    - `npm run build` compiles without errors
  </verify>
  <done>
    Theme system implemented with next-themes: system detection, manual toggle, no hydration issues
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Onboarding Tutorial Component</name>
  <files>
    - components/onboarding/tutorial.tsx
    - hooks/use-onboarding.ts
    - lib/db/index.ts (modified for localStorage/onboarding flag)
  </files>
  <action>
    Create an onboarding tutorial for first-time users (UIUX-05 requirement).

    hooks/use-onboarding.ts:
    - Check if user has completed onboarding (localStorage flag)
    - Provide completeOnboarding function
    - Return { showOnboarding, completeOnboarding }

    components/onboarding/tutorial.tsx:
    - 'use client' component
    - Modal or step-based tutorial overlay
    - 3-4 steps introducing key features:
      1. Welcome to Calcetto Manager
      2. Create your team and invite players
      3. Schedule matches and track statistics
      4. Works offline - perfect for the pitch!
    - Each step with illustration/icon and description
    - Next/Previous buttons
    - Skip and Get Started buttons
    - Dot indicators for progress
    - Mobile-optimized (swipeable steps)
    - Store completion in localStorage

    Use shadcn/ui components: Dialog, Button, Card
    Use Lucide icons for each step

    Trigger in app/[locale]/page.tsx:
    - Check if user is authenticated
    - Show tutorial on first visit for new users
    - Can be skipped and resumed later
  </action>
  <verify>
    - components/onboarding/tutorial.tsx exists with multi-step UI
    - hooks/use-onboarding.ts manages completion state
    - Tutorial shows on first visit
    - Can be skipped and completed
    - Mobile-optimized layout
    - TypeScript compiles without errors
  </verify>
  <done>
    Onboarding tutorial component created with 4-step introduction and localStorage persistence
  </done>
</task>

</tasks>

<verification>
After this plan completes:
1. /it/ and /en/ routes work correctly
2. Language switching updates UI text
3. Theme toggle switches between light/dark
4. System theme is detected and applied
5. No hydration mismatches in console
6. Onboarding shows for first-time users
7. All translations are in JSON files
8. Build completes without errors
</verification>

<success_criteria>
- lib/i18n/routing.ts with locales ['it', 'en']
- lib/i18n/request.ts for loading messages
- middleware.ts combines i18n + auth middleware
- messages/it.json and messages/en.json with auth translations
- app/[locale]/layout.tsx with locale support
- components/providers/theme-provider.tsx using next-themes
- components/theme-toggle.tsx with Sun/Moon icons
- CSS variables for light/dark themes
- components/onboarding/tutorial.tsx with 4 steps
- hooks/use-onboarding.ts for completion tracking
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-06-SUMMARY.md` documenting:
- i18n routing strategy
- Theme implementation approach
- Onboarding flow design
- Translation key structure
</output>
