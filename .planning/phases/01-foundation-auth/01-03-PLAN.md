---
phase: 01-foundation-auth
plan: 03
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - lib/db/schema.ts
  - lib/db/index.ts
  - lib/db/actions.ts
  - app/sw.ts
  - scripts/build-sw.ts
  - public/sw.js
  - components/service-worker-register.tsx
  - hooks/use-offline-queue.ts
  - components/offline-banner.tsx
  - next.config.ts
autonomous: true

must_haves:
  truths:
    - "IndexedDB stores offline actions with pending/synced/error status"
    - "Service Worker precaches app shell for instant loads"
    - "Background Sync queues mutations when offline"
    - "Offline banner shows connection status and queue count"
    - "SW never caches live match data (per Pitfall #4)"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "TypeScript types for IndexedDB"
      exports: ["Team", "OfflineAction", "SyncStatus"]
    - path: "lib/db/index.ts"
      provides: "IndexedDB initialization"
      exports: ["getDB", "DB_NAME", "DB_VERSION"]
    - path: "lib/db/actions.ts"
      provides: "CRUD operations and queue management"
      exports: ["queueOfflineAction", "getPendingActions", "markActionSynced"]
    - path: "app/sw.ts"
      provides: "Service Worker source"
    - path: "public/sw.js"
      provides: "Built Service Worker"
    - path: "components/service-worker-register.tsx"
      provides: "SW registration component"
      exports: ["ServiceWorkerRegister"]
    - path: "hooks/use-offline-queue.ts"
      provides: "Offline state hook"
      exports: ["useOfflineQueue"]
    - path: "components/offline-banner.tsx"
      provides: "Offline status UI"
      exports: ["OfflineBanner"]
  key_links:
    - from: "app/sw.ts"
      to: "Workbox"
      via: "import"
      pattern: "workbox-"
    - from: "components/service-worker-register.tsx"
      to: "public/sw.js"
      via: "navigator.serviceWorker.register('/sw.js')"
    - from: "hooks/use-offline-queue.ts"
      to: "ServiceWorker"
      via: "navigator.serviceWorker.addEventListener"
    - from: "lib/db/actions.ts"
      to: "lib/db/index.ts"
      via: "getDB import"
---

<objective>
Implement offline-first infrastructure with IndexedDB for data persistence and Workbox-based Service Worker for background sync and app shell caching.

Purpose: Offline support is core to Calcetto Manager's value proposition â€” users must be able to access data and queue actions when pitch-side without connectivity. This plan implements the complete offline stack per RESEARCH.md (idb, Workbox, Background Sync).

Output: Fully functional offline infrastructure with IndexedDB schema, offline action queue, Service Worker with precaching, and UI feedback for sync status.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md (if exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IndexedDB Schema and Types</name>
  <files>
    - lib/db/schema.ts
  </files>
  <action>
    Create TypeScript type definitions for IndexedDB stores per RESEARCH.md Pattern 2.

    Define interfaces for:
    1. SyncStatus type: 'synced' | 'pending' | 'error'
    2. Team interface: id, name, description, created_at, updated_at, sync_status
    3. Player interface: id, team_id, name, surname, nickname, jersey_number, avatar_url, roles[], sync_status
    4. Match interface: id, team_id, date, location, mode (5vs5/8vs8), status, sync_status
    5. OfflineAction interface: id, type ('create'|'update'|'delete'), table, data, timestamp, retry_count

    Also define the DBSchema interface extending idb's DBSchema for type safety.

    Structure:
    ```typescript
    export type SyncStatus = 'synced' | 'pending' | 'error';
    
    export interface Team {
      id: string;
      name: string;
      description?: string;
      created_at: string;
      updated_at: string;
      sync_status: SyncStatus;
    }
    
    // ... other interfaces
    
    export interface CalcettoDB extends DBSchema {
      teams: { key: string; value: Team; indexes: { 'by-sync-status': string } };
      offline_actions: { key: string; value: OfflineAction; indexes: { 'by-timestamp': number } };
    }
    ```

    This schema prepares for Phase 2 (Team Management) while providing the foundation for offline actions.
  </action>
  <verify>
    - lib/db/schema.ts exists with all type definitions
    - SyncStatus type defined
    - Team, Player, Match, OfflineAction interfaces exported
    - CalcettoDB extends DBSchema with proper indexes
    - TypeScript compiles without errors
  </verify>
  <done>
    IndexedDB TypeScript schema created at lib/db/schema.ts with all entity types and sync status tracking
  </done>
</task>

<task type="auto">
  <name>Task 2: Create IndexedDB Database and Operations</name>
  <files>
    - lib/db/index.ts
    - lib/db/actions.ts
  </files>
  <action>
    Create IndexedDB initialization and CRUD operations per RESEARCH.md Pattern 2.

    lib/db/index.ts:
    - Import openDB from idb
    - Define DB_NAME = 'calcetto-manager' and DB_VERSION = 1
    - Create getDB() function with upgrade logic for stores
    - Create object stores: teams, players, matches, offline_actions
    - Add indexes: 'by-sync-status' for entities, 'by-timestamp' for actions

    lib/db/actions.ts:
    - queueOfflineAction(): Add action to offline_actions store
    - getPendingActions(): Get all pending actions sorted by timestamp
    - markActionSynced(): Remove action from queue or update status
    - getTeams(), saveTeam(): Basic CRUD for teams (preparation for Phase 2)
    - getPlayersByTeam(): Query players by team_id

    Implementation notes:
    - Use idb's promise-based API
    - All data operations should handle sync_status
    - Offline actions get unique IDs via crypto.randomUUID()
    - Include error handling with try/catch
  </action>
  <verify>
    - lib/db/index.ts exports getDB, DB_NAME, DB_VERSION
    - lib/db/actions.ts exports queueOfflineAction, getPendingActions, markActionSynced
    - All functions use proper TypeScript types from schema.ts
    - Database upgrade logic creates all stores and indexes
    - `npm run build` compiles without errors
  </verify>
  <done>
    IndexedDB database and operations created with offline action queue support
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Service Worker with Workbox</name>
  <files>
    - app/sw.ts
    - scripts/build-sw.ts
    - public/sw.js
    - next.config.ts (modified)
  </files>
  <action>
    Create Service Worker using Workbox per RESEARCH.md Pattern 1.

    Steps:
    1. Create app/sw.ts as the Service Worker source:
       - Import Workbox modules (precacheAndRoute, registerRoute, strategies, plugins)
       - Precache app shell with self.__WB_MANIFEST
       - Pages: StaleWhileRevalidate strategy (instant load + freshness)
       - Static assets: CacheFirst strategy
       - Images: CacheFirst with size limits
       - API mutations: NetworkOnly with BackgroundSyncPlugin
       - Live match data: NetworkFirst with 60s TTL (NEVER cache stale scores)

    2. Create scripts/build-sw.ts to compile SW at build time:
       - Use workbox-build to generate sw.js
       - Inject manifest from Next.js build
       - Output to public/sw.js

    3. Modify next.config.ts to run SW build script

    CRITICAL: Follow RESEARCH.md anti-patterns:
    - Use NetworkFirst for /live/* routes (Pitfall #4)
    - Set maxAgeSeconds low for live data (60s)
    - Use ExpirationPlugin with maxEntries for all caches
    - BackgroundSyncPlugin for POST/PUT/DELETE to /api/*

    SW structure:
    ```typescript
    import { precacheAndRoute } from 'workbox-precaching';
    import { registerRoute } from 'workbox-routing';
    import { StaleWhileRevalidate, CacheFirst, NetworkOnly, NetworkFirst } from 'workbox-strategies';
    import { ExpirationPlugin } from 'workbox-expiration';
    import { BackgroundSyncPlugin } from 'workbox-background-sync';

    // Precache (injected at build)
    precacheAndRoute(self.__WB_MANIFEST || []);

    // Pages: StaleWhileRevalidate
    registerRoute(
      ({ request }) => request.destination === 'document',
      new StaleWhileRevalidate({ cacheName: 'pages', plugins: [...] })
    );

    // API mutations: BackgroundSync
    const bgSyncPlugin = new BackgroundSyncPlugin('offline-mutations', {
      maxRetentionTime: 24 * 60,
      onSync: async ({ queue }) => { ... }
    });
    registerRoute(
      ({ url }) => url.pathname.startsWith('/api/'),
      new NetworkOnly({ plugins: [bgSyncPlugin] }),
      'POST'
    );

    // Live data: NetworkFirst with short TTL
    registerRoute(
      ({ url }) => url.pathname.includes('/live/'),
      new NetworkFirst({
        cacheName: 'live-data',
        networkTimeoutSeconds: 3,
        plugins: [new ExpirationPlugin({ maxAgeSeconds: 60 })]
      })
    );
    ```
  </action>
  <verify>
    - app/sw.ts exists with Workbox imports and route handlers
    - scripts/build-sw.ts compiles SW to public/sw.js
    - next.config.ts modified to run build script
    - public/sw.js is generated after build
    - SW includes precaching, StaleWhileRevalidate for pages, BackgroundSync for API
    - Live routes use NetworkFirst with 60s TTL
    - `npm run build` completes without SW errors
  </verify>
  <done>
    Service Worker created with Workbox: precaching, runtime caching, Background Sync, and NetworkFirst for live data
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Service Worker Registration and Offline UI</name>
  <files>
    - components/service-worker-register.tsx
    - hooks/use-offline-queue.ts
    - components/offline-banner.tsx
  </files>
  <action>
    Create React components for Service Worker registration and offline status UI per RESEARCH.md code examples.

    components/service-worker-register.tsx:
    - 'use client' component
    - Register SW at /sw.js on mount
    - Listen for 'updatefound' to prompt user for update
    - Handle registration errors gracefully
    - Render null (no UI)

    hooks/use-offline-queue.ts:
    - Track isOnline state via window online/offline events
    - Listen for SW messages (SYNC_COMPLETE) to update queue count
    - Expose { isOnline, queueCount }

    components/offline-banner.tsx:
    - 'use client' component using useOfflineQueue
    - Fixed banner at bottom of screen
    - Shows amber background when offline with "You're offline" message
    - Shows green background when online with pending sync count
    - Uses Lucide icons (CloudOff, CloudCheck)
    - Animate presence for smooth transitions

    All components per RESEARCH.md examples but adapted for the project.
  </action>
  <verify>
    - components/service-worker-register.tsx exists and exports component
    - hooks/use-offline-queue.ts exists and exports hook
    - components/offline-banner.tsx exists and exports component
    - SW registration uses '/sw.js' path
    - Offline banner shows appropriate states (online/offline/syncing)
    - TypeScript compiles without errors
  </verify>
  <done>
    Service Worker registration component and offline UI components created
  </done>
</task>

</tasks>

<verification>
After this plan completes:
1. IndexedDB schema and operations are in place
2. Service Worker is generated and handles precaching
3. Background Sync is configured for offline mutations
4. Live data uses NetworkFirst (not cached stale)
5. Offline banner shows connection status
6. SW registration component is ready
7. All components compile and build succeeds
</verification>

<success_criteria>
- IndexedDB stores: teams, players, matches, offline_actions with sync_status
- lib/db/index.ts exports getDB() with upgrade logic
- lib/db/actions.ts exports queueOfflineAction, getPendingActions
- Service Worker at public/sw.js with Workbox precaching
- StaleWhileRevalidate for pages, CacheFirst for static
- BackgroundSyncPlugin for API mutations
- NetworkFirst with 60s TTL for /live/* routes
- ServiceWorkerRegister component for registration
- useOfflineQueue hook for tracking status
- OfflineBanner component for UI feedback
- Build completes with SW generation
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-03-SUMMARY.md` documenting:
- IndexedDB schema and stores
- Service Worker caching strategies
- Background Sync configuration
- Offline UI components
- How to test offline functionality
</output>
