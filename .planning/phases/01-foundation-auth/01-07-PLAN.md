---
phase: 01-foundation-auth
plan: 07
type: execute
wave: 4
depends_on:
  - "01-01"
  - "01-02"
  - "01-03"
  - "01-04"
  - "01-05"
  - "01-06"
files_modified:
  - app/layout.tsx
  - app/[locale]/layout.tsx
  - app/page.tsx (redirect)
  - app/[locale]/dashboard/page.tsx
  - components/navigation/header.tsx
  - components/navigation/user-menu.tsx
  - lib/supabase/actions.ts
  - README.md
autonomous: false

must_haves:
  truths:
    - "All components integrated and working together"
    - "Auth flow complete from login to dashboard"
    - "Offline status indicator visible"
    - "Theme and language switchers functional"
    - "App passes Lighthouse PWA audit"
    - "User can verify full auth and offline flow"
  artifacts:
    - path: "app/[locale]/dashboard/page.tsx"
      provides: "Protected dashboard page"
    - path: "components/navigation/header.tsx"
      provides: "App header with navigation"
    - path: "components/navigation/user-menu.tsx"
      provides: "User menu with logout"
    - path: "lib/supabase/actions.ts"
      provides: "Server actions for auth"
  key_links:
    - from: "app/[locale]/dashboard/page.tsx"
      to: "lib/supabase/server.ts"
      via: "auth check"
    - from: "components/navigation/user-menu.tsx"
      to: "lib/supabase/client.ts"
      via: "logout"
    - from: "app/[locale]/layout.tsx"
      to: "components/service-worker-register.tsx"
      via: "SW registration"
---

<objective>
Integrate all Phase 1 components, add protected routes with auth guards, and create final verification checkpoint.

Purpose: This plan ties together all previous work into a cohesive application. It adds navigation, protected routes, server actions, and ensures all systems work together before user verification.

Output: Fully integrated Phase 1 application with auth flow, offline support, theme/i18n, and a checkpoint for user to verify all success criteria.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md
@.planning/phases/01-foundation-auth/01-03-SUMMARY.md
@.planning/phases/01-foundation-auth/01-04-SUMMARY.md
@.planning/phases/01-foundation-auth/01-05-SUMMARY.md
@.planning/phases/01-foundation-auth/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate Service Worker and Providers in Layout</name>
  <files>
    - app/layout.tsx
    - app/[locale]/layout.tsx
  </files>
  <action>
    Integrate all providers and Service Worker registration into the root layouts.

    app/layout.tsx (root):
    - Keep minimal - just pass through to [locale] or handle redirect
    - May just re-export or redirect to default locale

    app/[locale]/layout.tsx (modify from Plan 06):
    - Import and include ServiceWorkerRegister component
    - Import and include OfflineBanner component
    - Ensure order: ThemeProvider -> NextIntlClientProvider -> children
    - Add suppressHydrationWarning to html
    - Set proper metadata base for PWA

    The layout should now include:
    1. ThemeProvider (dark/light mode)
    2. NextIntlClientProvider (i18n)
    3. ServiceWorkerRegister (PWA registration)
    4. OfflineBanner (sync status)
    5. Children (page content)

    Verify all imports resolve and TypeScript compiles.
  </action>
  <verify>
    - app/layout.tsx exists and is minimal
    - app/[locale]/layout.tsx includes all providers
    - ServiceWorkerRegister is imported and used
    - OfflineBanner is imported and used
    - Provider nesting is correct
    - `npm run build` compiles without errors
  </verify>
  <done>
    Root layout integrates all providers: theme, i18n, Service Worker, and offline banner
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Protected Dashboard and Navigation</name>
  <files>
    - app/page.tsx (redirect)
    - app/[locale]/dashboard/page.tsx
    - components/navigation/header.tsx
    - components/navigation/user-menu.tsx
    - lib/supabase/actions.ts
  </files>
  <action>
    Create protected dashboard page and navigation components.

    app/page.tsx (root redirect):
    - Redirect to /it/ (default locale)
    - Or show language selection landing

    app/[locale]/dashboard/page.tsx:
    - Server Component that checks auth
    - Import createClient from @/lib/supabase/server
    - Call supabase.auth.getUser()
    - Redirect to /auth/login if no user
    - Show dashboard UI if authenticated
    - Display user email and welcome message
    - Placeholder for team/match lists (Phase 2+)

    components/navigation/header.tsx:
    - Fixed header with app name/logo
    - ThemeToggle component
    - LocaleSwitcher component
    - UserMenu component
    - Mobile-optimized (hamburger menu for small screens)

    components/navigation/user-menu.tsx:
    - 'use client'
    - Show user email or avatar
    - Dropdown with: Profile (placeholder), Settings (placeholder), Logout
    - Logout calls supabase.auth.signOut()
    - Redirect to login after logout

    lib/supabase/actions.ts:
    - Server Actions for auth operations
    - logout action that calls cookies().delete
    - getUser action for server-side auth checks

    Ensure dashboard is protected - only authenticated users can access.
  </action>
  <verify>
    - app/[locale]/dashboard/page.tsx exists with auth check
    - components/navigation/header.tsx exists
    - components/navigation/user-menu.tsx exists with logout
    - lib/supabase/actions.ts exports server actions
    - Unauthenticated users redirect to login
    - `npm run build` compiles without errors
  </verify>
  <done>
    Protected dashboard with navigation header, user menu, and auth guards
  </done>
</task>

<task type="auto">
  <name>Task 3: Final Integration and Build Verification</name>
  <files>
    - README.md
    - package.json (verify scripts)
    - .env.example (verify)
  </files>
  <action>
    Perform final integration checks and documentation.

    1. Verify all environment variables are documented:
       - Update .env.example with all required vars
       - Ensure README.md has setup instructions

    2. Add npm scripts if needed:
       - "build": "next build && npm run build:sw" (if SW build is separate)
       - "build:sw": "ts-node scripts/build-sw.ts"

    3. Create/update README.md with:
       - Project description
       - Tech stack
       - Setup instructions (env vars, Supabase config)
       - Development commands
       - PWA testing guide

    4. Run final build check:
       - npm run build
       - Verify no TypeScript errors
       - Verify SW is generated in public/
       - Check manifest is accessible

    5. Update next.config.ts:
       - Ensure images config for PWA icons
       - Add any missing webpack config for Workbox

    6. Clean up any placeholder files:
       - Remove .gitkeep files
       - Ensure all components are properly exported

    Document any manual steps needed before user testing.
  </action>
  <verify>
    - .env.example has all required variables
    - README.md has setup instructions
    - npm run build completes successfully
    - public/sw.js exists after build
    - public/manifest.webmanifest is accessible
    - No TypeScript or build errors
  </verify>
  <done>
    Final integration complete, build verified, documentation updated
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1 implementation with:
    - Authentication (email, password, Google OAuth)
    - Session persistence across refreshes
    - Service Worker with app shell caching
    - IndexedDB for offline data
    - Background Sync for offline mutations
    - Dark/light theme support
    - Italian/English i18n
    - Onboarding tutorial
    - Protected dashboard
    - Offline status indicator
  </what-built>
  <how-to-verify>
    **Prerequisites:**
    1. Fill in .env.local with your Supabase credentials (from Supabase Dashboard)
    2. Enable Google OAuth in Supabase (Authentication -> Providers -> Google)
    3. Run `npm run dev` to start development server

    **Verification Steps:**

    1. **App loads and PWA works:**
       - Visit http://localhost:3000
       - Check that app loads without errors
       - Open DevTools -> Application -> Manifest: verify manifest is valid
       - Check Service Worker is registered

    2. **Authentication flow:**
       - Click "Sign Up" and create account with email
       - Check email for confirmation (or check Supabase Auth logs)
       - Log out and log back in
       - Try Google OAuth (requires Google Provider setup in Supabase)
       - Verify session persists after page refresh

    3. **Offline functionality:**
       - Open DevTools -> Network -> Offline checkbox
       - Refresh page: should show cached content or offline page
       - Make some action while offline (if applicable)
       - Re-enable network: check offline banner shows "syncing"

    4. **Theme and i18n:**
       - Toggle dark/light mode: should switch immediately
       - Switch language between IT/EN: text should update
       - Check system theme detection works

    5. **Onboarding:**
       - Clear localStorage or use incognito
       - First visit should show tutorial
       - Complete or skip tutorial

    6. **Mobile test (if possible):**
       - Test on actual mobile device
       - Verify touch targets are large enough
       - Check that auth forms work on small screens

    **Expected Results:**
    - All auth flows complete successfully
    - App works offline (shows cached data or offline page)
    - Theme and language switch immediately
    - No console errors
    - Lighthouse PWA score 90+
  </how-to-verify>
  <resume-signal>
    Type "approved" if all criteria pass, or describe any issues found:
    - Does auth work? (yes/no/issues)
    - Does offline mode work? (yes/no/issues)
    - Any console errors? (list them)
    - Any UI issues? (describe)
  </resume-signal>
</task>

</tasks>

<verification>
After this plan completes:
1. All components are integrated in layout
2. Dashboard is protected and accessible only to authenticated users
3. Navigation includes theme toggle, language switcher, and user menu
4. Build completes with no errors
5. Documentation is complete
6. User has verified all success criteria
</verification>

<success_criteria>
- Root layout integrates all providers correctly
- ServiceWorkerRegister included in layout
- OfflineBanner displays at bottom of screen
- Dashboard page at /dashboard with auth protection
- Header navigation with theme, locale, and user menus
- User menu with logout functionality
- Server actions for logout
- Build completes successfully
- Lighthouse PWA audit passes
- User has verified all Phase 1 success criteria
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-07-SUMMARY.md` documenting:
- Integration approach
- Protected route strategy
- User verification results
- Known issues or limitations
- Phase 1 completion status
</output>
