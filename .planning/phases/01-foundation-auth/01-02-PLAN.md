---
phase: 01-foundation-auth
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/supabase/client.ts
  - lib/supabase/server.ts
  - lib/supabase/middleware.ts
  - middleware.ts
  - app/auth/callback/route.ts
autonomous: true

must_haves:
  truths:
    - "Supabase browser client created with PKCE flow support"
    - "Supabase server client works with Next.js 15 Server Components"
    - "Middleware refreshes auth sessions automatically"
    - "OAuth callback handler exchanges code for session"
  artifacts:
    - path: "lib/supabase/client.ts"
      provides: "Browser client for Client Components"
      exports: ["createClient"]
    - path: "lib/supabase/server.ts"
      provides: "Server client for Server Components"
      exports: ["createClient"]
    - path: "lib/supabase/middleware.ts"
      provides: "Session refresh for middleware"
      exports: ["updateSession"]
    - path: "middleware.ts"
      provides: "Next.js middleware for auth + i18n"
      exports: ["config"]
    - path: "app/auth/callback/route.ts"
      provides: "OAuth callback handler"
      exports: ["GET"]
  key_links:
    - from: "middleware.ts"
      to: "lib/supabase/middleware.ts"
      via: "import"
      pattern: "updateSession"
    - from: "app/auth/callback/route.ts"
      to: "lib/supabase/server.ts"
      via: "createClient import"
      pattern: "createClient"
---

<objective>
Configure Supabase Auth with SSR support for Next.js 15, including browser client, server client, middleware session refresh, and OAuth callback handler.

Purpose: Authentication is the foundation for all user-specific features. This plan implements the complete auth infrastructure using @supabase/ssr per RESEARCH.md recommendations (PKCE flow, cookie-based sessions, automatic refresh).

Output: Full Supabase auth configuration with clients for browser/server, middleware for session management, and OAuth callback route.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-PLAN.md (if SUMMARY exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase Browser Client</name>
  <files>
    - lib/supabase/client.ts
  </files>
  <action>
    Create the browser client for Client Components using @supabase/ssr. This client runs in the browser and handles PKCE OAuth flow.

    Implementation per RESEARCH.md Pattern 3:
    - Use createBrowserClient from @supabase/ssr
    - Read env vars: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY
    - Export as createClient function
    - Add proper TypeScript types

    Code structure:
    ```typescript
    import { createBrowserClient } from '@supabase/ssr';
    
    export function createClient() {
      return createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
      );
    }
    ```

    IMPORTANT: This is a Client Component utility ('use client' not needed in lib files, will be used in 'use client' components).
  </action>
  <verify>
    - File exists at lib/supabase/client.ts
    - Exports createClient function
    - Uses createBrowserClient from @supabase/ssr
    - References correct env var names
    - TypeScript compiles without errors
  </verify>
  <done>
    Browser client created at lib/supabase/client.ts using createBrowserClient from @supabase/ssr
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase Server Client</name>
  <files>
    - lib/supabase/server.ts
  </files>
  <action>
    Create the server client for Server Components using @supabase/ssr with cookie handling.

    Implementation per RESEARCH.md Pattern 3:
    - Use createServerClient from @supabase/ssr
    - Import cookies from next/headers
    - Implement getAll and setAll cookie methods
    - Handle the case where setAll is called from Server Component (can be ignored if middleware handles refresh)

    Code structure:
    ```typescript
    import { createServerClient } from '@supabase/ssr';
    import { cookies } from 'next/headers';
    
    export async function createClient() {
      const cookieStore = await cookies();
      
      return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
          cookies: {
            getAll() {
              return cookieStore.getAll();
            },
            setAll(cookiesToSet) {
              try {
                cookiesToSet.forEach(({ name, value, options }) => {
                  cookieStore.set(name, value, options);
                });
              } catch {
                // Ignore if called from Server Component - middleware handles refresh
              }
            },
          },
        }
      );
    }
    ```

    Note: In Next.js 15, cookies() is async, so this function must be async.
  </action>
  <verify>
    - File exists at lib/supabase/server.ts
    - Exports async createClient function
    - Uses createServerClient from @supabase/ssr
    - Imports cookies from next/headers
    - Implements getAll and setAll methods
    - TypeScript compiles without errors
  </verify>
  <done>
    Server client created at lib/supabase/server.ts with cookie handling for Server Components
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Auth Middleware for Session Refresh</name>
  <files>
    - lib/supabase/middleware.ts
    - middleware.ts
  </files>
  <action>
    Create middleware for automatic session refresh and auth protection.

    Implementation per RESEARCH.md Pattern 3:
    1. Create lib/supabase/middleware.ts with updateSession function:
       - Use createServerClient from @supabase/ssr
       - Call supabase.auth.getUser() to refresh session
       - Optional: Add route protection logic (redirect to /auth/login if no user)
       - Return the response with updated cookies

    2. Create middleware.ts at project root:
       - Import updateSession from lib/supabase/middleware
       - Export middleware function that calls updateSession
       - Export config with matcher for all routes except static files
       - Combine with i18n middleware (will be extended in Plan 06)

    Code structure for lib/supabase/middleware.ts:
    ```typescript
    import { createServerClient } from '@supabase/ssr';
    import { NextResponse, type NextRequest } from 'next/server';
    
    export async function updateSession(request: NextRequest) {
      let supabaseResponse = NextResponse.next({ request });
      
      const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
          cookies: {
            getAll() { return request.cookies.getAll(); },
            setAll(cookiesToSet) {
              cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value));
              supabaseResponse = NextResponse.next({ request });
              cookiesToSet.forEach(({ name, value, options }) => 
                supabaseResponse.cookies.set(name, value, options)
              );
            },
          },
        }
      );
      
      await supabase.auth.getUser(); // Refresh session
      return supabaseResponse;
    }
    ```

    Code structure for middleware.ts:
    ```typescript
    import { type NextRequest } from 'next/server';
    import { updateSession } from '@/lib/supabase/middleware';
    
    export async function middleware(request: NextRequest) {
      return await updateSession(request);
    }
    
    export const config = {
      matcher: ['/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'],
    };
    ```
  </action>
  <verify>
    - lib/supabase/middleware.ts exists with updateSession function
    - middleware.ts exists at project root
    - Middleware imports and calls updateSession
    - Config matcher excludes static files
    - `npm run build` compiles without errors
  </verify>
  <done>
    Middleware configured for automatic session refresh using @supabase/ssr
  </done>
</task>

<task type="auto">
  <name>Task 4: Create OAuth Callback Route</name>
  <files>
    - app/auth/callback/route.ts
  </files>
  <action>
    Create the OAuth callback handler for Google sign-in and email confirmation.

    Implementation per RESEARCH.md Pattern 3 (Google OAuth with PKCE):
    - Create app/auth/callback/route.ts
    - Extract code from search params
    - Exchange code for session using server client
    - Redirect to home or specified 'next' path
    - Handle errors by redirecting to error page

    Code structure:
    ```typescript
    import { createClient } from '@/lib/supabase/server';
    import { NextResponse } from 'next/server';
    
    export async function GET(request: Request) {
      const { searchParams, origin } = new URL(request.url);
      const code = searchParams.get('code');
      const next = searchParams.get('next') ?? '/';
      
      if (code) {
        const supabase = await createClient();
        const { error } = await supabase.auth.exchangeCodeForSession(code);
        if (!error) {
          return NextResponse.redirect(`${origin}${next}`);
        }
      }
      
      return NextResponse.redirect(`${origin}/auth/auth-code-error`);
    }
    ```

    This handles:
    - Google OAuth callback
    - Email confirmation links
    - Password reset confirmation
  </action>
  <verify>
    - File exists at app/auth/callback/route.ts
    - Exports GET handler
    - Extracts code from search params
    - Calls exchangeCodeForSession
    - Redirects on success/failure
    - Uses server client from lib/supabase/server
  </verify>
  <done>
    OAuth callback route created at app/auth/callback/route.ts for PKCE flow
  </done>
</task>

</tasks>

<verification>
After this plan completes:
1. `npm run build` compiles without errors
2. lib/supabase/client.ts exports browser client
3. lib/supabase/server.ts exports async server client
4. lib/supabase/middleware.ts exports updateSession
5. middleware.ts is configured and runs
6. app/auth/callback/route.ts handles OAuth callbacks
7. All files use @supabase/ssr properly
</verification>

<success_criteria>
- Browser client (lib/supabase/client.ts) using createBrowserClient
- Server client (lib/supabase/server.ts) using createServerClient with cookie handling
- Middleware (lib/supabase/middleware.ts + middleware.ts) for session refresh
- OAuth callback route (app/auth/callback/route.ts) for PKCE exchange
- All clients properly typed and exported
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-02-SUMMARY.md` documenting:
- Supabase client architecture (browser vs server)
- Middleware configuration
- OAuth callback flow
- Integration with upcoming auth UI (Plan 05)
</output>
