---
phase: 02-team-management
plan: 05
type: execute
wave: 4
depends_on:
  - 02-01
  - 02-02
  - 02-03
files_modified:
  - lib/db/teams.ts
  - lib/db/players.ts
  - components/teams/team-roster-manager.tsx
  - components/players/player-actions.tsx
  - app/[locale]/teams/[teamId]/roster/page.tsx
  - messages/it.json
  - messages/en.json
autonomous: true

must_haves:
  truths:
    - "Team admin can remove players from team (soft delete)"
    - "Team admin can assign co-admin privileges to other members"
    - "Admin can transfer ownership to another member"
    - "Role changes are validated (only admin can promote/demote)"
    - "Roster shows all members with their roles and join date"
    - "Actions have confirmation dialogs to prevent accidents"
  artifacts:
    - path: "lib/db/teams.ts"
      provides: "Updated with member management functions"
      exports: ["removePlayer", "updateMemberRole", "transferOwnership"]
    - path: "components/teams/team-roster-manager.tsx"
      provides: "Roster management UI for admins"
      exports: ["TeamRosterManager"]
    - path: "components/players/player-actions.tsx"
      provides: "Player action menu (remove, edit, etc.)"
      exports: ["PlayerActions"]
    - path: "app/[locale]/teams/[teamId]/roster/page.tsx"
      provides: "Team roster page"
      contains: ["Member list", "Role management", "Remove actions"]
  key_links:
    - from: "components/teams/team-roster-manager.tsx"
      to: "lib/db/teams.ts"
      via: "updateMemberRole function"
      pattern: "updateMemberRole\\("
    - from: "TeamRosterManager"
      to: "AlertDialog"
      via: "Confirmation dialogs for destructive actions"
      pattern: "AlertDialog.*remove|confirm"
    - from: "app/[locale]/teams/[teamId]/roster/page.tsx"
      to: "RLS policies"
      via: "is_team_admin check"
      pattern: "role === 'admin'"
---

<objective>
Implement team admin features for roster management (TEAM-07, TEAM-08) including player removal and co-admin assignment.

Purpose: Enables team admins to manage their roster and delegate privileges - essential for team administration.
Output: Roster management UI with role assignment, player removal, and confirmation dialogs.
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-team-management/02-RESEARCH.md
@lib/db/schema.ts
@lib/db/teams.ts

## Database Schema (from 02-01)
- team_members table with role column: 'admin' | 'co-admin' | 'member'
- Only one admin per team (created_by in teams table)
- Soft delete on players preserves match history

## Security
- RLS policies enforce admin-only actions
- Client-side should also check role before showing UI
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add member management functions to teams.ts</name>
  <files>lib/db/teams.ts</files>
  <action>
Extend lib/db/teams.ts with member management operations:

```typescript
/**
 * Member Management Operations
 * Added to lib/db/teams.ts
 */

import type { TeamMember } from './schema';

/**
 * Get team members with their details
 */
export async function getTeamMembers(teamId: string): Promise<TeamMember[]> {
  const db = await getDB();
  const members = await db.getAllFromIndex('team_members', 'by-team-id', teamId);
  return members;
}

/**
 * Update member role (admin only)
 */
export async function updateMemberRole(
  teamId: string,
  memberId: string,
  newRole: 'admin' | 'co-admin' | 'member'
): Promise<void> {
  const db = await getDB();
  const member = await db.get('team_members', memberId);

  if (!member || member.team_id !== teamId) {
    throw new Error('Member not found');
  }

  const updated: TeamMember = {
    ...member,
    role: newRole,
  };

  await db.put('team_members', updated);

  // Queue for sync
  await queueOfflineAction('update', 'team_members', {
    id: memberId,
    role: newRole,
  });
}

/**
 * Remove member from team (soft delete via separate flag or hard delete)
 * Using hard delete for memberships (no history needed)
 */
export async function removeTeamMember(
  teamId: string,
  memberId: string
): Promise<void> {
  const db = await getDB();
  const member = await db.get('team_members', memberId);

  if (!member || member.team_id !== teamId) {
    throw new Error('Member not found');
  }

  // Cannot remove the creator/admin without transferring ownership first
  if (member.role === 'admin') {
    throw new Error('Cannot remove admin. Transfer ownership first.');
  }

  await db.delete('team_members', memberId);

  // Queue for sync
  await queueOfflineAction('delete', 'team_members', {
    id: memberId,
    team_id: teamId,
  });
}

/**
 * Transfer team ownership to another member
 */
export async function transferOwnership(
  teamId: string,
  currentAdminId: string,
  newAdminId: string
): Promise<void> {
  const db = await getDB();

  // Update current admin to member
  const currentMembers = await db.getAllFromIndex('team_members', 'by-team-id', teamId);
  const currentAdmin = currentMembers.find(
    m => m.user_id === currentAdminId && m.role === 'admin'
  );
  const newAdmin = currentMembers.find(
    m => m.user_id === newAdminId
  );

  if (!currentAdmin || !newAdmin) {
    throw new Error('Members not found');
  }

  // Demote current admin to member
  await updateMemberRole(teamId, currentAdmin.id, 'member');

  // Promote new admin
  await updateMemberRole(teamId, newAdmin.id, 'admin');

  // Also update teams.created_by (requires server action or additional sync)
  // For now, this is handled by the offline queue
}
```

NOTE: Cannot remove admin directly - must transfer ownership first. Hard delete for memberships (unlike players) since no history needed. All changes queued for sync.
  </action>
  <verify>TypeScript compiles; functions exported properly</verify>
  <done>Member management functions added: getTeamMembers, updateMemberRole, removeTeamMember, transferOwnership</done>
</task>

<task type="auto">
  <name>Task 2: Create team roster manager component</name>
  <files>components/teams/team-roster-manager.tsx</files>
  <action>
Create roster management component for admins:

```typescript
'use client';

import { useState } from 'react';
import { useTranslations } from 'next-intl';
import { getTeamMembers, updateMemberRole, removeTeamMember } from '@/lib/db/teams';
import { createClient } from '@/lib/supabase/client';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import { MoreHorizontal, Shield, User, UserCog, Trash2 } from 'lucide-react';
import type { TeamMember } from '@/lib/db/schema';

interface TeamRosterManagerProps {
  teamId: string;
  members: TeamMember[];
  currentUserId: string;
  isAdmin: boolean;
  onMembersChange: () => void;
}

interface MemberWithUser extends TeamMember {
  email?: string;
  fullName?: string;
}

export function TeamRosterManager({
  teamId,
  members,
  currentUserId,
  isAdmin,
  onMembersChange,
}: TeamRosterManagerProps) {
  const t = useTranslations('roster');
  const [memberToRemove, setMemberToRemove] = useState<TeamMember | null>(null);
  const [isRemoving, setIsRemoving] = useState(false);

  const handleRoleChange = async (memberId: string, newRole: string) => {
    if (!isAdmin) return;

    try {
      await updateMemberRole(teamId, memberId, newRole as 'admin' | 'co-admin' | 'member');
      onMembersChange();
    } catch (error) {
      console.error('Failed to update role:', error);
    }
  };

  const handleRemove = async () => {
    if (!memberToRemove) return;

    setIsRemoving(true);
    try {
      await removeTeamMember(teamId, memberToRemove.id);
      setMemberToRemove(null);
      onMembersChange();
    } catch (error) {
      console.error('Failed to remove member:', error);
    } finally {
      setIsRemoving(false);
    }
  };

  const getRoleIcon = (role: string) => {
    switch (role) {
      case 'admin':
        return <Shield className="h-4 w-4 text-primary" />;
      case 'co-admin':
        return <UserCog className="h-4 w-4 text-muted-foreground" />;
      default:
        return <User className="h-4 w-4 text-muted-foreground" />;
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>{t('title')}</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {members.map((member) => (
            <div
              key={member.id}
              className="flex items-center justify-between p-3 border rounded-lg"
            >
              <div className="flex items-center gap-3">
                {getRoleIcon(member.role)}
                <div>
                  <p className="font-medium">
                    {member.user_id === currentUserId ? t('you') : member.user_id?.slice(0, 8)}
                  </p>
                  <p className="text-sm text-muted-foreground capitalize">
                    {t(`roles.${member.role}`)}
                  </p>
                </div>
              </div>

              {isAdmin && member.user_id !== currentUserId && (
                <div className="flex items-center gap-2">
                  <Select
                    value={member.role}
                    onValueChange={(value) => handleRoleChange(member.id, value)}
                  >
                    <SelectTrigger className="w-32 h-10">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="member">{t('roles.member')}</SelectItem>
                      <SelectItem value="co-admin">{t('roles.coAdmin')}</SelectItem>
                      <SelectItem value="admin">{t('roles.admin')}</SelectItem>
                    </SelectContent>
                  </Select>

                  <AlertDialog>
                    <AlertDialogTrigger asChild>
                      <Button
                        variant="ghost"
                        size="icon"
                        className="h-10 w-10 text-destructive"
                        onClick={() => setMemberToRemove(member)}
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </AlertDialogTrigger>
                    <AlertDialogContent>
                      <AlertDialogHeader>
                        <AlertDialogTitle>{t('remove.confirmTitle')}</AlertDialogTitle>
                        <AlertDialogDescription>
                          {t('remove.confirmDescription')}
                        </AlertDialogDescription>
                      </AlertDialogHeader>
                      <AlertDialogFooter>
                        <AlertDialogCancel onClick={() => setMemberToRemove(null)}>
                          {t('remove.cancel')}
                        </AlertDialogCancel>
                        <AlertDialogAction
                          onClick={handleRemove}
                          disabled={isRemoving}
                          className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                        >
                          {isRemoving ? t('remove.removing') : t('remove.confirm')}
                        </AlertDialogAction>
                      </AlertDialogFooter>
                    </AlertDialogContent>
                  </AlertDialog>
                </div>
              )}

              {!isAdmin && (
                <span className="text-sm text-muted-foreground capitalize">
                  {t(`roles.${member.role}`)}
                </span>
              )}
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
```

NOTE: Shows all members with role icons. Admin can change roles via dropdown and remove members via alert dialog. Self cannot be removed (transfer ownership first). Confirmation dialog prevents accidents.
  </action>
  <verify>Component compiles; AlertDialog and Select available in shadcn/ui</verify>
  <done>Roster manager with role selection, member removal, and confirmation dialogs</done>
</task>

<task type="auto">
  <name>Task 3: Create team roster page</name>
  <files>app/[locale]/teams/[teamId]/roster/page.tsx</files>
  <action>
Create the team roster page:

```typescript
'use client';

import { useEffect, useState, useCallback } from 'react';
import { useParams } from 'next/navigation';
import { useTranslations } from 'next-intl';
import { getTeamMembers } from '@/lib/db/teams';
import { getPlayersByTeam } from '@/lib/db/players';
import { TeamRosterManager } from '@/components/teams/team-roster-manager';
import { PlayerList } from '@/components/players/player-list';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ArrowLeft, Users, UserCircle } from 'lucide-react';
import Link from 'next/link';
import { createClient } from '@/lib/supabase/client';
import type { TeamMember, Player } from '@/lib/db/schema';

export default function TeamRosterPage() {
  const t = useTranslations('roster');
  const params = useParams();
  const teamId = params.teamId as string;

  const [members, setMembers] = useState<TeamMember[]>([]);
  const [players, setPlayers] = useState<Player[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [currentUserId, setCurrentUserId] = useState<string | null>(null);
  const [isAdmin, setIsAdmin] = useState(false);

  const loadData = useCallback(async () => {
    try {
      const [membersData, playersData] = await Promise.all([
        getTeamMembers(teamId),
        getPlayersByTeam(teamId),
      ]);

      setMembers(membersData);
      setPlayers(playersData);

      // Check current user role
      const supabase = createClient();
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        setCurrentUserId(user.id);
        const userMembership = membersData.find(m => m.user_id === user.id);
        setIsAdmin(userMembership?.role === 'admin' || userMembership?.role === 'co-admin');
      }
    } catch (error) {
      console.error('Failed to load roster:', error);
    } finally {
      setIsLoading(false);
    }
  }, [teamId]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  if (isLoading) {
    return (
      <div className="container mx-auto px-4 py-8">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-muted rounded w-1/3" />
          <div className="h-64 bg-muted rounded" />
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8">
      <div className="mb-6">
        <Link href={`/teams/${teamId}`}>
          <Button variant="ghost" className="pl-0">
            <ArrowLeft className="mr-2 h-4 w-4" />
            {t('backToTeam')}
          </Button>
        </Link>
      </div>

      <h1 className="text-2xl font-bold mb-6">{t('pageTitle')}</h1>

      <Tabs defaultValue="players" className="space-y-6">
        <TabsList className="grid w-full grid-cols-2">
          <TabsTrigger value="players" className="flex items-center gap-2">
            <UserCircle className="h-4 w-4" />
            {t('tabs.players')}
          </TabsTrigger>
          <TabsTrigger value="members" className="flex items-center gap-2">
            <Users className="h-4 w-4" />
            {t('tabs.members')}
          </TabsTrigger>
        </TabsList>

        <TabsContent value="players">
          <PlayerList
            teamId={teamId}
            players={players}
            isAdmin={isAdmin}
            onPlayersChange={loadData}
          />
        </TabsContent>

        <TabsContent value="members">
          <TeamRosterManager
            teamId={teamId}
            members={members}
            currentUserId={currentUserId || ''}
            isAdmin={isAdmin}
            onMembersChange={loadData}
          />
        </TabsContent>
      </Tabs>
    </div>
  );
}
```

NOTE: Two tabs - Players (from Plan 03) and Members (roster management). Shows current user's role. Only admins see management controls.
  </action>
  <verify>Page compiles; Tabs component available</verify>
  <done>Team roster page with players and members tabs</done>
</task>

<task type="auto">
  <name>Task 4: Add roster translations</name>
  <files>
    messages/it.json
    messages/en.json
  </files>
  <action>
Add roster management translations:

**messages/it.json:**
```json
{
  "roster": {
    "pageTitle": "Rosa squadra",
    "backToTeam": "Torna alla squadra",
    "title": "Membri della squadra",
    "you": "Tu",
    "tabs": {
      "players": "Giocatori",
      "members": "Membri"
    },
    "roles": {
      "admin": "Admin",
      "coAdmin": "Co-Admin",
      "member": "Membro"
    },
    "remove": {
      "confirmTitle": "Rimuovi membro",
      "confirmDescription": "Sei sicuro di voler rimuovere questo membro dalla squadra?",
      "cancel": "Annulla",
      "confirm": "Rimuovi",
      "removing": "Rimozione..."
    }
  }
}
```

Add corresponding English translations to messages/en.json.
  </action>
  <verify>JSON valid; no duplicate keys</verify>
  <done>Roster translations added</done>
</task>

</tasks>

<verification>
After completion:
1. Admin can view team roster at /teams/[teamId]/roster
2. Members tab shows all members with roles
3. Admin can change member roles via dropdown
4. Admin can remove members with confirmation dialog
5. Self cannot be removed (admin transfer required)
6. Players tab shows player list from Plan 03
</verification>

<success_criteria>
- Admin can remove players from team (TEAM-07)
- Admin can assign co-admin privileges (TEAM-08)
- Role changes persist and sync
- Confirmation dialogs prevent accidental removals
- Roster view shows all members with roles (TEAM-09)
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-management/02-05-SUMMARY.md`
</output>
