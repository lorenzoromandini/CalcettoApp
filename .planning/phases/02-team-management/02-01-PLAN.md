---
phase: 02-team-management
plan: 01
type: execute
wave: 1
depends_on: ["01-07"]
files_modified: [
  "supabase/migrations/20260215000001_teams_players_invites.sql",
  "lib/db/schema.ts",
  "lib/db/index.ts",
  "types/database.ts"
]
autonomous: true

must_haves:
  truths:
    - "teams table exists with RLS policies"
    - "team_members junction table links users to teams with roles"
    - "players table exists with roles array and sync_status (team-agnostic)"
    - "player_teams junction table supports players in multiple teams with jersey numbers"
    - "team_invites table exists with token and expiration"
    - "RLS helper functions is_team_admin, is_team_member, and is_player_in_team exist"
    - "Indexes on team_members(team_id, user_id) and player_teams(player_id, team_id) for performance"
    - "Unique constraints prevent duplicate player memberships and duplicate jersey numbers within a team"
    - "IndexedDB schema extended for team_members, player_teams, and invites"
  artifacts:
    - path: "supabase/migrations/20260215000001_teams_players_invites.sql"
      provides: "Database schema with RLS"
      contains: ["CREATE TABLE teams", "CREATE TABLE team_members", "CREATE TABLE players", "CREATE TABLE player_teams", "CREATE TABLE team_invites"]
    - path: "lib/db/schema.ts"
      provides: "Extended TypeScript types"
      exports: ["TeamMember", "TeamInvite", "TeamRole", "PlayerTeam"]
    - path: "types/database.ts"
      provides: "Supabase database types"
      exports: ["Database"]
  key_links:
    - from: "lib/db/schema.ts"
      to: "supabase/migrations"
      via: "TypeScript types match database schema"
    - from: "team_members.team_id"
      to: "teams.id"
      via: "foreign key with CASCADE delete"
    - from: "player_teams.player_id"
      to: "players.id"
      via: "foreign key with CASCADE delete"
---

<objective>
Create database schema for team management with proper RLS policies, indexes, and offline-first support.

Purpose: Establishes the data foundation for all team-related features (teams, players, memberships, invites). Proper RLS ensures users only access their own teams while maintaining performance.

Output: Database migration with teams, team_members, players, team_invites tables; updated TypeScript schemas; optimized indexes.
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-team-management/02-RESEARCH.md
@lib/db/schema.ts
@lib/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration with teams, team_members, players, team_invites tables</name>
  <files>supabase/migrations/20260215000001_teams_players_invites.sql</files>
  <action>Create a Supabase migration file with complete schema:

1. **teams table:**
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - name VARCHAR(100) NOT NULL
   - description TEXT
   - team_mode VARCHAR(10) CHECK (team_mode IN ('5-a-side', '8-a-side')) DEFAULT '5-a-side'
   - created_by UUID REFERENCES auth.users(id) NOT NULL
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - updated_at TIMESTAMPTZ DEFAULT NOW()
   - deleted_at TIMESTAMPTZ (for soft delete, preserve match history)
   - sync_status VARCHAR(20) DEFAULT 'synced' (for offline-first tracking)

2. **team_members junction table:**
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - team_id UUID REFERENCES teams(id) ON DELETE CASCADE NOT NULL
   - user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE
   - player_id UUID REFERENCES players(id) ON DELETE SET NULL (for non-registered players)
   - role VARCHAR(20) CHECK (role IN ('admin', 'co-admin', 'member')) DEFAULT 'member'
   - joined_at TIMESTAMPTZ DEFAULT NOW()
   - UNIQUE(team_id, user_id)

 3. **players table:**
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - name VARCHAR(50) NOT NULL
   - surname VARCHAR(50)
   - nickname VARCHAR(50)
   - avatar_url TEXT
   - user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL (link to auth user if registered)
   - roles TEXT[] DEFAULT '{}' (array of 'goalkeeper', 'defender', 'midfielder', 'attacker')
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - updated_at TIMESTAMPTZ DEFAULT NOW()
   - sync_status VARCHAR(20) DEFAULT 'synced'
   - NOTE: team_id and jersey_number REMOVED - now in player_teams table to support multi-team players

4. **player_teams junction table:** (NEW - supports players in multiple teams)
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - player_id UUID REFERENCES players(id) ON DELETE CASCADE NOT NULL
   - team_id UUID REFERENCES teams(id) ON DELETE CASCADE NOT NULL
   - jersey_number INTEGER CHECK (jersey_number >= 1 AND jersey_number <= 99) NOT NULL
   - joined_at TIMESTAMPTZ DEFAULT NOW()
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - sync_status VARCHAR(20) DEFAULT 'synced'
   - UNIQUE(player_id, team_id) - a player can only be in a team once
   - UNIQUE(team_id, jersey_number) - jersey numbers must be unique within a team

5. **team_invites table:**
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - team_id UUID REFERENCES teams(id) ON DELETE CASCADE NOT NULL
   - created_by UUID REFERENCES auth.users(id) NOT NULL
   - token VARCHAR(64) UNIQUE NOT NULL
   - email VARCHAR(255) (optional for targeted invites)
   - expires_at TIMESTAMPTZ NOT NULL
   - used_at TIMESTAMPTZ
   - used_by UUID REFERENCES auth.users(id)
   - max_uses INTEGER DEFAULT 50
   - use_count INTEGER DEFAULT 0
   - created_at TIMESTAMPTZ DEFAULT NOW()

 6. **Enable RLS on all tables:**
   - ALTER TABLE teams ENABLE ROW LEVEL SECURITY
   - ALTER TABLE team_members ENABLE ROW LEVEL SECURITY
   - ALTER TABLE players ENABLE ROW LEVEL SECURITY
   - ALTER TABLE player_teams ENABLE ROW LEVEL SECURITY
   - ALTER TABLE team_invites ENABLE ROW LEVEL SECURITY

7. **Create helper functions (SECURITY DEFINER for performance):**
   - is_team_admin(team_uuid UUID) - checks if auth.uid() is admin/co-admin
   - is_team_member(team_uuid UUID) - checks if auth.uid() is any member
   - is_player_in_team(player_uuid UUID, team_uuid UUID) - checks player membership

8. **RLS Policies:**
   - Teams: SELECT for members, UPDATE for admins, INSERT for authenticated (sets created_by)
   - Team_members: SELECT for members, ALL for admins
   - Players: SELECT for team members via player_teams join, ALL for team admins
   - Player_teams: SELECT for team members, ALL for admins
   - Team_invites: ALL for admins, SELECT for valid invites by token

9. **Indexes for performance:**
   - team_members(team_id, user_id)
   - team_members(user_id)
   - player_teams(player_id, team_id)
   - player_teams(team_id)
   - player_teams(team_id, jersey_number) - for uniqueness check
   - team_invites(token)
   - team_invites(team_id)

Reference RESEARCH.md for exact SQL patterns. Use soft delete (deleted_at) on teams to preserve match history per research recommendations.</action>
  <verify>Run `supabase migration up` locally and verify tables created with `\dt` in SQL editor. Check RLS policies with `\dp`. Verify player_teams has unique constraints on (player_id, team_id) and (team_id, jersey_number).</verify>
  <done>Migration applies successfully, all 5 tables exist (teams, team_members, players, player_teams, team_invites) with RLS enabled, indexes created, helper functions defined. Player_teams unique constraints prevent duplicate memberships and duplicate jersey numbers within a team.</done>
</task>

<task type="auto">
  <name>Task 2: Extend IndexedDB schema with team_members and team_invites support</name>
  <files>lib/db/schema.ts, lib/db/index.ts</files>
  <action>Extend existing IndexedDB schema for offline-first team management:

1. **Update lib/db/schema.ts:**
   - Add `TeamMember` interface with: id, team_id, user_id, player_id, role, joined_at, sync_status
   - Add `TeamInvite` interface with: id, team_id, created_by, token, email, expires_at, used_at, used_by, max_uses, use_count
   - Add `PlayerTeam` interface with: id, player_id, team_id, jersey_number, joined_at, sync_status (NEW - tracks player membership in teams)
   - Add `TeamRole` type: 'admin' | 'co-admin' | 'member'
   - Update `Team` interface to include: team_mode ('5-a-side' | '8-a-side'), created_by, deleted_at, sync_status
   - Update `Player` interface: remove team_id and jersey_number (moved to PlayerTeam), keep surname, nickname, avatar_url, user_id, roles
   - Extend `CalcettoDB` schema with 'team_members', 'team_invites', and 'player_teams' stores
   - Add indexes: 'team_members': by-team-id, by-user-id, by-sync-status; 'team_invites': by-team-id, by-token; 'player_teams': by-player-id, by-team-id, by-sync-status

2. **Update lib/db/index.ts:**
   - In the `openDB` call, increment version number for schema migration
   - Add object store creation for 'team_members', 'team_invites', and 'player_teams' in upgrade callback
   - Create indexes on new stores matching the schema definitions

Maintain compatibility with existing 'teams', 'players', 'matches', 'offline_actions' stores. The schema should support the offline action queue pattern from Phase 1.</action>
  <verify>Run TypeScript compiler `npx tsc --noEmit` on lib/db/schema.ts and lib/db/index.ts with no errors.</verify>
  <done>TypeScript types compile, IndexedDB schema includes all team-related entities (including player_teams junction) with proper indexes.</done>
</task>

<task type="auto">
  <name>Task 3: Generate Supabase database types</name>
  <files>types/database.ts</files>
  <action>Generate TypeScript types from Supabase database schema:

1. Run Supabase CLI to generate types:
   - `supabase gen types typescript --local > types/database.ts`
   - Or if using linked project: `supabase gen types typescript --project-id <project-ref> > types/database.ts`

2. Verify generated types include:
   - Database['public']['Tables']['teams']
   - Database['public']['Tables']['team_members']
   - Database['public']['Tables']['players']
   - Database['public']['Tables']['player_teams'] (NEW - for multi-team players)
   - Database['public']['Tables']['team_invites']
   - All enum types and relationships

3. Export Database type and helper types for use in the app

If Supabase CLI generation fails, manually create types based on the schema migration, but prefer generated types for accuracy.</action>
  <verify>types/database.ts exists and exports Database type with all 5 tables properly typed (including player_teams).</verify>
  <done>Database types generated, imports work in TypeScript files.</done>
</task>

</tasks>

<verification>
- Migration file exists and contains all 5 tables (teams, team_members, players, player_teams, team_invites)
- player_teams table has unique constraints on (player_id, team_id) and (team_id, jersey_number)
- RLS policies properly restrict access based on team membership
- Helper functions use SECURITY DEFINER for performance
- Indexes exist on team_members(team_id, user_id), player_teams(player_id, team_id), and team_invites(token)
- IndexedDB schema updated with new stores including player_teams
- TypeScript types compile without errors
</verification>

<success_criteria>
1. Database migration creates teams, team_members, players, player_teams, team_invites tables
2. player_teams junction enables players to belong to multiple teams with unique jersey numbers per team
3. RLS policies enforce team-based access control
4. IndexedDB schema supports offline storage of team data with multi-team player support
5. TypeScript types reflect database schema accurately
6. All tables have sync_status field for offline-first tracking
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-management/02-01-SUMMARY.md`
</output>
