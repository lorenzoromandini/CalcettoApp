---
phase: 02-team-management
plan: 06
type: execute
wave: 5
depends_on:
  - 02-01
  - 02-02
  - 02-03
  - 02-04
  - 02-05
files_modified:
  - app/[locale]/teams/[teamId]/page.tsx
  - components/navigation/team-nav.tsx
  - components/teams/team-dashboard.tsx
  - middleware.ts
  - app/[locale]/dashboard/page.tsx
autonomous: false

must_haves:
  truths:
    - "Team dashboard shows team info, player count, upcoming matches placeholder"
    - "Team navigation accessible from dashboard with quick actions"
    - "All team routes are protected (require authentication)"
    - "User can navigate between team list, roster, settings seamlessly"
    - "Team context is maintained across navigation"
    - "Integration tests pass - full CRUD operations work end-to-end"
  artifacts:
    - path: "app/[locale]/teams/[teamId]/page.tsx"
      provides: "Team dashboard page"
      contains: ["Team info", "Player count", "Quick actions", "Navigation"]
    - path: "components/teams/team-dashboard.tsx"
      provides: "Team dashboard UI component"
      exports: ["TeamDashboard"]
    - path: "components/navigation/team-nav.tsx"
      provides: "Team navigation tabs"
      exports: ["TeamNav"]
    - path: "app/[locale]/dashboard/page.tsx"
      provides: "Main dashboard with team access"
      contains: ["Team list", "Quick create button"]
  key_links:
    - from: "app/[locale]/teams/[teamId]/page.tsx"
      to: "/teams/[teamId]/roster"
      via: "Roster navigation link"
    - from: "app/[locale]/teams/[teamId]/page.tsx"
      to: "/teams/[teamId]/settings"
      via: "Settings navigation link"
    - from: "middleware.ts"
      to: "protected routes"
      via: "Auth check for /teams/*"
      pattern: "matcher.*teams"
---

<objective>
Integrate all team management features into cohesive user experience with team dashboard, navigation, and verification checkpoint.

Purpose: Ties together all Phase 2 features into a complete, usable flow. Provides entry point from main dashboard and team context navigation.
Output: Team dashboard page, navigation components, auth protection, and verification that all features work together.
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-team-management/02-RESEARCH.md
@.planning/phases/02-team-management/02-01-SUMMARY.md
@.planning/phases/02-team-management/02-02-SUMMARY.md
@.planning/phases/02-team-management/02-03-SUMMARY.md
@.planning/phases/02-team-management/02-04-SUMMARY.md
@.planning/phases/02-team-management/02-05-SUMMARY.md

## Completed Components
- Database schema (Plan 01)
- Team CRUD (Plan 02)
- Player management with avatars (Plan 03)
- Invite system (Plan 04)
- Admin features (Plan 05)

## Integration Points
- Main dashboard needs team list access
- Team dashboard needs navigation to roster/settings
- Auth protection for all /teams/* routes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update middleware for team route protection</name>
  <files>middleware.ts</files>
  <action>
Ensure middleware protects all team routes. Update the matcher pattern if needed:

Check that middleware.ts includes /teams/* in the protected routes matcher:

```typescript
export const config = {
  matcher: [
    '/',
    '/(it|en)/:path*',
    '/teams/:path*',  // Protect all team routes
    '/dashboard/:path*',
  ],
};
```

The existing auth middleware should already handle session validation. Just verify the matcher includes team routes.

If the middleware doesn't have a matcher config, add one that protects:
- /teams/* (all team routes)
- /dashboard/* (dashboard)
- /api/* (API routes)

And excludes:
- /auth/* (auth pages)
- /_next/* (Next.js internals)
- /static/* (static files)
- /favicon.ico
- /manifest.webmanifest
</action>
  <verify>Middleware compiles and matcher regex is valid</verify>
  <done>Team routes protected by auth middleware</done>
</task>

<task type="auto">
  <name>Task 2: Create team navigation component</name>
  <files>components/navigation/team-nav.tsx</files>
  <action>
Create team navigation component for team dashboard:

```typescript
'use client';

import { useTranslations } from 'next-intl';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { cn } from '@/lib/utils';
import { Users, Settings, Trophy, Calendar } from 'lucide-react';

interface TeamNavProps {
  teamId: string;
  isAdmin: boolean;
}

export function TeamNav({ teamId, isAdmin }: TeamNavProps) {
  const t = useTranslations('teamNav');
  const pathname = usePathname();

  const navItems = [
    {
      href: `/teams/${teamId}`,
      label: t('overview'),
      icon: Trophy,
      exact: true,
    },
    {
      href: `/teams/${teamId}/players`,
      label: t('players'),
      icon: Users,
    },
    {
      href: `/teams/${teamId}/roster`,
      label: t('roster'),
      icon: Users,
    },
    {
      href: `/teams/${teamId}/settings`,
      label: t('settings'),
      icon: Settings,
      adminOnly: true,
    },
  ];

  return (
    <nav className="flex gap-1 overflow-x-auto pb-2">
      {navItems.map((item) => {
        if (item.adminOnly && !isAdmin) return null;

        const isActive = item.exact
          ? pathname === item.href
          : pathname.startsWith(item.href);

        return (
          <Link
            key={item.href}
            href={item.href}
            className={cn(
              'flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors',
              isActive
                ? 'bg-primary text-primary-foreground'
                : 'text-muted-foreground hover:bg-muted hover:text-foreground'
            )}
          >
            <item.icon className="h-4 w-4" />
            {item.label}
          </Link>
        );
      })}
    </nav>
  );
}
```

NOTE: Horizontal scrollable nav for mobile. Shows admin-only items only for admins. Active state based on current pathname.
  </action>
  <verify>Component compiles; cn utility available</verify>
  <done>Team navigation with overview, players, roster, and settings links</done>
</task>

<task type="auto">
  <name>Task 3: Create team dashboard component</name>
  <files>components/teams/team-dashboard.tsx</files>
  <action>
Create team dashboard component:

```typescript
'use client';

import { useTranslations } from 'next-intl';
import Link from 'next/link';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Users, UserPlus, Settings, Share2, Calendar, TrendingUp } from 'lucide-react';
import type { Team } from '@/lib/db/schema';

interface TeamDashboardProps {
  team: Team;
  playerCount: number;
  memberCount: number;
  isAdmin: boolean;
}

export function TeamDashboard({
  team,
  playerCount,
  memberCount,
  isAdmin,
}: TeamDashboardProps) {
  const t = useTranslations('teamDashboard');

  return (
    <div className="space-y-6">
      {/* Team Header */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold">{team.name}</h1>
          {team.description && (
            <p className="text-muted-foreground mt-1">{team.description}</p>
          )}
          <div className="flex items-center gap-2 mt-2">
            <Badge variant={team.team_mode === '5-a-side' ? 'default' : 'secondary'}>
              {team.team_mode === '5-a-side' ? '5 vs 5' : '8 vs 8'}
            </Badge>
            {team.sync_status === 'pending' && (
              <Badge variant="outline" className="text-yellow-600">
                {t('syncing')}
              </Badge>
            )}
          </div>
        </div>

        {isAdmin && (
          <div className="flex gap-2">
            <Link href={`/teams/${team.id}/settings`}>
              <Button variant="outline" className="h-12">
                <Settings className="mr-2 h-4 w-4" />
                {t('settings')}
              </Button>
            </Link>
          </div>
        )}
      </div>

      {/* Stats Cards */}
      <div className="grid gap-4 md:grid-cols-3">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              {t('stats.players')}
            </CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{playerCount}</div>
            <p className="text-xs text-muted-foreground">
              {t('stats.registeredPlayers')}
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              {t('stats.members')}
            </CardTitle>
            <Share2 className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{memberCount}</div>
            <p className="text-xs text-muted-foreground">
              {t('stats.teamMembers')}
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              {t('stats.matches')}
            </CardTitle>
            <Calendar className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">-</div>
            <p className="text-xs text-muted-foreground">
              {t('stats.upcomingMatches')}
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Quick Actions */}
      <div className="grid gap-4 md:grid-cols-2">
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5" />
              {t('actions.players.title')}
            </CardTitle>
            <CardDescription>{t('actions.players.description')}</CardDescription>
          </CardHeader>
          <CardContent>
            <Link href={`/teams/${team.id}/players`}>
              <Button className="w-full h-12">
                {t('actions.players.button')}
              </Button>
            </Link>
          </CardContent>
        </Card>

        {isAdmin && (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Share2 className="h-5 w-5" />
                {t('actions.invite.title')}
              </CardTitle>
              <CardDescription>{t('actions.invite.description')}</CardDescription>
            </CardHeader>
            <CardContent>
              <Link href={`/teams/${team.id}/settings`}>
                <Button variant="outline" className="w-full h-12">
                  {t('actions.invite.button')}
                </Button>
              </Link>
            </CardContent>
          </Card>
        )}
      </div>

      {/* Placeholder for upcoming matches */}
      <Card className="border-dashed">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <TrendingUp className="h-5 w-5" />
            {t('matches.title')}
          </CardTitle>
          <CardDescription>{t('matches.description')}</CardDescription>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-muted-foreground text-center py-8">
            {t('matches.placeholder')}
          </p>
        </CardContent>
      </Card>
    </div>
  );
}
```

NOTE: Shows team info, stats cards (players, members, matches placeholder), and quick action cards. Placeholder for matches which comes in Phase 3.
  </action>
  <verify>Component compiles</verify>
  <done>Team dashboard with stats, quick actions, and navigation</done>
</task>

<task type="auto">
  <name>Task 4: Create team detail page</name>
  <files>app/[locale]/teams/[teamId]/page.tsx</files>
  <action>
Create the main team detail page:

```typescript
import { createClient } from '@/lib/supabase/server';
import { redirect, notFound } from 'next/navigation';
import { TeamDashboard } from '@/components/teams/team-dashboard';
import { TeamNav } from '@/components/navigation/team-nav';

interface TeamPageProps {
  params: Promise<{
    teamId: string;
  }>;
}

export default async function TeamPage({ params }: TeamPageProps) {
  const { teamId } = await params;
  const supabase = await createClient();

  // Check auth
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    redirect('/auth/login');
  }

  // Get team
  const { data: team } = await supabase
    .from('teams')
    .select('*')
    .eq('id', teamId)
    .is('deleted_at', null)
    .single();

  if (!team) {
    notFound();
  }

  // Check membership
  const { data: membership } = await supabase
    .from('team_members')
    .select('role')
    .eq('team_id', teamId)
    .eq('user_id', user.id)
    .single();

  if (!membership) {
    redirect('/teams');
  }

  // Get counts
  const { count: playerCount } = await supabase
    .from('players')
    .select('*', { count: 'exact', head: true })
    .eq('team_id', teamId)
    .is('deleted_at', null);

  const { count: memberCount } = await supabase
    .from('team_members')
    .select('*', { count: 'exact', head: true })
    .eq('team_id', teamId);

  const isAdmin = membership.role === 'admin' || membership.role === 'co-admin';

  return (
    <div className="container mx-auto px-4 py-8">
      <TeamNav teamId={teamId} isAdmin={isAdmin} />
      
      <div className="mt-6">
        <TeamDashboard
          team={team}
          playerCount={playerCount || 0}
          memberCount={memberCount || 0}
          isAdmin={isAdmin}
        />
      </div>
    </div>
  );
}
```

NOTE: Server component for data fetching. Redirects non-members. Shows 404 for deleted/non-existent teams. Passes isAdmin to child components.
  </action>
  <verify>Page compiles; TypeScript types correct for async params</verify>
  <done>Team detail page with dashboard and navigation</done>
</task>

<task type="auto">
  <name>Task 5: Update main dashboard with team access</name>
  <files>app/[locale]/dashboard/page.tsx</files>
  <action>
Update or create the main dashboard page with team quick access:

```typescript
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Plus, Users } from 'lucide-react';

export default async function DashboardPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect('/auth/login');
  }

  // Get user's teams
  const { data: memberships } = await supabase
    .from('team_members')
    .select('team_id, role, teams(id, name, description, team_mode)')
    .eq('user_id', user.id);

  const teams = memberships?.map(m => ({
    id: m.team_id,
    ...(m.teams as unknown as { name: string; description: string; team_mode: string }),
    role: m.role,
  })) || [];

  return (
    <div className="container mx-auto px-4 py-8">
      <div className="flex items-center justify-between mb-8">
        <h1 className="text-3xl font-bold">Dashboard</h1>
        <Link href="/teams/create">
          <Button className="h-12">
            <Plus className="mr-2 h-4 w-4" />
            Nuova squadra
          </Button>
        </Link>
      </div>

      {teams.length === 0 ? (
        <Card className="text-center py-12">
          <CardContent>
            <Users className="mx-auto h-12 w-12 text-muted-foreground mb-4" />
            <h2 className="text-xl font-semibold mb-2">Nessuna squadra</h2>
            <p className="text-muted-foreground mb-6">
              Crea la tua prima squadra per iniziare
            </p>
            <Link href="/teams/create">
              <Button size="lg" className="h-12">
                Crea squadra
              </Button>
            </Link>
          </CardContent>
        </Card>
      ) : (
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {teams.map((team) => (
            <Link key={team.id} href={`/teams/${team.id}`}>
              <Card className="hover:shadow-md transition-shadow cursor-pointer h-full">
                <CardHeader>
                  <CardTitle>{team.name}</CardTitle>
                </CardHeader>
                <CardContent>
                  {team.description && (
                    <p className="text-sm text-muted-foreground line-clamp-2 mb-4">
                      {team.description}
                    </p>
                  )}
                  <div className="flex items-center justify-between text-sm">
                    <span className="text-muted-foreground capitalize">
                      {team.team_mode}
                    </span>
                    <span className="text-muted-foreground capitalize">
                      {team.role}
                    </span>
                  </div>
                </CardContent>
              </Card>
            </Link>
          ))}
        </div>
      )}
    </div>
  );
}
```

NOTE: Main entry point showing user's teams. Quick create button. Empty state for new users. Links to team dashboards.
  </action>
  <verify>Page compiles; fetches teams via Supabase</verify>
  <done>Main dashboard with team list and quick access</done>
</task>

<task type="auto">
  <name>Task 6: Add dashboard and navigation translations</name>
  <files>
    messages/it.json
    messages/en.json
  </files>
  <action>
Add remaining translations for dashboard and navigation:

**messages/it.json:**
```json
{
  "teamNav": {
    "overview": "Panoramica",
    "players": "Giocatori",
    "roster": "Rosa",
    "settings": "Impostazioni"
  },
  "teamDashboard": {
    "syncing": "Sincronizzazione...",
    "settings": "Impostazioni",
    "stats": {
      "players": "Giocatori",
      "registeredPlayers": "Giocatori registrati",
      "members": "Membri",
      "teamMembers": "Membri della squadra",
      "matches": "Partite",
      "upcomingMatches": "Prossime partite"
    },
    "actions": {
      "players": {
        "title": "Gestisci giocatori",
        "description": "Aggiungi, modifica o rimuovi giocatori dalla squadra",
        "button": "Vai ai giocatori"
      },
      "invite": {
        "title": "Invita membri",
        "description": "Condividi il link di invito per far entrare nuovi membri",
        "button": "Genera invito"
      }
    },
    "matches": {
      "title": "Prossime partite",
      "description": "Visualizza e gestisci le partite programmate",
      "placeholder": "Nessuna partita programmata. Le partite verranno aggiunte in una fase futura."
    }
  }
}
```

Add corresponding English translations to messages/en.json.
  </action>
  <verify>JSON valid; no duplicate keys</verify>
  <done>Dashboard and navigation translations added</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 Team Management system with database, CRUD operations, player management, invite system, and admin features</what-built>
  <how-to-verify>
1. **Database Setup:**
   - Run all Supabase migrations
   - Verify tables: teams, team_members, players, team_invites
   - Check RLS policies are active
   - Confirm avatars storage bucket exists

2. **Team Creation Flow:**
   - Navigate to /teams
   - Click "Nuova squadra" / "New team"
   - Fill form: name (required), description (optional), select 5-a-side or 8-a-side
   - Submit - team should appear in list
   - Verify creator is admin

3. **Player Management:**
   - Go to team dashboard → "Giocatori" / "Players"
   - Click "Aggiungi giocatore" / "Add player"
   - Fill: name (required), surname, nickname, jersey number (1-99)
   - Upload avatar - crop dialog should appear
   - Select multiple roles (goalkeeper, defender, midfielder, attacker)
   - Save - player appears in list with avatar and role badges

4. **Invite System:**
   - Go to team settings (admin only)
   - Click "Genera link di invito" / "Generate invite link"
   - Copy link or share via WhatsApp
   - Open link in incognito window
   - Login and join team
   - Verify new member appears in roster

5. **Admin Features:**
   - Go to team roster
   - Change member role (member → co-admin)
   - Try to remove member (with confirmation dialog)
   - Verify permissions work correctly

6. **Offline Test:**
   - Disconnect internet
   - Create a player - should show "Sincronizzazione" badge
   - Reconnect - badge should disappear
   - Verify data synced to server
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After completion:
1. /teams shows user's team list
2. /teams/create allows creating new team
3. /teams/[teamId] shows team dashboard
4. Navigation between team sections works
5. All routes require authentication
6. Full integration test passes
</verification>

<success_criteria>
- Complete team management flow works end-to-end
- All 10 TEAM requirements satisfied (TEAM-01 through TEAM-10)
- Authentication protects all team routes
- UI is mobile-responsive
- All text translated (IT/EN)
- Offline functionality works with sync status
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-management/02-06-SUMMARY.md`
</output>
