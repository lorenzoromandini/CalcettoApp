---
phase: 02-team-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [
  "lib/db/teams.ts",
  "lib/validations/team.ts",
  "app/[locale]/teams/page.tsx",
  "app/[locale]/teams/create/page.tsx",
  "components/teams/team-form.tsx",
  "components/teams/team-card.tsx",
  "hooks/use-teams.ts",
  "messages/it.json",
  "messages/en.json"
]
autonomous: true

must_haves:
  truths:
    - "User can create a team with name and description"
    - "User can select team mode (5-a-side or 8-a-side)"
    - "Created team appears in user's team list"
    - "Team creator is automatically assigned admin role"
    - "Teams are cached offline and sync when reconnected"
  artifacts:
    - path: "app/[locale]/teams/page.tsx"
      provides: "Team list view"
      exports: ["default"]
    - path: "app/[locale]/teams/create/page.tsx"
      provides: "Team creation form"
      exports: ["default"]
    - path: "lib/db/teams.ts"
      provides: "Team database operations"
      exports: ["createTeam", "getUserTeams", "getTeam"]
    - path: "components/teams/team-form.tsx"
      provides: "Reusable team form UI"
      exports: ["TeamForm"]
  key_links:
    - from: "app/[locale]/teams/create/page.tsx"
      to: "lib/db/teams.ts"
      via: "createTeam function call"
    - from: "lib/db/teams.ts"
      to: "supabase"
      via: "Supabase client INSERT/SELECT"
    - from: "app/[locale]/teams/page.tsx"
      to: "hooks/use-teams.ts"
      via: "useTeams hook for data fetching"
---

<objective>
Implement team creation and listing functionality with offline-first support.

Purpose: Enables users to create teams (TEAM-01) and view their team list (TEAM-09) with proper role assignment and team mode selection (TEAM-10). This is the foundation for all team-based features.

Output: Working team creation form, team list page, offline-capable data layer with admin role assignment.
</objective>

<execution_context>
@C:/Users/mikei/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/mikei/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-team-management/02-RESEARCH.md
@.planning/phases/02-team-management/02-01-SUMMARY.md
@lib/db/schema.ts
@lib/db/actions.ts
@lib/supabase/client.ts
@lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create team validation schema and database operations</name>
  <files>lib/validations/team.ts, lib/db/teams.ts</files>
  <action>Create validation and database layers for team operations:

1. **lib/validations/team.ts** - Zod validation schemas:
   - `createTeamSchema`: name (min 2, max 100 chars), description (max 500, optional), team_mode (enum: '5-a-side', '8-a-side', default '5-a-side')
   - `updateTeamSchema`: same fields, all optional
   - Export TypeScript types: CreateTeamInput, UpdateTeamInput

2. **lib/db/teams.ts** - Team database operations with offline-first support:
   - `createTeam(data: CreateTeamInput, userId: string): Promise<string>`
     - Generate UUID for team
     - Insert into Supabase teams table with created_by = userId
     - Also insert into team_members with role = 'admin'
     - Cache in IndexedDB with sync_status = 'synced'
     - Return team ID
   - `getUserTeams(userId: string): Promise<Team[]>`
     - Query team_members for user's memberships
     - Join with teams table
     - Filter out deleted teams (deleted_at IS NULL)
     - Cache results in IndexedDB
   - `getTeam(teamId: string): Promise<Team | null>`
     - Get single team by ID
     - Check RLS (will be enforced by policy)
     - Cache in IndexedDB
   - `updateTeam(teamId: string, data: UpdateTeamInput): Promise<void>`
     - Update team in Supabase
     - Update IndexedDB cache
     - Queue offline action if needed

3. Follow existing patterns from lib/db/actions.ts for offline queue integration.
   - Use queueOfflineAction when Supabase is unavailable
   - Optimistic updates with IndexedDB
   - Handle sync_status tracking

4. Use proper error handling with try/catch and user-friendly error messages.</action>
  <verify>Run TypeScript compiler on lib/validations/team.ts and lib/db/teams.ts with no errors. Verify Zod schemas validate correctly with test data.</verify>
  <done>Validation schemas and database operations created with proper TypeScript types and offline support.</done>
</task>

<task type="auto">
  <name>Task 2: Create useTeams hook for data fetching</name>
  <files>hooks/use-teams.ts</files>
  <action>Create React hook for team data management:

1. **hooks/use-teams.ts** with the following functions:
   - `useTeams()` - Returns list of user's teams with loading state
     - Fetch from Supabase via getUserTeams
     - Fallback to IndexedDB when offline
     - Return { teams, isLoading, error, refetch }
   - `useTeam(teamId: string)` - Returns single team details
     - Fetch from Supabase via getTeam
     - Fallback to IndexedDB
     - Return { team, isLoading, error, refetch }
   - `useCreateTeam()` - Returns mutation function
     - Wrap createTeam with proper error handling
     - Invalidate teams cache on success
     - Return { createTeam, isPending, error }

2. Use React Query pattern (or existing data fetching pattern from Phase 1):
   - Handle loading states
   - Error boundaries
   - Cache invalidation
   - Optimistic updates where appropriate

3. Integrate with offline banner to show sync status

4. Export types for use in components</action>
  <verify>Hook compiles without TypeScript errors, returns correct types.</verify>
  <done>useTeams hook provides data fetching with loading states and offline support.</done>
</task>

<task type="auto">
  <name>Task 3: Build team list page and team creation UI</name>
  <files>app/[locale]/teams/page.tsx, app/[locale]/teams/create/page.tsx, components/teams/team-form.tsx, components/teams/team-card.tsx</files>
  <action>Create team management UI components:

1. **components/teams/team-form.tsx** - Reusable team form:
   - Props: onSubmit, initialData?, submitLabel, isLoading
   - Fields: name (text input), description (textarea), team_mode (radio/select)
   - Validation using react-hook-form + Zod (lib/validations/team.ts)
   - Error messages per field
   - Submit button with loading state
   - Mobile-friendly layout (stacked fields, 48px+ touch targets)

2. **components/teams/team-card.tsx** - Team list item:
   - Props: team, onClick?
   - Display: team name, description (truncated), team_mode badge, member count (if available)
   - Touch-friendly card design
   - Hover/active states

3. **app/[locale]/teams/page.tsx** - Teams list page:
   - Fetch teams using useTeams hook
   - Show loading skeleton while fetching
   - Empty state with CTA to create first team
   - Grid/list of team cards
   - "Create Team" button leading to /teams/create
   - Protected route (redirect to login if not authenticated)
   - Use next-intl for translations

4. **app/[locale]/teams/create/page.tsx** - Create team page:
   - Title: "Crea Squadra" / "Create Team"
   - TeamForm component
   - On submit: call createTeam mutation
   - On success: redirect to /teams or new team dashboard
   - Error handling with toast notifications
   - Back button to teams list
   - Protected route

5. **Update messages/it.json and messages/en.json:**
   - Add translation keys for team feature:
     - "teams.title": "Le mie squadre"
     - "teams.create": "Crea squadra"
     - "teams.form.name": "Nome squadra"
     - "teams.form.description": "Descrizione"
     - "teams.form.teamMode": "Modalit√†"
     - "teamMode.5a-side": "Calcio a 5"
     - "teamMode.8a-side": "Calcio a 8"
     - Add validation messages

6. Follow existing UI patterns from Phase 1 (shadcn/ui components, mobile-first design).</action>
  <verify>Build passes (`npm run build`), no TypeScript errors, components render correctly.</verify>
  <done>Team list and creation pages functional with form validation, translations, and mobile-first design.</done>
</task>

</tasks>

<verification>
- User can navigate to /teams and see their team list
- User can click "Create Team" and see creation form
- Form validates input (name required, max lengths)
- User can select 5-a-side or 8-a-side mode
- Creating team adds it to list with admin role
- Teams persist in database and IndexedDB
- Works offline with sync when reconnected
- Italian and English translations work
</verification>

<success_criteria>
1. Team creation form accepts name, description, team mode
2. Created team appears in user's team list immediately
3. Creator is assigned admin role automatically
4. Teams cached offline and sync when online
5. UI is mobile-responsive with 48px+ touch targets
6. All text is translated (IT/EN)
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-management/02-02-SUMMARY.md`
</output>
