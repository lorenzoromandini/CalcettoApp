---
phase: 07-dashboard-leaderboards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/statistics.ts
  - hooks/use-statistics.ts
  - components/dashboard/time-period-filter.tsx
  - messages/it.json
  - messages/en.json
autonomous: true

must_haves:
  truths:
    - "User can filter statistics by time period (season, month, last 3 months)"
    - "Leaderboards update based on selected time period"
    - "All 7 leaderboards respect the time filter"
  artifacts:
    - path: "lib/db/statistics.ts"
      provides: "Time-filtered leaderboard queries"
      contains: "dateRange"
    - path: "components/dashboard/time-period-filter.tsx"
      provides: "Time period selection UI"
      exports: ["TimePeriodFilter", "type TimePeriod", "getDateRangeForPeriod"]
    - path: "hooks/use-statistics.ts"
      provides: "Time-filtered leaderboards hook"
      contains: "dateRange"
  key_links:
    - from: "components/dashboard/time-period-filter.tsx"
      to: "hooks/use-statistics.ts"
      via: "onChange callback with dateRange"
      pattern: "getDateRangeForPeriod"
    - from: "hooks/use-statistics.ts"
      to: "lib/db/statistics.ts"
      via: "dateRange parameter in function calls"
      pattern: "getTopScorers.*dateRange"
---

<objective>
Add time period filtering capability to statistics functions and create a reusable filter component.

Purpose: Enable users to view statistics filtered by season, month, or custom time periods (DASH-07).
Output: Time-filtered statistics functions, TimePeriodFilter component, updated hooks.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns to follow
@lib/db/statistics.ts
@hooks/use-statistics.ts
@components/ratings/rating-trend-chart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dateRange parameter to statistics functions</name>
  <files>lib/db/statistics.ts</files>
  <action>
Extend all 7 leaderboard functions to accept an optional `dateRange?: { start: Date; end: Date }` parameter.

For each function (getTopScorers, getTopAssisters, getTopAppearances, getTopWins, getTopLosses, getTopRatedPlayers, getTopGoalsConceded):
1. Add `dateRange?: { start: Date; end: Date }` parameter
2. Add conditional WHERE clause using Prisma.sql template:
   ```typescript
   ${dateRange ? Prisma.sql`AND m.scheduled_at >= ${dateRange.start} AND m.scheduled_at <= ${dateRange.end}` : Prisma.empty}
   ```

Also update getPlayerStats to accept dateRange parameter for consistency.

Do NOT change default behavior - when dateRange is undefined, return all-time stats as before.
  </action>
  <verify>
    - `grep -n "dateRange" lib/db/statistics.ts | head -20` shows parameter in multiple functions
    - All 7 leaderboard functions have dateRange parameter
    - getPlayerStats has dateRange parameter
  </verify>
  <done>
All 7 leaderboard functions and getPlayerStats accept optional dateRange parameter and correctly filter by scheduled_at when provided.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TimePeriodFilter component with helper functions</name>
  <files>components/dashboard/time-period-filter.tsx</files>
  <action>
Create a reusable time period filter component following shadcn/ui patterns.

```typescript
// Export these types/functions for reuse
export type TimePeriod = 'all' | 'season' | 'last3months' | 'month'

export function getDateRangeForPeriod(period: TimePeriod): { start: Date; end: Date } | undefined {
  const now = new Date()
  switch (period) {
    case 'month':
      return {
        start: new Date(now.getFullYear(), now.getMonth(), 1),
        end: new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59),
      }
    case 'last3months':
      return {
        start: new Date(now.getFullYear(), now.getMonth() - 2, 1),
        end: now,
      }
    case 'season':
      // European football season: September to June
      const seasonStart = now.getMonth() >= 8 
        ? new Date(now.getFullYear(), 8, 1)
        : new Date(now.getFullYear() - 1, 8, 1)
      return {
        start: seasonStart,
        end: now,
      }
    default:
      return undefined
  }
}

export function TimePeriodFilter({ value, onChange }: {
  value: TimePeriod
  onChange: (value: TimePeriod) => void
}): JSX.Element
```

Use shadcn/ui Select component. Follow pattern from existing filter components. Style consistently with dashboard cards.
  </action>
  <verify>
    - `ls components/dashboard/time-period-filter.tsx` file exists
    - `grep "TimePeriodFilter" components/dashboard/time-period-filter.tsx` shows component
    - `grep "getDateRangeForPeriod" components/dashboard/time-period-filter.tsx` shows helper
  </verify>
  <done>
TimePeriodFilter component renders a Select dropdown with options: All Time, This Season, Last 3 Months, This Month. getDateRangeForPeriod correctly calculates date ranges.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update useTeamLeaderboards hook with date range support</name>
  <files>hooks/use-statistics.ts</files>
  <action>
Extend useTeamLeaderboards hook to accept and react to dateRange parameter.

1. Add `dateRange?: { start: Date; end: Date }` parameter to hook
2. Include dateRange in useCallback dependency array
3. Pass dateRange to all 7 leaderboard fetch calls:
   ```typescript
   const [scorers, assisters, ...] = await Promise.all([
     getTopScorers(teamId, 3, dateRange),
     getTopAssisters(teamId, 3, dateRange),
     // ... etc
   ])
   ```

4. Also update usePlayerStats to accept dateRange parameter.

The hook should re-fetch when dateRange changes.
  </action>
  <verify>
    - `grep "dateRange" hooks/use-statistics.ts` shows parameter in useTeamLeaderboards
    - `grep "getTopScorers.*dateRange" hooks/use-statistics.ts` shows passing to query
  </verify>
  <done>
useTeamLeaderboards and usePlayerStats hooks accept optional dateRange parameter and pass it to underlying query functions. Data re-fetches when dateRange changes.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add translations for time period filter</name>
  <files>messages/it.json, messages/en.json</files>
  <action>
Add translation keys for time period options in both Italian and English.

Under `dashboard.period` namespace:
- `all_time`: "Tutto il periodo" / "All Time"
- `season`: "Questa stagione" / "This Season"
- `last_3_months`: "Ultimi 3 mesi" / "Last 3 Months"
- `this_month`: "Questo mese" / "This Month"

Also add a generic `filter_by_period`: "Filtra per periodo" / "Filter by period"
  </action>
  <verify>
    - `grep "period" messages/it.json` shows all time period keys
    - `grep "period" messages/en.json` shows all time period keys
  </verify>
  <done>
Both translation files contain dashboard.period namespace with all_time, season, last_3_months, this_month, and filter_by_period keys.
  </done>
</task>

</tasks>

<verification>
- All statistics functions accept optional dateRange parameter
- TimePeriodFilter component renders correctly with all 4 options
- useTeamLeaderboards re-fetches when dateRange changes
- Translations exist for all time period options
</verification>

<success_criteria>
- User can select time period from dropdown (All Time, Season, Last 3 Months, Month)
- Statistics queries correctly filter by scheduled_at date range
- Hook re-fetches data when time period changes
</success_criteria>

<output>
After completion, create `.planning/phases/07-dashboard-leaderboards/07-01-SUMMARY.md`
</output>
