---
phase: 07-dashboard-leaderboards
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/streaks.ts
  - hooks/use-streaks.ts
  - components/dashboard/attendance-streak-card.tsx
  - messages/it.json
  - messages/en.json
autonomous: true

must_haves:
  truths:
    - "User can see attendance streaks for team players"
    - "Current streak shows consecutive matches attended"
    - "Longest streak shows best historical attendance"
  artifacts:
    - path: "lib/db/streaks.ts"
      provides: "Streak calculation using SQL window functions"
      exports: ["getAttendanceStreaks", "type AttendanceStreak"]
    - path: "hooks/use-streaks.ts"
      provides: "React hook for fetching streaks"
      exports: ["useAttendanceStreaks"]
    - path: "components/dashboard/attendance-streak-card.tsx"
      provides: "Streak display UI with Flame icon"
      exports: ["AttendanceStreakCard"]
  key_links:
    - from: "hooks/use-streaks.ts"
      to: "lib/db/streaks.ts"
      via: "server action import"
      pattern: "getAttendanceStreaks"
    - from: "components/dashboard/attendance-streak-card.tsx"
      to: "hooks/use-streaks.ts"
      via: "useAttendanceStreaks hook"
      pattern: "useAttendanceStreaks.*teamId"
---

<objective>
Create attendance streak calculation and display component for tracking consecutive match attendance.

Purpose: Enable users to see who has the longest attendance streaks (DASH-06).
Output: Streak calculation functions, React hook, AttendanceStreakCard component.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns to follow
@lib/db/statistics.ts
@hooks/use-statistics.ts
@components/statistics/player-leaderboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create streak calculation with SQL window functions</name>
  <files>lib/db/streaks.ts</files>
  <action>
Create a new file for attendance streak calculations using PostgreSQL window functions.

```typescript
'use server'

import { prisma } from '@/lib/db'
import { MatchStatus } from '@prisma/client'

export interface AttendanceStreak {
  player_id: string
  player_name: string
  player_nickname?: string
  player_avatar?: string
  current_streak: number
  longest_streak: number
}

/**
 * Calculate attendance streaks for team players
 * Uses PostgreSQL window functions for consecutive day detection
 * 
 * Definition: Player attended if side IS NOT NULL (actually played)
 */
export async function getAttendanceStreaks(
  teamId: string,
  limit: number = 5
): Promise<AttendanceStreak[]> {
  // Use SQL window functions to find consecutive match streaks
  // Pattern: date - ROW_NUMBER() creates groups for consecutive dates
  const result = await prisma.$queryRaw<{
    player_id: string
    current_streak: bigint
    longest_streak: bigint
  }[]>`
    WITH player_matches AS (
      SELECT DISTINCT
        fp.player_id,
        m.scheduled_at::date as match_date
      FROM formation_positions fp
      JOIN formations f ON fp.formation_id = f.id
      JOIN matches m ON f.match_id = m.id
      WHERE m.team_id = ${teamId}
        AND m.status = 'COMPLETED'
        AND fp.player_id IS NOT NULL
        AND fp.side IS NOT NULL
    ),
    streak_groups AS (
      SELECT 
        player_id,
        match_date,
        match_date - (ROW_NUMBER() OVER (PARTITION BY player_id ORDER BY match_date))::int AS grp
      FROM player_matches
    ),
    streaks AS (
      SELECT 
        player_id,
        COUNT(*) as streak_length,
        grp
      FROM streak_groups
      GROUP BY player_id, grp
    ),
    player_streaks AS (
      SELECT 
        player_id,
        MAX(CASE WHEN grp = 0 THEN streak_length ELSE 0 END) as current_streak,
        MAX(streak_length) as longest_streak
      FROM streaks
      GROUP BY player_id
    )
    SELECT player_id, current_streak, longest_streak
    FROM player_streaks
    WHERE current_streak > 0
    ORDER BY current_streak DESC, longest_streak DESC
    LIMIT ${limit}
  `
  
  // Enrich with player info (follow enrichLeaderboardEntries pattern)
  if (result.length === 0) return []
  
  const playerIds = result.map(r => r.player_id)
  const players = await prisma.player.findMany({
    where: { id: { in: playerIds } },
    select: { id: true, name: true, nickname: true, avatarUrl: true },
  })
  
  const playerMap = new Map(players.map(p => [p.id, p]))
  
  return result.map(r => {
    const player = playerMap.get(r.player_id)
    return {
      player_id: r.player_id,
      player_name: player?.name ?? 'Unknown',
      player_nickname: player?.nickname ?? undefined,
      player_avatar: player?.avatarUrl ?? undefined,
      current_streak: Number(r.current_streak),
      longest_streak: Number(r.longest_streak),
    }
  })
}
```

Key design decisions:
- "Attended" = side IS NOT NULL (actually played, not just RSVP'd)
- Current streak = consecutive matches including most recent
- Longest streak = best historical run
  </action>
  <verify>
    - `ls lib/db/streaks.ts` file exists
    - `grep "ROW_NUMBER" lib/db/streaks.ts` shows window function
    - `grep "side IS NOT NULL" lib/db/streaks.ts` shows attendance definition
    - `grep "getAttendanceStreaks" lib/db/streaks.ts` shows exported function
  </verify>
  <done>
lib/db/streaks.ts exports getAttendanceStreaks function that calculates current and longest streaks using SQL window functions, with player info enrichment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useAttendanceStreaks hook</name>
  <files>hooks/use-streaks.ts</files>
  <action>
Create a React hook following the use-statistics.ts pattern.

```typescript
'use client'

import { useState, useEffect, useCallback } from 'react'
import { getAttendanceStreaks, type AttendanceStreak } from '@/lib/db/streaks'

interface UseAttendanceStreaksReturn {
  streaks: AttendanceStreak[]
  isLoading: boolean
  error: string | null
  refresh: () => Promise<void>
}

export function useAttendanceStreaks(
  teamId: string | null,
  limit: number = 5
): UseAttendanceStreaksReturn {
  const [streaks, setStreaks] = useState<AttendanceStreak[]>([])
  const [isLoading, setIsLoading] = useState(!!teamId)
  const [error, setError] = useState<string | null>(null)

  const fetchStreaks = useCallback(async () => {
    if (!teamId) {
      setStreaks([])
      setIsLoading(false)
      return
    }

    setIsLoading(true)
    setError(null)

    try {
      const result = await getAttendanceStreaks(teamId, limit)
      setStreaks(result)
    } catch (err) {
      const errorMsg = err instanceof Error ? err.message : 'Errore nel caricamento delle serie'
      setError(errorMsg)
      console.error('[useAttendanceStreaks] Fetch error:', err)
    } finally {
      setIsLoading(false)
    }
  }, [teamId, limit])

  useEffect(() => {
    fetchStreaks()
  }, [fetchStreaks])

  return { streaks, isLoading, error, refresh: fetchStreaks }
}
```
  </action>
  <verify>
    - `ls hooks/use-streaks.ts` file exists
    - `grep "useAttendanceStreaks" hooks/use-streaks.ts` shows exported hook
    - `grep "getAttendanceStreaks" hooks/use-streaks.ts` shows import
  </verify>
  <done>
hooks/use-streaks.ts exports useAttendanceStreaks hook with streaks, isLoading, error, and refresh states.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AttendanceStreakCard component</name>
  <files>components/dashboard/attendance-streak-card.tsx</files>
  <action>
Create a card component displaying attendance streaks with visual design.

```typescript
'use client'

import { useTranslations } from 'next-intl'
import Image from 'next/image'
import { Flame, Trophy, User } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import type { AttendanceStreak } from '@/lib/db/streaks'

interface AttendanceStreakCardProps {
  streaks: AttendanceStreak[]
  isLoading?: boolean
  className?: string
}

export function AttendanceStreakCard({
  streaks,
  isLoading = false,
  className,
}: AttendanceStreakCardProps) {
  const t = useTranslations('dashboard')

  // Loading skeleton
  if (isLoading) {
    return (
      <Card className={className}>
        <CardHeader className="pb-2">
          <div className="h-6 w-40 bg-muted rounded animate-pulse" />
        </CardHeader>
        <CardContent className="space-y-3">
          {[1, 2, 3].map((i) => (
            <div key={i} className="flex items-center gap-3 p-2">
              <div className="h-8 w-8 rounded-full bg-muted animate-pulse" />
              <div className="flex-1 space-y-1">
                <div className="h-4 w-24 bg-muted rounded animate-pulse" />
              </div>
              <div className="h-5 w-12 bg-muted rounded animate-pulse" />
            </div>
          ))}
        </CardContent>
      </Card>
    )
  }

  // Empty state
  if (streaks.length === 0) {
    return (
      <Card className={className}>
        <CardHeader className="pb-2">
          <CardTitle className="text-base flex items-center gap-2">
            <Flame className="h-4 w-4 text-orange-500" />
            {t('streaks.title')}
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-center py-6 text-muted-foreground text-sm">
            {t('streaks.no_streaks')}
          </div>
        </CardContent>
      </Card>
    )
  }

  return (
    <Card className={className}>
      <CardHeader className="pb-2">
        <CardTitle className="text-base flex items-center gap-2">
          <Flame className="h-4 w-4 text-orange-500" />
          {t('streaks.title')}
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-2">
        {streaks.map((streak, index) => (
          <div
            key={streak.player_id}
            className="flex items-center gap-3 p-2 rounded-lg hover:bg-muted/50 transition-colors"
          >
            {/* Rank */}
            <div className="flex-shrink-0 w-6 text-center font-bold text-muted-foreground">
              {index + 1}
            </div>

            {/* Player Avatar */}
            <div className="flex-shrink-0">
              {streak.player_avatar ? (
                <div className="relative h-9 w-9 rounded-full overflow-hidden">
                  <Image
                    src={streak.player_avatar}
                    alt={streak.player_name}
                    fill
                    className="object-cover"
                  />
                </div>
              ) : (
                <div className="h-9 w-9 rounded-full bg-primary/10 flex items-center justify-center border border-primary/20">
                  <User className="h-4 w-4 text-primary/60" />
                </div>
              )}
            </div>

            {/* Player Name */}
            <div className="flex-1 min-w-0">
              <div className="font-medium text-sm truncate">
                {streak.player_nickname || streak.player_name}
              </div>
              {streak.player_nickname && (
                <div className="text-xs text-muted-foreground truncate">
                  {streak.player_name}
                </div>
              )}
            </div>

            {/* Current Streak */}
            <div className="flex items-center gap-1 text-orange-500">
              <Flame className="h-4 w-4" />
              <span className="font-bold">{streak.current_streak}</span>
            </div>

            {/* Longest Streak */}
            {streak.longest_streak > streak.current_streak && (
              <div className="text-xs text-muted-foreground">
                ({t('streaks.best')}: {streak.longest_streak})
              </div>
            )}
          </div>
        ))}
      </CardContent>
    </Card>
  )
}
```

Design notes:
- Flame icon with orange color for streaks
- Show current streak prominently
- Show best streak in parentheses if different from current
- Follow PlayerLeaderboard visual pattern
  </action>
  <verify>
    - `ls components/dashboard/attendance-streak-card.tsx` file exists
    - `grep "Flame" components/dashboard/attendance-streak-card.tsx` shows icon usage
    - `grep "current_streak" components/dashboard/attendance-streak-card.tsx` shows streak display
  </verify>
  <done>
AttendanceStreakCard component displays player streaks with Flame icon, current streak count, and best streak when different. Loading and empty states handled.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add translations for streaks</name>
  <files>messages/it.json, messages/en.json</files>
  <action>
Add translation keys for streak feature in both Italian and English.

Under `dashboard.streaks` namespace:
- `title`: "Serie di presenze" / "Attendance Streaks"
- `no_streaks`: "Nessuna serie ancora" / "No streaks yet"
- `best`: "migliore" / "best"
- `current`: "attuale" / "current"
  </action>
  <verify>
    - `grep "streaks" messages/it.json` shows all streak keys
    - `grep "streaks" messages/en.json` shows all streak keys
  </verify>
  <done>
Both translation files contain dashboard.streaks namespace with title, no_streaks, best, and current keys.
  </done>
</task>

</tasks>

<verification>
- getAttendanceStreaks calculates streaks using SQL window functions
- useAttendanceStreaks hook fetches and manages streak state
- AttendanceStreakCard renders streaks with Flame icon and proper styling
- Translations exist for all streak-related text
</verification>

<success_criteria>
- User can see top 5 players with longest current attendance streaks
- Current streak and best streak displayed for each player
- Empty state shown when no completed matches exist
</success_criteria>

<output>
After completion, create `.planning/phases/07-dashboard-leaderboards/07-02-SUMMARY.md`
</output>
