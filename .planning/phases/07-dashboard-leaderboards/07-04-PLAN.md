---
phase: 07-dashboard-leaderboards
plan: 04
type: execute
wave: 2
depends_on:
  - 07-01
files_modified:
  - components/teams/team-dashboard.tsx
  - app/[locale]/teams/[teamId]/stats/stats-page-client.tsx
  - components/dashboard/top-performers-section.tsx
  - app/[locale]/teams/[teamId]/players/[playerId]/player-profile-client.tsx
  - messages/it.json
  - messages/en.json
autonomous: false

must_haves:
  truths:
    - "Team dashboard shows top 4 performers (scorer, assister, GK, MVP)"
    - "Stats page has time period filter that updates all leaderboards"
    - "Player profile shows evolution chart with goals/assists/rating trends"
    - "All dashboard features work correctly with real data"
  artifacts:
    - path: "components/dashboard/top-performers-section.tsx"
      provides: "Quick view of top 4 leaders on team dashboard"
      exports: ["TopPerformersSection"]
    - path: "components/teams/team-dashboard.tsx"
      provides: "Team overview with leaderboards"
      contains: "TopPerformersSection"
    - path: "app/[locale]/teams/[teamId]/stats/stats-page-client.tsx"
      provides: "Stats page with time filter"
      contains: "TimePeriodFilter"
    - path: "app/[locale]/teams/[teamId]/players/[playerId]/player-profile-client.tsx"
      provides: "Player profile with evolution chart"
      contains: "PlayerEvolutionChart"
  key_links:
    - from: "components/dashboard/top-performers-section.tsx"
      to: "hooks/use-statistics.ts"
      via: "useTeamLeaderboards hook"
      pattern: "leaderboards.scorers"
    - from: "app/[locale]/teams/[teamId]/stats/stats-page-client.tsx"
      to: "components/dashboard/time-period-filter.tsx"
      via: "TimePeriodFilter component"
      pattern: "TimePeriodFilter.*onChange"
    - from: "app/[locale]/teams/[teamId]/players/[playerId]/player-profile-client.tsx"
      to: "components/dashboard/player-evolution-chart.tsx"
      via: "PlayerEvolutionChart component"
      pattern: "PlayerEvolutionChart.*data"
---

<objective>
Integrate all Phase 7 features into existing pages: team dashboard, stats page, and player profile.

Purpose: Complete DASH-01 to DASH-08 requirements by adding leaderboards to team dashboard, time filter to stats page, and evolution chart to player profile.
Output: TopPerformersSection component, updated team dashboard, updated stats page with filter, updated player profile with evolution chart.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans
@.planning/phases/07-dashboard-leaderboards/07-01-SUMMARY.md
@.planning/phases/07-dashboard-leaderboards/07-02-SUMMARY.md
@.planning/phases/07-dashboard-leaderboards/07-03-SUMMARY.md

# Files to modify
@components/teams/team-dashboard.tsx
@app/[locale]/teams/[teamId]/stats/stats-page-client.tsx
@app/[locale]/teams/[teamId]/players/[playerId]/player-profile-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TopPerformersSection component</name>
  <files>components/dashboard/top-performers-section.tsx</files>
  <action>
Create a compact section showing the top 4 category leaders (DASH-01 to DASH-04).

```typescript
'use client'

import { useTranslations } from 'next-intl'
import { Trophy } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { PlayerLeaderboard } from '@/components/statistics/player-leaderboard'
import { useTeamLeaderboards } from '@/hooks/use-statistics'
import Link from 'next/link'

interface TopPerformersSectionProps {
  teamId: string
  locale: string
}

export function TopPerformersSection({ teamId, locale }: TopPerformersSectionProps) {
  const t = useTranslations('dashboard')
  const { leaderboards, isLoading } = useTeamLeaderboards(teamId)

  // Check if any data exists
  const hasData = leaderboards.scorers.length > 0 || 
                  leaderboards.assisters.length > 0 ||
                  leaderboards.goalsConceded.length > 0 ||
                  leaderboards.rated.length > 0

  return (
    <Card>
      <CardHeader className="pb-2">
        <div className="flex items-center justify-between">
          <CardTitle className="text-base flex items-center gap-2">
            <Trophy className="h-4 w-4" />
            {t('top_performers.title')}
          </CardTitle>
          {hasData && (
            <Link 
              href={`/${locale}/teams/${teamId}/stats`}
              className="text-sm text-primary hover:underline"
            >
              {t('top_performers.view_all')}
            </Link>
          )}
        </div>
      </CardHeader>
      <CardContent>
        {!isLoading && !hasData && (
          <div className="text-center py-8 text-muted-foreground text-sm">
            {t('top_performers.no_data')}
          </div>
        )}
        
        {(isLoading || hasData) && (
          <div className="grid grid-cols-2 gap-3">
            <PlayerLeaderboard
              title={t('top_performers.top_scorer')}
              entries={leaderboards.scorers.slice(0, 1)}
              valueLabel={t('top_performers.goals')}
              isLoading={isLoading}
            />
            <PlayerLeaderboard
              title={t('top_performers.top_assister')}
              entries={leaderboards.assisters.slice(0, 1)}
              valueLabel={t('top_performers.assists')}
              isLoading={isLoading}
            />
            <PlayerLeaderboard
              title={t('top_performers.best_gk')}
              entries={leaderboards.goalsConceded.slice(0, 1)}
              valueLabel={t('top_performers.goals_conceded')}
              lowerIsBetter={true}
              isLoading={isLoading}
            />
            <PlayerLeaderboard
              title={t('top_performers.mvp')}
              entries={leaderboards.rated.slice(0, 1)}
              valueLabel={t('top_performers.avg_rating')}
              isLoading={isLoading}
            />
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

Design notes:
- Shows only top 1 in each category (compact view)
- 2x2 grid for the 4 categories
- Link to full stats page
- Uses existing PlayerLeaderboard component (may need to handle single-entry case)
  </action>
  <verify>
    - `ls components/dashboard/top-performers-section.tsx` file exists
    - `grep "useTeamLeaderboards" components/dashboard/top-performers-section.tsx` shows hook usage
    - `grep "scorers.*assisters.*goalsConceded.*rated" components/dashboard/top-performers-section.tsx` shows 4 categories
  </verify>
  <done>
TopPerformersSection component displays top 1 in each of 4 categories (scorer, assister, GK, MVP) in a 2x2 grid with link to full stats.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add TopPerformersSection to team dashboard</name>
  <files>components/teams/team-dashboard.tsx</files>
  <action>
Integrate TopPerformersSection into the team dashboard, replacing or alongside the matches placeholder.

1. Import TopPerformersSection
2. Add it below the Quick Actions section
3. The component needs teamId and locale - get locale from useParams

Changes to make:
```typescript
import { TopPerformersSection } from '@/components/dashboard/top-performers-section'
import { useParams } from 'next/navigation'

// In component:
const params = useParams()
const locale = params.locale as string

// Add after Quick Actions section:
<TopPerformersSection teamId={team.id} locale={locale} />
```

Remove or modify the matches placeholder section as needed.
  </action>
  <verify>
    - `grep "TopPerformersSection" components/teams/team-dashboard.tsx` shows import and usage
    - Visual check: TopPerformersSection appears on team dashboard
  </verify>
  <done>
Team dashboard displays TopPerformersSection showing top 4 category leaders.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add TimePeriodFilter to stats page</name>
  <files>app/[locale]/teams/[teamId]/stats/stats-page-client.tsx</files>
  <action>
Integrate the TimePeriodFilter component into the stats page header.

1. Import TimePeriodFilter and getDateRangeForPeriod
2. Add state for selected period
3. Pass dateRange to useTeamLeaderboards hook

```typescript
import { useState, useMemo } from 'react'
import { TimePeriodFilter, getDateRangeForPeriod, type TimePeriod } from '@/components/dashboard/time-period-filter'

// In component:
const [period, setPeriod] = useState<TimePeriod>('all')

const dateRange = useMemo(() => {
  return getDateRangeForPeriod(period)
}, [period])

const { leaderboards, isLoading, error } = useTeamLeaderboards(teamId, dateRange)

// Add filter in header, next to title:
<div className="flex items-center justify-between mb-6">
  <div>
    <h1 className="text-2xl font-bold">{t('title')}</h1>
    {team && <p className="text-muted-foreground">{team.name}</p>}
  </div>
  <TimePeriodFilter value={period} onChange={setPeriod} />
</div>
```

The hook will automatically re-fetch when dateRange changes (already implemented in 07-01).
  </action>
  <verify>
    - `grep "TimePeriodFilter" app/[locale]/teams/[teamId]/stats/stats-page-client.tsx` shows import and usage
    - `grep "useTeamLeaderboards.*dateRange" app/[locale]/teams/[teamId]/stats/stats-page-client.tsx` shows date range passed
  </verify>
  <done>
Stats page has time period filter in header. Changing filter updates all 7 leaderboards.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add PlayerEvolutionChart to player profile</name>
  <files>app/[locale]/teams/[teamId]/players/[playerId]/player-profile-client.tsx</files>
  <action>
Integrate PlayerEvolutionChart into the player profile page, below the rating history section.

1. Import usePlayerEvolution hook and PlayerEvolutionChart component
2. Fetch evolution data
3. Add chart section after rating history

```typescript
import { usePlayerEvolution } from '@/hooks/use-player-evolution'
import { PlayerEvolutionChart } from '@/components/dashboard/player-evolution-chart'

// In component:
const { evolution, isLoading: evolutionLoading } = usePlayerEvolution(playerId, teamId)

// Add after Rating History section:
{/* Player Evolution Section */}
<h2 className="text-lg font-semibold mt-6 mb-3 flex items-center gap-2">
  <TrendingUp className="h-5 w-5" />
  {t('evolution.title')}
</h2>

{evolutionLoading && (
  <Card>
    <CardContent className="p-6">
      <div className="flex items-center justify-center">
        <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
      </div>
    </CardContent>
  </Card>
)}

{!evolutionLoading && evolution.length >= 2 && (
  <PlayerEvolutionChart 
    data={evolution} 
    title={t('evolution.chart_title')} 
  />
)}

{!evolutionLoading && evolution.length < 2 && (
  <Card className="border-dashed">
    <CardContent className="p-6 text-center">
      <p className="text-muted-foreground">{t('evolution.no_data')}</p>
    </CardContent>
  </Card>
)}
```

Note: The chart will show 2+ data points (returns null for fewer). Show empty state for < 2 matches.
  </action>
  <verify>
    - `grep "usePlayerEvolution" app/[locale]/teams/[teamId]/players/[playerId]/player-profile-client.tsx` shows hook usage
    - `grep "PlayerEvolutionChart" app/[locale]/teams/[teamId]/players/[playerId]/player-profile-client.tsx` shows component usage
  </verify>
  <done>
Player profile displays PlayerEvolutionChart with goals/assists/rating trends when 2+ matches exist.
  </done>
</task>

<task type="auto">
  <name>Task 5: Add translations for dashboard integration</name>
  <files>messages/it.json, messages/en.json</files>
  <action>
Add translation keys for new dashboard sections.

Under `dashboard.top_performers` namespace:
- `title`: "Migliori performer" / "Top Performers"
- `view_all`: "Vedi tutti" / "View all"
- `no_data`: "Completa la prima partita per vedere le classifiche" / "Complete first match to see leaderboards"
- `top_scorer`: "Capocannoniere" / "Top Scorer"
- `top_assister`: "Miglior assistman" / "Top Assister"
- `best_gk`: "Miglior portiere" / "Best Goalkeeper"
- `mvp`: "MVP" / "MVP"
- `goals`: "Gol" / "Goals"
- `assists`: "Assist" / "Assists"
- `goals_conceded`: "Gol subiti" / "Goals Conceded"
- `avg_rating`: "Media voto" / "Avg Rating"

Under `statistics.evolution` namespace:
- `title`: "Evoluzione" / "Evolution"
- `chart_title`: "Andamento prestazioni" / "Performance Trend"
- `no_data`: "Servono almeno 2 partite per il grafico" / "Need at least 2 matches for chart"
  </action>
  <verify>
    - `grep "top_performers" messages/it.json` shows all keys
    - `grep "top_performers" messages/en.json` shows all keys
    - `grep "evolution" messages/it.json` shows all keys
    - `grep "evolution" messages/en.json` shows all keys
  </verify>
  <done>
Both translation files contain dashboard.top_performers and statistics.evolution namespaces with all required keys.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify Phase 7 Dashboard Integration</name>
  <what-built>
Complete Phase 7 Dashboard & Leaderboards integration:
1. TopPerformersSection on team dashboard (top 4 category leaders)
2. TimePeriodFilter on stats page (all/season/last3months/month)
3. PlayerEvolutionChart on player profile (goals/assists/rating trends)
4. AttendanceStreakCard ready for integration (from 07-02)
  </what-built>
  <how-to-verify>
1. Navigate to a team page: `/[locale]/teams/[teamId]`
   - Verify "Top Performers" section appears with 4 category leaders
   - Click "View all" link → should go to stats page

2. Navigate to stats page: `/[locale]/teams/[teamId]/stats`
   - Verify time period filter appears in header
   - Change filter → all 7 leaderboards should update
   - Try all 4 options: All Time, This Season, Last 3 Months, This Month

3. Navigate to player profile: `/[locale]/teams/[teamId]/players/[playerId]`
   - Verify "Evolution" section appears after rating history
   - If player has 2+ completed matches, chart should show
   - Chart should have 3 colored lines: goals (red), assists (blue), rating (yellow)

4. Verify Italian/English translations work for all new text
  </how-to-verify>
  <resume-signal>Type "approved" if all features work correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- TopPerformersSection shows top 1 in each of 4 categories on team dashboard
- Stats page has functional time period filter that updates all leaderboards
- Player profile shows evolution chart with 3 metrics when 2+ matches exist
- All translations present in both languages
- Human verification confirms all features work correctly
</verification>

<success_criteria>
- DASH-01: Dashboard displays top scorer ✓
- DASH-02: Dashboard displays top assister ✓
- DASH-03: Dashboard displays best goalkeeper ✓
- DASH-04: Dashboard displays MVP ✓
- DASH-05: Player profile with detailed stats ✓ (already existed)
- DASH-06: Attendance streaks available ✓ (from 07-02)
- DASH-07: Time period filtering works ✓
- DASH-08: Player evolution charts display ✓
</success_criteria>

<output>
After completion, create `.planning/phases/07-dashboard-leaderboards/07-04-SUMMARY.md`
</output>
