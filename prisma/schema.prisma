generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum MatchStatus {
  SCHEDULED
  IN_PROGRESS
  FINISHED
  COMPLETED
  CANCELLED
}

// ============================================================================
// NEXTAUTH MODELS
// ============================================================================

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  emailVerified    DateTime?
  firstName        String    @map("first_name")
  lastName         String    @map("last_name")
  nickname         String?   @map("nickname")
  image            String?
  password         String?
  verificationToken String?  @map("verification_token")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  
  // App relations
  ownedTeams    Team[]         @relation("TeamOwner")
  memberships   TeamMember[]
  playerProfile Player?
  createdMatches Match[]       @relation("MatchCreator")
  createdInvites TeamInvite[]  @relation("InviteCreator")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================================
// APP MODELS
// ============================================================================

model Team {
  id          String    @id @default(cuid())
  name        String
  description String?
  imageUrl    String?   @map("image_url")
  createdBy   String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  syncStatus  String    @default("synced") @map("sync_status")

  creator     User          @relation("TeamOwner", fields: [createdBy], references: [id])
  members     TeamMember[]
  playerTeams PlayerTeam[]
  invites     TeamInvite[]
  matches     Match[]
  goals       Goal[]

  @@index([createdBy])
  @@index([deletedAt])
  @@map("teams")
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String   @map("team_id")
  userId   String?  @map("user_id")
  playerId String?  @map("player_id")
  role     String   @default("member")
  joinedAt DateTime @default(now()) @map("joined_at")

  team   Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  player Player? @relation(fields: [playerId], references: [id], onDelete: SetNull)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model Player {
  id         String   @id @default(cuid())
  name       String
  surname    String?
  nickname   String?
  avatarUrl  String?  @map("avatar_url")
  userId     String?  @unique @map("user_id")
  roles      String[]
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  syncStatus String   @default("synced") @map("sync_status")

  user        User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  memberships TeamMember[]
  playerTeams PlayerTeam[]
  matchPlayers MatchPlayer[]
  formationPositions FormationPosition[]
  scoredGoals  Goal[] @relation("GoalScorer")
  assistedGoals Goal[] @relation("GoalAssister")
  ratings     PlayerRating[]

  @@index([userId])
  @@map("players")
}

model PlayerTeam {
  id             String   @id @default(cuid())
  playerId       String   @map("player_id")
  teamId         String   @map("team_id")
  jerseyNumber   Int      @map("jersey_number")
  primaryRole    String   @map("primary_role")
  secondaryRoles String[] @default([]) @map("secondary_roles")
  joinedAt       DateTime @default(now()) @map("joined_at")
  createdAt      DateTime @default(now()) @map("created_at")
  syncStatus     String   @default("synced") @map("sync_status")

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([playerId, teamId])
  @@unique([teamId, jerseyNumber])
  @@index([playerId])
  @@index([teamId])
  @@map("player_teams")
}

model TeamInvite {
  id        String    @id @default(cuid())
  teamId    String    @map("team_id")
  createdBy String    @map("created_by")
  token     String    @unique
  email     String?
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  usedBy    String?   @map("used_by")
  maxUses   Int       @default(50) @map("max_uses")
  useCount  Int       @default(0) @map("use_count")
  createdAt DateTime  @default(now()) @map("created_at")

  team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator User @relation("InviteCreator", fields: [createdBy], references: [id])

  @@index([teamId])
  @@index([token])
  @@index([expiresAt])
  @@map("team_invites")
}

model Match {
  id          String      @id @default(cuid())
  teamId      String      @map("team_id")
  scheduledAt DateTime    @map("scheduled_at")
  location    String?
  mode        String
  status      MatchStatus @default(SCHEDULED)
  homeScore   Int?        @map("home_score")
  awayScore   Int?        @map("away_score")
  notes       String?
  createdBy   String?     @map("created_by")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  syncStatus  String      @default("synced") @map("sync_status")

  team     Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator  User?      @relation("MatchCreator", fields: [createdBy], references: [id])
  players  MatchPlayer[]
  formation Formation?
  goals    Goal[]
  ratings  PlayerRating[]

  @@index([teamId])
  @@index([scheduledAt])
  @@index([status])
  @@map("matches")
}

model MatchPlayer {
  id             String   @id @default(cuid())
  matchId        String   @map("match_id")
  playerId       String   @map("player_id")
  rsvpStatus     String   @default("maybe") @map("rsvp_status")
  rsvpAt         DateTime? @map("rsvp_at")
  positionOnPitch String? @map("position_on_pitch")
  played         Boolean  @default(false)
  syncStatus     String   @default("synced") @map("sync_status")

  match  Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([matchId, playerId])
  @@index([matchId])
  @@index([playerId])
  @@map("match_players")
}

model Formation {
  id             String   @id @default(cuid())
  matchId        String   @unique @map("match_id")
  teamFormation  Json?    @map("team_formation")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  match     Match               @relation(fields: [matchId], references: [id], onDelete: Cascade)
  positions FormationPosition[]

  @@index([matchId])
  @@map("formations")
}

model FormationPosition {
  id            String  @id @default(cuid())
  formationId   String  @map("formation_id")
  playerId      String? @map("player_id")
  positionX     Int     @map("position_x")
  positionY     Int     @map("position_y")
  positionLabel String  @map("position_label")
  isSubstitute  Boolean @default(false) @map("is_substitute")
  side          String? @map("side")  // 'home' | 'away' - set when match completes

  formation Formation @relation(fields: [formationId], references: [id], onDelete: Cascade)
  player    Player?   @relation(fields: [playerId], references: [id], onDelete: SetNull)

  @@unique([formationId, positionX, positionY])
  @@index([formationId])
  @@index([playerId])
  @@index([side])
  @@map("formation_positions")
}

model Goal {
  id         String   @id @default(cuid())
  matchId    String   @map("match_id")
  teamId     String   @map("team_id")
  scorerId   String   @map("scorer_id")
  assisterId String?  @map("assister_id")
  isOwnGoal  Boolean  @default(false) @map("is_own_goal")
  order      Int
  createdAt  DateTime @default(now()) @map("created_at")

  match    Match   @relation(fields: [matchId], references: [id], onDelete: Cascade)
  team     Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  scorer   Player  @relation("GoalScorer", fields: [scorerId], references: [id], onDelete: Cascade)
  assister Player? @relation("GoalAssister", fields: [assisterId], references: [id], onDelete: SetNull)

  @@unique([matchId, order])
  @@index([matchId])
  @@index([scorerId])
  @@map("goals")
}

model PlayerRating {
  id        String    @id @default(cuid())
  matchId   String    @map("match_id")
  playerId  String    @map("player_id")
  rating    Decimal   @db.Decimal(3, 2)
  comment   String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  match  Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([matchId, playerId])
  @@index([matchId])
  @@index([playerId])
  @@map("player_ratings")
}


